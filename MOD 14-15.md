# Important Information
- `accesschk "cda\leonard.blevins" -a *`
  - **keyword _Privilage_**
- `auditpol.exe /get /category:*`
  - **keyword _enforced audit policy_**
- `GPM`
  - **keyword _Name of GPO_**
  - 3 places: Linked Policy, Top of policy page, and in the setting tab. **DO NOT LOOK IN GPO FOLDER**
- `LSP`
  - **keyword _Local_**
- `RSOP.msc`
  - **keywork _RSOP_** 
# MOD 14
## Directory Services
### Understanding Active Directory Domain Services
- A directory is a hierarchical structure that stores information about objects on the network.
- A directory service, such as AD DS, provides the methods for storing directory data and making this data available to network users and administrators
- For example, AD DS stores information about user accounts including **names**, **passwords**, **phone numbers**, etc., and enables other authorized users on the same network to access this information.
- AD stores information about objects on the network and makes this information easy for administrators and users to find and use.
- AD uses a structured data store as the basis for a logical, hierarchical organization of directory information.
  - This data store, also known as the **directory**, contains information about AD objects.
  - These objects typically include shared resources such as **servers**, **volumes**, **printers**, and the **network user and computer accounts**.
- Security is integrated with AD through logon authentication and access control to objects in the directory
- Policy-based administration eases the management of even the most complex network.

- **_Key terms_** in AD DS include:
  - **Schema**: The set of user-configured rules that govern objects and attributes in AD DS.
  - **Global Catalog**: The container for all objects in AD DS.
    - For example, a name associated with a user or a computer is stored in the global catalog.
  - **Query and Index Mechanism**: This system allows users to find each other in AD.
    - A good example would be when typing a name in the mail client, and the mail client shows possible matches.
  - **Replication Service**: The replication service makes sure that every DC on the network has the same Global Catalog and Schema.
  - **Sites**: Sites are representations of the network topology, so AD DS knows which objects go together to optimize replication and indexing.
  - **Lightweight Directory Access Protocol (LDAP)**: LDAP is an industry-standard application protocol that allows AD to communicate with other LDAP-enabled directory services across platforms.
    - Example of its use includes creating a centralized management of AD users for validating access to various applications and services.

- **_Services_** provided in AD DS include:
  - **Domain Services**: The collection of software and processes that store information about the enterprise, including users and computers.
  - **Certificate Services**: Allows the domain controller to serve and authenticate **digital certificates**, **signatures**, and **public key cryptography**.
  - **Lightweight Directory Services**: The foundation that supports LDAP. LDAP is a vendor-agnostic, industry-standard, protocol used to access and maintain directory information services distributed over an IP network.
    - A common use of LDAP is to provide a central place to store usernames and passwords.
  - **Directory Federation Services**: Provides Single Sign-On (SSO) authentication for multiple applications in the same session.
    - SSO allows users to only use one set of credentials to log on to multiple applications.
  - **Rights Management**: The rules and configurations that control information rights and data access policies.
    - The configurations defined using this service will determine which users can access which files, folders, and/or applications. 

- Post-initial-access-related TTPs span every category of threat techniques within the MITRE ATT&CK Framework.
  - This means a threat could potentially abuse Windows AD to achieve **Initial Access**, **Execution**, **Persistence**, **Privilege Escalation**, **Defense Evasion**, **Credential Access**, **Discovery**, **Lateral Movements**, **Collection**, **Exfiltration**, and **Impact**.
- Often, modification is required for servers and workstations to log the necessary information to aid in the investigation of potential MCA.
  - Investigations require input from multiple teams and individuals to deconflict user actions performed in an attempt to validate if the activity is truly malicious.
- Microsoft AD DS configurations are implemented within the Department of Defense (DoD) in accordance with the National Institute of Standards and Technology (NIST) Security Technical Implementation Guides (STIG).
  - STIGs are configuration standards detailing cyber security requirements for a specific product.
  - They are a good resource when evaluating the security posture of a supported system.

<img width="965" height="623" alt="bc5520c5-0d52-4733-98a1-6e6d113867ac" src="https://github.com/user-attachments/assets/c86b4b6a-bff7-418d-8b5a-b24f9e772229" />

- Leveraging Windows AD is very common in most post-exploitation activities where a threat requires a mechanism for **privilege escalation**, **lateral movement**, or **information exfiltration**.
- Also note that the logs required to perform an investigation, may not be configured or accessible in a default environment.

### Server Manager
- Areas of Interest:
  - **Properties**: Provides an overview of the local server's current configuration and settings.
  - **Events**: Provides an overview of the local server's Windows events by Identifier (ID).
    - NOTE: These events can be useful when investigating potential MCA.
  - **Services**: Provides an overview of the services running on the local server.
    - NOTE: This information can be useful in determining the potential attack surface of the server.
  - **Roles and Features**: Provides an overview of the types and paths of various roles and features of the server.
    - This provides a good overview of what the server's role and capability is within the domain.

### Decument AD DS Using PowerShell
- Get a list of the services: `get-service`
- Get a specific service using the following switches: `[-Name <String>] [-DependentServices] [-RequiredServices] [-DisplayName]`
- filter for a service providing configs of IP addresses on a device: `Get-Service -computername cda-exec-1 -name Dhcp`
- Identify only running services: `Get-Service | Where-Object {$_.status -eq "Running"}`

### Reviewing and Implementing Group Polcies
- As defined by Microsoft, a **GPO** is a collection of Group Policy settings that define what a system looks like and how it behaves for a defined group of users
- Every GPO has two parts: **a user configuration** and **a computer configuration**.
- Computer-related policies specify **system behavior**, **application settings**, **security settings**, **assigned applications**, and **computer startup and shutdown scripts**.
- User-related policies specify **system behavior**, **application settings**, **security settings**, **assigned and published applications**, **user logon and logoff scripts**, and **folder redirection**.
- Be aware that **_computer-related settings override user-related settings_**
- A GPO can represent policy settings in the file system and in the AD.
  - GPO settings are evaluated by clients using the hierarchical nature of AD.
- Objects can span the entire enterprise made up of **Organizational Units (OU)**, **domains**, **trees**, and **forests**.
  - **OUs** can be linked directly to GPOs making enterprise management simpler.
  - An **OU** is the **lowest unit that GPOs can be applied to** and is a **subdivision within an AD** that can hold **users**, **groups**, and **computers**.
  - The **OU goals** are to **visually organize objects**, **group objects so Group Policies can be assigned to them**, and** group objects so permissions can be delegated to them** so they can be **managed by a subset of administrators**.
- Relationships between the domains and forests allow for further distribution of GPOs across the enterprise.

<img width="470" height="315" alt="8321b750-1569-4343-a8c2-f55bc1d94b6e" src="https://github.com/user-attachments/assets/2f5cfc98-dabb-4353-8b70-2980b2e17988" />

- To create GPOs, an administrator can use the GPO Editor as an extension to an AD container, and define Group Policy based on the selected Scope of Management (SOM).
- **DO NOT LOOK IN GPO FOLDER FOR NAMES OF GPOS**
- The extension to the container requires a snap-in.
  - A snap-in is a software module for the Microsoft Management Console (MMC) that provides administrative capabilities for a particular type of device.
  - Snap-ins are available in two types:
    - Stand-alone:
      - A stand-alone snap-in, when loaded in a console, performs its designated management task as the only snap-in loaded in the console.
    - Extension:
      - An extension snap-in adds functionality to a stand-alone snap-in.
      - Extension snap-ins add their own nodes as children of the stand-alone snap-in's node.
      - They can also add **contextual menu items**, **toolbar buttons**, **property pages**, and **taskpad tasks** to the stand-alone snap-in's node.
      - Examples of AD-related snap-ins include the **Remote Server Administration Tools (RSAT)**, **Active Directory Users and Computers (ADUC)** and the **Active Directory Sites and Services**.
      - Security policy settings are rules that administrators configure on a computer or multiple devices for the purpose of protecting resources on a device or network.
        - As part of a security strategy, you can create GPOs with security settings policies configured specifically for the various roles in your organization, such as DCs, file servers, member servers, and clients.
        - Security settings control:
          - Domain user authentication
          - Resources users are permitted to access
          - Recording user or group actions in the event log
          - Membership within a group
      - Using GPOs allows administrators to implement and enforce security settings throughout an enterprise-level domain.
      - The following detail where GPOs could be used to apply security settings as mitigations within Windows AD to mitigate attacks and reduce the overall attack surface.

#### Disable Storage of LAN Manager Hash
- Windows stores user account passwords by hashing them — a hash is the result of a one-way algorithm that transforms the original plaintext password into a secure string.
- Theoretically, this hash cannot be reversed to retrieve the original password.
- Unfortunately, not all hashing algorithms are created equal. Older versions of the Windows OS used authentication protocols such as LAN Manager (LANMAN or LM) or New Technology LAN Manager (NTLM), which include hashing algorithms that were not developed with modern computing power in mind.
- These hashing algorithms are now considered weak or insecure, and are easily cracked by attackers.
- These hashing algorithms are still present in Windows for backwards compatibility reasons, but Windows should be prevented from storing an LM or NTLM hash of a password when possible.

#### Limit Access to Command Prompt
- Command prompts can be used to run commands that give high-level access to users and evade other restrictions of the local system.
- To limit access and ensure system resource security, it is wise to disable command prompt access for most users.
- This provides the user with a display message stating that some settings are preventing the action they are trying to perform. 

#### Disable Removable Media
- Removable media poses a real risk spanning multiple phases of the cyber attack lifecycle.
- Removable media — Universal Serial Bus (USB) drives, Compact Discs (CD), and Digital Versatile Discs (DVD) — can be weaponized in a number of different ways.
- If a user infects a domain-joined computer, it could quickly spread throughout the entire domain.
- It is best practice to disable removable media completely, but if that is not feasible, strictly control access to its use.
- Replication through removable media has long been an attack vector of choice for nation state actors. 

<img width="1931" height="3357" alt="48c36b88-94ed-4a66-abaf-7ac4381fb6c1" src="https://github.com/user-attachments/assets/305a656e-1b9d-4204-9534-e078a440c3ba" />

#### Restrict Installation of Software
- When users are given the ability to install software, they may unintentionally (or intentionally) install malware or software that creates unintended effects.
- In each case, this activity could lead to a breach. Supply chain attacks have been on the rise with attacks stemming from the software supply chain or a compromise through software dependencies or supply chain.
- It is advisable to prevent software installation by unprivileged users regardless of the source of the software.
- In most situations, administrators are the only personnel given access to install software.
- The control of installation privileges is implemented in an effort to block such breaches and compromises.
- Any new software to be introduced should be thoroughly tested before being implemented in a production environment.

#### Raise Minimum Password Length
- GPOs can also be used to set the minimum password length, enforce password history, set maximum age, and create complexity requirements.
- For example, passwords for non-privileged users could be set to at least 14 characters and enforce a maximum age of 30 days.
- Enforcing these rules through GPOs ensures standards are met across the entire enterprise.

#### Control and Monitor Group Policy Changes
- To ensure the security of Group Policy settings, access should be restricted and monitored for unwanted changes.
- This access should be controlled by allowing access only to users who are required to manage GPOs within the enterprise.
- Proper monitoring requires continuous auditing of GPOs by utilizing a specific configuration of event logging.
- Any changes to GPOs should be thoroughly vetted and documented using established change management procedures.

### Reviewing and Creating Group Policies
- **NOT DEFINED IS A POLICY SETTING**
#### Creating a new GPO
1. Select the GPO folder, and right -click on the right pane, select **New**
2. Name the GPO and click okay
3. Open the new policy and open up the settings tab
4. Right-click the **Computer Configuration** and edit
5. Navigate to: **Computer Configurations > Policies > Windows Settings > Security Settings > Local Policies > Security Options** and find the **Network Security: LAN MAnager auth level**
6. Open this up, select the _Define this policy setting checkbox_ and apply the **Send NTLMv2 response only**

#### Linking New GPO
1. Right-click _cda.corp_, and select **Link an Existing GPO**
2. Select the policy you want to link and click okay

#### Update the Group Policy
1. Open up powershell as Admin
2. Run the command `Invoke-GPUpdate -Force`
3. Run `Get-GPO -Name NTLMv2` to confirm

#### Checking Resultant set of Policies
1. Open RSOP via `rsop.msc`
2. Navigate to the GPO and open the setting to make sure it is accurate
3. Go to the _Precedence_ tab. Ensure that the GPO Governing it matches what it should
4. Run `auditpol.exe /get /category:*` to view state of advanced auditing

### Auditing Removeable Media
1. Open **Group Policy Management** (can be opened via WIN+R and typing **gpmc.msc**
2. Navigate to **Forest:cda.corp > Domains > cda.corp > Domain Controllers > Default Domain Controllers Policy**
3. Right-Click **Default Domain Controller Policy** and edit
4. Navigate to **Computer Configuration > Policies > Windows Settings > Security Settings > Advanced Audit Policy Configuration > Audit Policies**
5. Open **Object Access**
6. Open **Audit Removable Storage**
7. Select **Configure the following audit events:, Success and Failure** hit apply and ok
8. Open **Audit Handle Manipulation**
9. Open CMD and run `gpupdate /force` to update the policy

### Disable Access to Removable Storage Devices
1. Within GPM, navigate to **Computer Configuration > Policies > Administrative Templates: Policy definitions (ADMX files) retrieved from the local computer > System > Removable Storage Access.**
2. Click on the setting you want, and click: **Enable**, apply, ok
3. Run `gpupdate /force`

### Auditing AD Changes
- Within the Group Policy Management Editor, security settings can be defined and enabled.
- The security audit policy settings under Advanced Audit Policy Configuration allows an organization to audit compliance with important security-related rules by tracking precisely defined activities including:
  - Administrator has added other users to an administrative group
  - Administrator disabled a security policy enabling a legacy protocol
  - Correct System Access Control list (SACL) is applied to critical files and folders or registry keys on a computer or file share as a verifiable safeguard against undetected access.
- Audit policy settings can be accessed through the Local Security Policy snap-in on the local computer or by using Group Policy Manager.
- Listed are the audit policy categories found within the Advanced Audit Policy Configuration menu:
  - **Account Logon**: Policy settings to help document attempts to authenticate account data on a DC or on a local Security Accounts Manager (SAM). Unlike Logon and Logoff policy settings and events, which track attempts to access a particular computer, settings and events in this category focus on the account database that is used.
  - **Account Management**: Security audit policy settings used to monitor changes to user and computer accounts and groups.Object Access: Policy settings and audit events to track attempted access to specific objects or types of objects on a network or computer. To audit attempted access to a file, directory, registry key, or any other object, enable the appropriate Object Access auditing subcategory for success and/or failure events.
  - **Policy Change**: Audit events to track changes to important security policies on a local system or network. Because policies are typically established by administrators to help secure network resources, monitoring changes or attempts to change these policies can be an important aspect of security management for a network.
  - **Privilege Use**: Security policy settings and audit events to track the use of certain permissions on one or more systems. Permissions on a network are granted for users or computers to complete defined tasks.
  - **System**: Security policy settings and audit events to track system-level changes to a computer that are not included in other categories and have potential security implications.
  - **Global Object Access Auditing**: Policy settings allowing administrators to define computer SACLs per object type for the file system or the registry. The specified SACL is automatically applied to every object of that type. Auditors can prove that every resource in the system is protected under an audit policy by viewing the contents of the Global Object Access Auditing.
  - **DS Access**

### Configuring Domain Audit Policies
1. Open GPM, navigate to **Forest: cda.corp > Domains > cda.corp > Domain Controllers.**
2. Right-click on **Default Domain Controllers Policy**
3. Navigate to **Computer Configuration > Policies > Windows Settings > Security Settings > Advanced Audit Policy Configuration > Audit Policies > DS Access.**
4. Update the policies to reflect **Success, Failure** and run `gpupdate /force`
5. run `auditpol /get /category:*` to confirm it is correct
