# Important Information
- `accesschk "cda\leonard.blevins" -a *`
  - **keyword _Privilage_**
- `auditpol.exe /get /category:*`
  - **keyword _enforced audit policy_**
- `GPM`
  - **keyword _Name of GPO_**
  - 3 places: Linked Policy, Top of policy page, and in the setting tab. **DO NOT LOOK IN GPO FOLDER**
- `LSP`
  - Look in the **Local Security Policy** Tool
  - **keyword _Local_**
- `RSOP.msc`
  - **keywork _RSOP_** 
# MOD 14
## Directory Services
### Understanding Active Directory Domain Services
- A directory is a hierarchical structure that stores information about objects on the network.
- A directory service, such as AD DS, provides the methods for storing directory data and making this data available to network users and administrators
- For example, AD DS stores information about user accounts including **names**, **passwords**, **phone numbers**, etc., and enables other authorized users on the same network to access this information.
- AD stores information about objects on the network and makes this information easy for administrators and users to find and use.
- AD uses a structured data store as the basis for a logical, hierarchical organization of directory information.
  - This data store, also known as the **directory**, contains information about AD objects.
  - These objects typically include shared resources such as **servers**, **volumes**, **printers**, and the **network user and computer accounts**.
- Security is integrated with AD through logon authentication and access control to objects in the directory
- Policy-based administration eases the management of even the most complex network.

- **_Key terms_** in AD DS include:
  - **Schema**: The set of user-configured rules that govern objects and attributes in AD DS.
  - **Global Catalog**: The container for all objects in AD DS.
    - For example, a name associated with a user or a computer is stored in the global catalog.
  - **Query and Index Mechanism**: This system allows users to find each other in AD.
    - A good example would be when typing a name in the mail client, and the mail client shows possible matches.
  - **Replication Service**: The replication service makes sure that every DC on the network has the same Global Catalog and Schema.
  - **Sites**: Sites are representations of the network topology, so AD DS knows which objects go together to optimize replication and indexing.
  - **Lightweight Directory Access Protocol (LDAP)**: LDAP is an industry-standard application protocol that allows AD to communicate with other LDAP-enabled directory services across platforms.
    - Example of its use includes creating a centralized management of AD users for validating access to various applications and services.

- **_Services_** provided in AD DS include:
  - **Domain Services**: The collection of software and processes that store information about the enterprise, including users and computers.
  - **Certificate Services**: Allows the domain controller to serve and authenticate **digital certificates**, **signatures**, and **public key cryptography**.
  - **Lightweight Directory Services**: The foundation that supports LDAP. LDAP is a vendor-agnostic, industry-standard, protocol used to access and maintain directory information services distributed over an IP network.
    - A common use of LDAP is to provide a central place to store usernames and passwords.
  - **Directory Federation Services**: Provides Single Sign-On (SSO) authentication for multiple applications in the same session.
    - SSO allows users to only use one set of credentials to log on to multiple applications.
  - **Rights Management**: The rules and configurations that control information rights and data access policies.
    - The configurations defined using this service will determine which users can access which files, folders, and/or applications. 

- Post-initial-access-related TTPs span every category of threat techniques within the MITRE ATT&CK Framework.
  - This means a threat could potentially abuse Windows AD to achieve **Initial Access**, **Execution**, **Persistence**, **Privilege Escalation**, **Defense Evasion**, **Credential Access**, **Discovery**, **Lateral Movements**, **Collection**, **Exfiltration**, and **Impact**.
- Often, modification is required for servers and workstations to log the necessary information to aid in the investigation of potential MCA.
  - Investigations require input from multiple teams and individuals to deconflict user actions performed in an attempt to validate if the activity is truly malicious.
- Microsoft AD DS configurations are implemented within the Department of Defense (DoD) in accordance with the National Institute of Standards and Technology (NIST) Security Technical Implementation Guides (STIG).
  - STIGs are configuration standards detailing cyber security requirements for a specific product.
  - They are a good resource when evaluating the security posture of a supported system.

<img width="965" height="623" alt="bc5520c5-0d52-4733-98a1-6e6d113867ac" src="https://github.com/user-attachments/assets/c86b4b6a-bff7-418d-8b5a-b24f9e772229" />

- Leveraging Windows AD is very common in most post-exploitation activities where a threat requires a mechanism for **privilege escalation**, **lateral movement**, or **information exfiltration**.
- Also note that the logs required to perform an investigation, may not be configured or accessible in a default environment.

### Server Manager
- Areas of Interest:
  - **Properties**: Provides an overview of the local server's current configuration and settings.
  - **Events**: Provides an overview of the local server's Windows events by Identifier (ID).
    - NOTE: These events can be useful when investigating potential MCA.
  - **Services**: Provides an overview of the services running on the local server.
    - NOTE: This information can be useful in determining the potential attack surface of the server.
  - **Roles and Features**: Provides an overview of the types and paths of various roles and features of the server.
    - This provides a good overview of what the server's role and capability is within the domain.

### Decument AD DS Using PowerShell
- Get a list of the services: `get-service`
- Get a specific service using the following switches: `[-Name <String>] [-DependentServices] [-RequiredServices] [-DisplayName]`
- filter for a service providing configs of IP addresses on a device: `Get-Service -computername cda-exec-1 -name Dhcp`
- Identify only running services: `Get-Service | Where-Object {$_.status -eq "Running"}`

### Reviewing and Implementing Group Polcies
- As defined by Microsoft, a **GPO** is a collection of Group Policy settings that define what a system looks like and how it behaves for a defined group of users
- Every GPO has two parts: **a user configuration** and **a computer configuration**.
- Computer-related policies specify **system behavior**, **application settings**, **security settings**, **assigned applications**, and **computer startup and shutdown scripts**.
- User-related policies specify **system behavior**, **application settings**, **security settings**, **assigned and published applications**, **user logon and logoff scripts**, and **folder redirection**.
- Be aware that **_computer-related settings override user-related settings_**
- A GPO can represent policy settings in the file system and in the AD.
  - GPO settings are evaluated by clients using the hierarchical nature of AD.
- Objects can span the entire enterprise made up of **Organizational Units (OU)**, **domains**, **trees**, and **forests**.
  - **OUs** can be linked directly to GPOs making enterprise management simpler.
  - An **OU** is the **lowest unit that GPOs can be applied to** and is a **subdivision within an AD** that can hold **users**, **groups**, and **computers**.
  - The **OU goals** are to **visually organize objects**, **group objects so Group Policies can be assigned to them**, and** group objects so permissions can be delegated to them** so they can be **managed by a subset of administrators**.
- Relationships between the domains and forests allow for further distribution of GPOs across the enterprise.

<img width="470" height="315" alt="8321b750-1569-4343-a8c2-f55bc1d94b6e" src="https://github.com/user-attachments/assets/2f5cfc98-dabb-4353-8b70-2980b2e17988" />

- To create GPOs, an administrator can use the GPO Editor as an extension to an AD container, and define Group Policy based on the selected Scope of Management (SOM).
- **DO NOT LOOK IN GPO FOLDER FOR NAMES OF GPOS**
- The extension to the container requires a snap-in.
  - A snap-in is a software module for the Microsoft Management Console (MMC) that provides administrative capabilities for a particular type of device.
  - Snap-ins are available in two types:
    - Stand-alone:
      - A stand-alone snap-in, when loaded in a console, performs its designated management task as the only snap-in loaded in the console.
    - Extension:
      - An extension snap-in adds functionality to a stand-alone snap-in.
      - Extension snap-ins add their own nodes as children of the stand-alone snap-in's node.
      - They can also add **contextual menu items**, **toolbar buttons**, **property pages**, and **taskpad tasks** to the stand-alone snap-in's node.
      - Examples of AD-related snap-ins include the **Remote Server Administration Tools (RSAT)**, **Active Directory Users and Computers (ADUC)** and the **Active Directory Sites and Services**.
      - Security policy settings are rules that administrators configure on a computer or multiple devices for the purpose of protecting resources on a device or network.
        - As part of a security strategy, you can create GPOs with security settings policies configured specifically for the various roles in your organization, such as DCs, file servers, member servers, and clients.
        - Security settings control:
          - Domain user authentication
          - Resources users are permitted to access
          - Recording user or group actions in the event log
          - Membership within a group
      - Using GPOs allows administrators to implement and enforce security settings throughout an enterprise-level domain.
      - The following detail where GPOs could be used to apply security settings as mitigations within Windows AD to mitigate attacks and reduce the overall attack surface.

#### Disable Storage of LAN Manager Hash
- Windows stores user account passwords by hashing them — a hash is the result of a one-way algorithm that transforms the original plaintext password into a secure string.
- Theoretically, this hash cannot be reversed to retrieve the original password.
- Unfortunately, not all hashing algorithms are created equal. Older versions of the Windows OS used authentication protocols such as LAN Manager (LANMAN or LM) or New Technology LAN Manager (NTLM), which include hashing algorithms that were not developed with modern computing power in mind.
- These hashing algorithms are now considered weak or insecure, and are easily cracked by attackers.
- These hashing algorithms are still present in Windows for backwards compatibility reasons, but Windows should be prevented from storing an LM or NTLM hash of a password when possible.

#### Limit Access to Command Prompt
- Command prompts can be used to run commands that give high-level access to users and evade other restrictions of the local system.
- To limit access and ensure system resource security, it is wise to disable command prompt access for most users.
- This provides the user with a display message stating that some settings are preventing the action they are trying to perform. 

#### Disable Removable Media
- Removable media poses a real risk spanning multiple phases of the cyber attack lifecycle.
- Removable media — Universal Serial Bus (USB) drives, Compact Discs (CD), and Digital Versatile Discs (DVD) — can be weaponized in a number of different ways.
- If a user infects a domain-joined computer, it could quickly spread throughout the entire domain.
- It is best practice to disable removable media completely, but if that is not feasible, strictly control access to its use.
- Replication through removable media has long been an attack vector of choice for nation state actors. 

<img width="1931" height="3357" alt="48c36b88-94ed-4a66-abaf-7ac4381fb6c1" src="https://github.com/user-attachments/assets/305a656e-1b9d-4204-9534-e078a440c3ba" />

#### Restrict Installation of Software
- When users are given the ability to install software, they may unintentionally (or intentionally) install malware or software that creates unintended effects.
- In each case, this activity could lead to a breach. Supply chain attacks have been on the rise with attacks stemming from the software supply chain or a compromise through software dependencies or supply chain.
- It is advisable to prevent software installation by unprivileged users regardless of the source of the software.
- In most situations, administrators are the only personnel given access to install software.
- The control of installation privileges is implemented in an effort to block such breaches and compromises.
- Any new software to be introduced should be thoroughly tested before being implemented in a production environment.

#### Raise Minimum Password Length
- GPOs can also be used to set the minimum password length, enforce password history, set maximum age, and create complexity requirements.
- For example, passwords for non-privileged users could be set to at least 14 characters and enforce a maximum age of 30 days.
- Enforcing these rules through GPOs ensures standards are met across the entire enterprise.

#### Control and Monitor Group Policy Changes
- To ensure the security of Group Policy settings, access should be restricted and monitored for unwanted changes.
- This access should be controlled by allowing access only to users who are required to manage GPOs within the enterprise.
- Proper monitoring requires continuous auditing of GPOs by utilizing a specific configuration of event logging.
- Any changes to GPOs should be thoroughly vetted and documented using established change management procedures.

### Reviewing and Creating Group Policies
- **NOT DEFINED IS A POLICY SETTING**
#### Creating a new GPO
1. Select the GPO folder, and right -click on the right pane, select **New**
2. Name the GPO and click okay
3. Open the new policy and open up the settings tab
4. Right-click the **Computer Configuration** and edit
5. Navigate to: **Computer Configurations > Policies > Windows Settings > Security Settings > Local Policies > Security Options** and find the **Network Security: LAN MAnager auth level**
6. Open this up, select the _Define this policy setting checkbox_ and apply the **Send NTLMv2 response only**

#### Linking New GPO
1. Right-click _cda.corp_, and select **Link an Existing GPO**
2. Select the policy you want to link and click okay

#### Update the Group Policy
1. Open up powershell as Admin
2. Run the command `Invoke-GPUpdate -Force`
3. Run `Get-GPO -Name NTLMv2` to confirm

#### Checking Resultant set of Policies
1. Open RSOP via `rsop.msc`
2. Navigate to the GPO and open the setting to make sure it is accurate
3. Go to the _Precedence_ tab. Ensure that the GPO Governing it matches what it should
4. Run `auditpol.exe /get /category:*` to view state of advanced auditing

### Auditing Removeable Media
1. Open **Group Policy Management** (can be opened via WIN+R and typing **gpmc.msc**
2. Navigate to **Forest:cda.corp > Domains > cda.corp > Domain Controllers > Default Domain Controllers Policy**
3. Right-Click **Default Domain Controller Policy** and edit
4. Navigate to **Computer Configuration > Policies > Windows Settings > Security Settings > Advanced Audit Policy Configuration > Audit Policies**
5. Open **Object Access**
6. Open **Audit Removable Storage**
7. Select **Configure the following audit events:, Success and Failure** hit apply and ok
8. Open **Audit Handle Manipulation**
9. Open CMD and run `gpupdate /force` to update the policy

### Disable Access to Removable Storage Devices
1. Within GPM, navigate to **Computer Configuration > Policies > Administrative Templates: Policy definitions (ADMX files) retrieved from the local computer > System > Removable Storage Access.**
2. Click on the setting you want, and click: **Enable**, apply, ok
3. Run `gpupdate /force`

### Auditing AD Changes
- Within the Group Policy Management Editor, security settings can be defined and enabled.
- The security audit policy settings under Advanced Audit Policy Configuration allows an organization to audit compliance with important security-related rules by tracking precisely defined activities including:
  - Administrator has added other users to an administrative group
  - Administrator disabled a security policy enabling a legacy protocol
  - Correct System Access Control list (SACL) is applied to critical files and folders or registry keys on a computer or file share as a verifiable safeguard against undetected access.
- Audit policy settings can be accessed through the Local Security Policy snap-in on the local computer or by using Group Policy Manager.
- Listed are the audit policy categories found within the Advanced Audit Policy Configuration menu:
  - **Account Logon**: Policy settings to help document attempts to authenticate account data on a DC or on a local Security Accounts Manager (SAM). Unlike Logon and Logoff policy settings and events, which track attempts to access a particular computer, settings and events in this category focus on the account database that is used.
  - **Account Management**: Security audit policy settings used to monitor changes to user and computer accounts and groups.Object Access: Policy settings and audit events to track attempted access to specific objects or types of objects on a network or computer. To audit attempted access to a file, directory, registry key, or any other object, enable the appropriate Object Access auditing subcategory for success and/or failure events.
  - **Policy Change**: Audit events to track changes to important security policies on a local system or network. Because policies are typically established by administrators to help secure network resources, monitoring changes or attempts to change these policies can be an important aspect of security management for a network.
  - **Privilege Use**: Security policy settings and audit events to track the use of certain permissions on one or more systems. Permissions on a network are granted for users or computers to complete defined tasks.
  - **System**: Security policy settings and audit events to track system-level changes to a computer that are not included in other categories and have potential security implications.
  - **Global Object Access Auditing**: Policy settings allowing administrators to define computer SACLs per object type for the file system or the registry. The specified SACL is automatically applied to every object of that type. Auditors can prove that every resource in the system is protected under an audit policy by viewing the contents of the Global Object Access Auditing.
  - **DS Access**

### Configuring Domain Audit Policies
1. Open GPM, navigate to **Forest: cda.corp > Domains > cda.corp > Domain Controllers.**
2. Right-click on **Default Domain Controllers Policy**
3. Navigate to **Computer Configuration > Policies > Windows Settings > Security Settings > Advanced Audit Policy Configuration > Audit Policies > DS Access.**
4. Update the policies to reflect **Success, Failure** and run `gpupdate /force`
5. run `auditpol /get /category:*` to confirm it is correct

### Identifying Malicious GP Changes
<img width="965" height="456" alt="60c04dd9-7fb5-43fe-9fa8-c2bdd63a33e6" src="https://github.com/user-attachments/assets/56d9cd0b-ea66-4aa8-942b-0ef1ee3ee2b3" />

- Run `auditpol /set /subcategory:{0CCE923C-69AE-11D9-BED3-505054503030} /success:enable` to ensure Directory Services is being logged
  - The command uses the the **auditpol.exe** CLI, which configures and manages audit policy settings.
  - The **/set** portion of the command is used to set the audit policy settings.
  - The **/subcategory** portion of the command is used to define the subcategory of the audit policy.
  - For the command above, the subcategory — **0CCE923C-69AE-11D9-BED3-505054503030** — is the code for the Directory Service Changes audit policy.
  - The last portion of the command — **/success:enable** — ensures any successful directory service changes are audited and logged. 

### Compromised Account on the Domain
1. Open up Kibana, and filter based on the Timeframe and device you need (observer.name.keyword: ***)
2. Once you determine the timeframe and event code of the attack, filter down accordingly (event.code: 5136)
3. FIlter down on the username of the compromised account using visualization and the user.name terminology
4. Filter down on winlog.event_data.ObjectDN.keyword to see what accounts were affected
5. Start looking for events of deletion via (event.code: 5141)


## Domain Services
### Understanding LDAP
- LDAP is traditionally used in medium-to-large organi­zations.
- LDAP supplies the syntax that services and applications use to connect and communicate with directory services servers.
- Directory services store information regarding users' profiles such as passwords and computer accounts.
- Directory services share the information collected with organizations on the network.
- LDAP servers exist at two levels: **large public servers** (universities and libraries) and **smaller LDAP servers for workgroups**.
- A domain administrator may use an LDAP server to look up contact information.
- While every email program has a personal address book, the questions remain:
  - How do you locate an individual’s email address if they have never sent you an email?
  - How do organizations keep a current contact list that everyone can access?
- These questions led several big-name companies to support a standard called LDAP.
- LDAP-aware client programs ask LDAP servers to index all the entry data.
- Filters can be applied to particular people or groups, the filter will only return with applicable data.
- LDAP contains and handles more than contact information about people or groups, it is also used to **query encryption certificates**, **connections to printers**, and **provide single sign-on (SSO) services**.
  - SSO is a structure where one user’s password is shared between many services.
  - Security for SSO is critical for DCO, as compromised credentials could grant the adversary access to multiple systems on the network.
- LDAP works with all directory-like information, where rapid requests and less-frequent updates are expected.
- LDAP does not define how programs work or interact with each other.
- LDAP’s primary purpose is to define the language employed by client programs (e.g., email provider, a printer hub, a contact book, etc.) to talk to servers — and servers to servers, too.
- The server may or may not communicate via LDAP, there are numerous other method of communication; LDAP may be an add-on method.
- LDAP also defines:
  -**Permissions**: These are set by an administrator to allow certain people to access the LDAP database and keep certain data private.
  - **Schema**: Describes the format and attributes of data on the server. A schema entered in an LDAP server might define a **groovyPerson** entry type, which has attributes of **directMessageAddress** and **waterFlavorPreference**.
    - The standard attributes of name, email address, etc., are inherited from one of the standard schemas, which are rooted in **X.500**. 

<img width="1202" height="629" alt="download" src="https://github.com/user-attachments/assets/3b0b5b54-7406-4a58-9ad8-84dab89bdcdd" />

### Determine state of LDAP and Establish a connection from Client
- AD LDS is where you confirm current status
1. Right-click Windows logo
2. Select **Programs and Features**
3. Select **Turn Windows features on or off**
4. Verify all options under _Remote Server Admin Tools_ are checked
5. In the Ask me anything box, enter LDP
6. Select **Connection > Connect**
7. Verify IP address is correct
8. Look for _established connection to <IP>_

### LDAP Settings
#### LDAP Binding
- Bind operations serve multiple purposes including:
  - Providing directory server authentication for clients; includes the users or applications behind the clients.
  - Establishing an authorization identity for subsequent operations processed via the connection.
  - Specifying the client’s LDAP protocol version.
- Authentication typically consists of two parts: **identifying the need for authentication**, and **providing proof of identity** — a **password**, a **certificate**, a **hardware/software token**, and/or **biometric information**.
- There may be additional steps (e.g., checking password policy state or other constraints) that must be completed prior to successfully binding.
- LDAP bind requests use either **simple** or **Simple Authentication and Security Layer (SASL)** authentication.
  - In simple authentication, the authenticated account is identified by the entry’s Distinguished Name (DN) for the account, and a password is used as the identity proof.
  - Since the password is not obfuscated when transmitted, the use of an encrypted connection (e.g., secured by Secure Sockets Layer [SSL]/Transport Layer Security [TLS] or StartTLS) is strongly recommended.
  - Providing an empty string as the bind DN and password works for an anonymous simple bind.
  - While the Lightweight Directory Access Protocol version 3 (LDAPv3) specification states only the password needs to be empty, this has led to multiple security issues. Given this, most servers request an empty DN if using the empty password.
- An LDAP bind request is comprised of three elements:
  - **The client’s desired LDAP protocol version**.
    - Version 3 is the most current, however, older clients may use version 2. Any newly created application should be developed for version 3.
  - **The user’s DN for authentication**.
    - Leave this empty for anonymous simple authentication; it is usually empty for SASL authentication, too. For non-anonymous simple authentication, it must be populated.
  - **The user’s credentials for authentication**.
    - The password for the user specified by the bind DN is required for simple authentication; this may be empty for anonymous binds.
    - SASL authentication expects an encoded value containing the SASL mechanism name and a set of encoded SASL credentials (optional).

### Discover Clients not Using the Require Signing Option
- Microsoft describes the process to discover clients not using the Require signing option as:
  - After making the configuration change, clients often find their binds cease working if they are relying on unsigned SASL LDAP binds or on LDAP simple binds over a non-SSL/TLS connection.
    - To assist in identifying these clients, the AD DS or Lightweight Directory Server (LDS) directory server logs a summary **event Identifier (ID) 2887** once every **24 hours**, which indicates **how many such binds occurred**.
    - It is recommended to configure these clients not to use such binds. After these events cease for an extended period, configure the server to reject such binds in the future.
  - Configure the directory server to provide more detailed logs, if more information is required to identify such clients.
    - An **event ID 2889** is logged when a **client attempts an unsigned LDAP bind**.
    - The log entry captures the **IP address and identity** that tried to authenticate.
    - **Setting the 16 LDAP interface events diagnostic setting to 2 (Basic) enables the logging**.
  - The directory server logs a summary **event ID 2888** once every **24 hours** when a **rejected unsigned SASL LDAP bind or LDAP simple bind over a non-SSL/TLS connection** occurs.

### Creating a Bind with the DC
1. Access the LDP, and connect to IP Address as specified
2. Select **Connection > Bind**
3. Select **Bind with credentials**

### Searching Using LDAP from the Client
1. Once a bind is established, select **Browse > Search**
2. Define the search based on the following fields:
  - Base DN: **CN=Users,DC=cda,DC=corp**
  - Filter: **(objectClass=*)**
  - Scope: **One Level**
  - Attributes: **objectClass** (show all attributes via *)

### Securing LDAP from the Server
- If anonymously binding to AD is available, that means one of two things:
  - The connection is binding to Root Directory Server Agent Service Entry (RootDSE), for which anonymous binds should be allowed.
  - AD has been modified to allow anonymous binds for non-RootDSE users, which is a potentially harmful configuration.
- Most applications use **RootDSE** to gather directory information to complete further binds, such as distinguished names or accounts of various partitions.
  - **RootDSE** does not house sensitive information; it is designed to work with anonymous binding to **RootDSE** (i.e., if applications cannot bind anonymously to RootDSE, things break).
- Values of **0 and 2** are **valid for the dsHeuristics attribute**.
  - While the dsHeuristics attribute does not exist, its internal default is 0.
  - If the last character is set to 2, functionality authorized by the Access Control List (ACL) is executable by anonymous clients.
  - If the attribute is defined, no other characters in the dsHeuristics string should be modified other than the seventh.
  - If the value is not set, ensure the leading six zeros are included up to the seventh character.
1. Open **Server Manager**
2. Select **Tools > ADSI Edit**
3. Navigate to _CN=Directory Service folder_
4. Right-click and select **Properties**
5. Locate _dSHeuristics_ attribute and validate attributes are 0 and 2
6. To secure this, edit this field and change to either 0 or `<not set>`

### Enable Server LDAP Signing
1. Open the GPO manager
2. Navigate to **Domain Controllers** and edit
3. Navigate to **Default Domain Controller Policy > Computer Configuration > Policies > Windows Settings > Security Settings > Local Policies > Security Options.**
4. Confirm that it is set to **Require Signing** and apply

### Finding Potentially Harmful Activities Using AD Tools
- **DCSync** is a credential dumping technique leading to the compromise of user credentials, and a prelude to the creation of a Golden Ticket — DCSync compromises the Kerberos Ticket Generating Ticket Account (KRBTGT) password.
  - The KRBTGT is a hidden account that encrypts all authentication tokens for the DC.
  - The Golden Ticket is the KRBTGT account’s Kerberos authentication token.
  - The Golden Ticket can use a **Pass-the-Hash** technique to log into any account, allowing attackers to move around the network unnoticed.
- DCSync attacks occur when an adversary compromises a user’s Replicating Directory Changes All and Replicating Directory Changes privileges — **administrators**, **domain administrators**, **enterprise administrators**, and **DC groups** have these privileges by **default**.
- If necessary, any user can be granted these specific privileges.
- Once obtained, an adversary replicates data (including credentials) from AD using the Directory Replication Service (DRS) remote protocol.
- In addition to DCs, some applications (such as Azure Active Directory Connect) have legitimate requirements for replication permissions.
- These applications are often targets for adversaries because of the requirements.
- Protecting an organization from a Golden Ticket attack is no different than from any other malware or infiltration attack.
- Since an attacker requires privileged access to create the Golden Ticket, the more difficult it is for them to steal credentials, the better protected the organization is.

- Follow these procedures to help defend from a Golden Ticket attack:
  - Train users to recognize and avoid bad links
  - Enforce a least privilege model
    - Limit user access to only what they need
    - Limit administrator and domain administrator access
    - Use administrator accounts sparingly and only for approved changes
  - Install endpoint protection to block attackers from loading modules like **Mimikatz**
  - Create a choke point for access to the DCs, adding another layer of protection
  - Create a terminal server that can only talk to the DCs
  - Configure the DCs to only accept administrative connections from that terminal server
  - Monitor file activity and user behavior
    - Alert on known behavior that indicates Golden Ticket attacks

### DCSync Using Mimikatz as an Attacker
1. Open Mimikatz
2. Run the following command: `lsadump::dcsync /domain:cda.corp /user:krbtgt`
   - the dcsync command is used in the CDA domain to reques credentials for krbtgt user
3. Run the following to generate the Golden Ticket to replicate the Admin account: `kerberos::golden /domain:cda.corp /sid:S-1-5-21-5840559-2756745051-1363507867 /krbtgt:1b8cee51fd49e55e8c9c9004a4acc159 /user:Administrator /id:502 /ptt`

### Detecting a DCSync Attack
1. Open **Event Viewer**
2. Navigate to _Windows_ logs, enter the **Security** logs and filter for **4662**
3. Select a custom date range for when you think the attack was executed
- To ensure that tracking is done, you must update the _Group Policy Management Auditing_ capabilities ot incude _Success and Failure of audit Directory Service Access and Audit Directory Service Changes_

### Permission Settings to Harden DCSync Defenses
1. Open **Server Manager**
2. Select **Tools > Active Directory Users and Computers**
3. Right-Click **CDA.corp** and selcte the **Properties > Security**
4. To prevent this attack, modify the permissions of users who do not require them
5. Under the permissions, locate the following and set them to allow:
  - **Replicating Directory Changes**
  - **Replicating Directory Changes All**
  - This causes a user to be allowed to run a DCSync attack
  - Change these to **DENY** to make this safer

# MOD 15
## Rights Management
### User and Group Objects
- User and group objects can be created in an AD domain in order to facilitate access control.

#### User Objects
- A **user object** represents an account within a domain.
- A set of permissions can be assigned to that user object in order to allow the account access to various resources.
- The term user is commonly used as shorthand to refer to a user object or account.

#### Group Objects
- A **group object** is an object that references a collection of other objects, usually to make it easier to administer an AD domain.
- Each object referenced by a group is considered to be a member of that group — permissions can be assigned to a group object in order to allow its members access to various resources.
- Group objects can be nested within other group objects. For example, group object C may be a member of group object B, which is a member of the final group object A — any permissions assigned to group object A can be inherited by members of group objects B and C. The term group is commonly used as shorthand to refer to a group object.

#### Local vs. Domain
- A distinction should be made between local users and groups and domain users and groups.
  - **Local** users, groups, and any associated permissions are **only applied to a single computer**.
  - **Domain** users, groups and their associated permissions can **apply to many resources across an entire AD domain or forest**.
- A common example of a local user account is the default Administrator account, which is present by default on all Windows Operating Systems (OS) unless explicitly disabled.
  - This account has access to many secured resources on the local computer, such as the system directory C:\Windows\System32\.
  - However, the local administrator account does not have access to other resources elsewhere within the domain.

#### Privileges vs. Access Rights
- **Privileges**
  - A **privilege** is a **permission that is assigned to a user or group in order to allow that object to perform system-level operations on an individual computer**.
  - For example, any accounts with the **SE_SHUTDOWN_NAME** privilege are **allowed to shut down the computer**, as long as they are logged into it locally.
  - The **SE_REMOTE_SHUTDOWN_NAME** privilege is a **separate privilege that allows an account to remotely shut a computer down**.
  - Privileges are assigned to users and groups by a system administrator, usually via the deployment of local or group policy.
    - In order for a privilege to apply, it must also be enabled on the local system — certain accounts may be granted a privilege, but be unable to exercise it because that privilege has been disabled on the system.
    - A list of privileges can be viewed within a few different snap-ins in the Microsoft Management Console (MMC).
    - Privileges within MMC are listed as easy-to-digest descriptions — the real privilege name (e.g., SE_SHUTDOWN_NAME) is used at deeper layers within the OS to uniquely identify a privilege

- **Important Privileges**
  <img width="975" height="1150" alt="6dd5e1d7-e421-4052-9f1b-0bda07551d20" src="https://github.com/user-attachments/assets/fc59ec97-dfed-48fd-9260-8db4d9d870d4" />

- **Access Rights**
  - Whereas privileges allow an object to perform a specific action on a system, access rights allow an object to perform some action against a securable object.
  - Some examples of securable objects include **folders**, **files**, **registry keys**, and **processes**.
  - Securable objects use different sets of access rights depending on the type of securable object.

- **Access Rights Implementation**
  - A system keeps track of a Discretionary Access Control List (DACL) for each securable object present on that system.
  - Each DACL contains a list of Access Control Entries (ACE), which each tie a list of access rights that a trustee (i.e., a user, group, or specific logon session) has to a securable object.
  - An ACE can be one of six types — three of these types are supported by all securable objects:
    - **Access-allowed ACEs**: Grant a trustee the set of access rights specified within the ACE
    - **Access-denied ACEs**: Deny a trustee the set of access rights specified within the ACE
    - **System-audit ACEs**: Used to audit a trustee’s attempts to exercise any of the access rights specified within the ACE

### Individual and Group Account Management
- Proper administration of AD accounts — and the permissions assigned to those accounts — can drastically impact the security posture of one or more federated domains.
- Accounts that have excessive or useful permissions, or are members of important groups, are often targeted by threat actors to achieve malicious gain across the entire enterprise.
- Access to these accounts can aid a threat actor in establishing **persistence**, **further escalating privileges**, **evading defenses**, **accessing additional credentials**, and **achieving lateral movement**.
- Accounts and groups need to be properly managed to effectively protect resources throughout an enterprise.

#### Principle of Least Privilege
- A concept that is widely acknowledged as a best practice throughout the industry is the Principle of Least Privilege.
  - This principle refers to assigning the minimum required permissions that are needed for an account to perform essential actions.
- There are two primary access control strategies that have been developed in order to implement the Principle of Least Privilege.
  - **Role-Based Access Control (RBAC)**: focused on tying a user’s job role to the specific systems or resources that they need access to.
    - An example of RBAC is a user in a company’s marketing department being assigned to a role named AdCampaign01, which gives them the appropriate permissions to access files related to that ad campaign.
  - **Attribute-Based Access Control (ABAC)**: combines different security attributes, such as the role assigned to a user, via the implementation of Boolean logic.
    - These combinations of attributes are built into a policy that can then be applied to users or groups in order to grant them appropriate permissions.
    - This approach provides a high degree of flexibility, since the policy logic can easily be modified later to account for small changes that must be implemented.
    - This strategy is sometimes referred to as **Policy-Based Access Control (PBAC)**.
    - Applying ABAC to the marketing example given above, access to the ad campaign resources might require that the user have two roles, Marketing and AdCampaign01 — a user lacking either of these roles would be unable to view the ad campaign resources.

#### Importance of Proper Account Management
- The MITRE Adversarial Tactics, Techniques, and Common Knowledge (ATT&CK) Navigator chart serves as a visual overview of various attacker techniques and sub-techniques that rely on abusing account management flaws to be successful.
- The chart demonstrates that threat techniques related to account management span almost all of the Enterprise ATT&CK categories, and provides insight into which attacker techniques might be investigated, addressed, or hardened as part of a Cyber Protection Team (CPT) mission. 

### Imspecting User and Group Properties
1. Open the **Active Directory Users and Computers** and Select **Users**
2. Review the following fields:
   - **Name**: Name of each object.
   - **Type**: Type of object displayed (for example, User or specific group type such as Security Group or Distribution Group).
   - **Description**: Provides additional information regarding the object. Default groups and users usually contain detailed descriptions that come pre-configured from Microsoft. 

#### Accessing User Properties
1. Open up a user, and select the _Account_ tab. This incudes config options such as the **logon name**, **domain**, **Account options**, **logon hours**, **log on to**,  if the account is **locked out**, and **expiration date**
2. Select the _Member Of_ tab. This lists out the **groups** a user is part of, and **allows you to add and remove someone from groups**.

#### Accessing Group Properties
1. Open the **Domain Admins** Group
2. Select the _Members_ tab. This shows what users are a part of the group, allowing for addition and deletion from groups, along with the type of group (Security, Domain Local, etc.)
3. Select the _Member of_ tab. This lists all groups this group is a part of. Allows for addition and removal from other groups.

### Querying AD Using Net Commands
1. Open CMD and run `net user`. This shows all users on the system
2. Run `net user /domain` to see users from the curretnly joined domain
3. Run `net user Administrator /domain` to see information about the domain Admin to include: **Password last set date**, **Last logon date**, and **Global Group memberships**.
4. Run `net localgroup` to list all groups on the system
5. Run `net group /domain` to list all groups on the domain
6. Run `net group "Domain Admins" /domain` to list users in a specific group.

### Querying AD Using PowerShell
- Run `Get-ADUser -Filter *` to list all users in the current domain. Also includes info such as: **Security Identifier (SID)**, **DistinguishedName**, **Enabled status**, and **Object Globally Unique Identifier (ObjectGUID)**.
- Run `Get-ADUser jdoe -Properties *` to list the properties of a specific user. Includes info such as: **adminCount**, **Created**, **LastLogonDate**, **Modified**, and **PasswordLastSet**.
- Run `Get-ADGroup -filter *` to list all groups on the domain. Includes info such as: **DistinquishedName**, **GroupCategory**, **ObjectGUID**, and **SID**
- Run `Get-ADGroupMember -identify "Domain Users"` to list all members of a specific group
- Run `Get-ADGroupMember -Identity Administrators | Select-Object name, objectClass, distinguishedName` to queriy members of the Administrators group.
- Run `Get-ADGroupMember -Identity 'Domain Admins' | Select-Object name, objectClass, distinguishedName | Export-CSV -Path “DomainAdminGroupMembers.csv”` to list out info and export to a file.
- Run `type .\DomainAdminGroupMembers.csv` to read the file you created.
- Run `Get-ADUser leonard.blevins -Properties * | Export-CSV -Path "leonard.blevins.csv"` to get info on a specific user and export to a file.

### Securing User Accounts
#### Privileged Accounts
- **Basic user accounts**: Accounts used by the general population of network users.
  - These accounts usually require less privileges as they are generally used for basic job functions.
- **Privileged accounts**: Accounts with specific elevated rights that grant them access to information and resources, or the ability to administer changes.
  - Listed below are some examples of what privileged accounts could be commissioned for:
    - An account for a healthcare employee that grants access to specific resources that contain Personally Identifiable Information (PII) required for them to execute their job function.
      - Additionally, this account may provide access to an application or service that helps the employee manage and interact with that data.
    - A local administrator account used by an IT employee to make changes to a local system, but not to the wider network or domain.
    - A domain administrator account allowing an administrator to modify information within, and make configuration changes to, an AD domain.
      - These actions might include the commission and decommission of new users, the ability to modify user and group permissions, or the addition, removal, or modification of any object within the domain.
      - Generally, domain administrator accounts are also granted a high level of privileges on individual endpoints within that domain.
    - An enterprise-level administrator account made for an administrator to manage all trees, domains, and Organizational Units (OU) within the AD forest.
- **Shared accounts**: Accounts shared by two or more users.
  - These accounts are not recommended and should be generally prohibited, since they present many challenges when auditing user activity and providing attribution for actions.
    - If shared accounts are required, it is highly recommended that the privileges provided to these accounts follow the **Principle of Least Privilege** in order to reduce the risk and impact of malicious use.
- **Service accounts**: Accounts associated with an application or service in order to provide a security context for that service to run under.
  - It is common for service accounts to have elevated privileges, making them a juicy target for threat actors.
  - A good method of identifying MCA performed by service accounts is to confirm that service accounts have no interactive sessions associated with them and few child processes.
- Generally, it is recommended that **high-privileged accounts be separate from everyday user accounts**, and that the **high-privileged accounts only be used when these privileges are necessary** to perform an **essential job function**. 

#### Managing Passwords
- Password management is still a popular concept when discussing security.
- Accounts — especially high-privileged ones — should have strong passwords and have Two-Factor Authentication (2FA) enabled when possible.
- Unfortunately, service accounts and other legacy accounts still remain that cannot utilize 2FA.
- Additional issues that may increase an organization’s password compromise risk might be multi-use systems and users being resistant or hesitant to change.

#### Decommissioning Accounts
- Deleting or disabling accounts that are no longer necessary is an often overlooked function within the realm of account management.
- There are several considerations that must be made when deciding whether to delete or disable an account.
- Disabling an account can have far less negative impact on an investigation, because deletion may remove important data and event logs associated with that account.
- Similarly, account deletion may cause a huge headache if there are any downstream resources that rely on that account to be present — an account can be easily re-enabled, but restoring a deleted account is much more difficult.
- However, deleting accounts leads to a much cleaner directory, and allows for easier management of the directory in the future.
- One way an organization might choose to balance these considerations is via the creation of an account deletion policy — any accounts that are no longer needed must be disabled, then an appropriate amount of time must pass before deletion.

#### Account Managemnet Attacks
<img width="1000" height="2500" alt="69f05d2f-ca8d-4aba-b6a7-85a65741c77f" src="https://github.com/user-attachments/assets/a515bb8d-96b5-40c9-93c3-326ea138aea6" />

### Security Management of Individual Users
1. Open _Active Directory Users and Computers_
   - Double-Click on an account, and Select the _Member Of_ tab to look at all groups this user is a member of.
   - Select the _Account_ tab, and uncheck the _Password never expires_.
     - This means that the user’s password expires after the time specified by the domain’s password security policy — the user must change their password after this date in order to continue using the account.
   - Select the _End Of_ button and enter a date of your choosing based on needs.
     - This means that this account is automatically disabled in four months, which can prevent an attacker from holding access over significant stretches of time
   - Select the _User must change password at next logon_ to make them change their password upon next logon.
     - This forces a user to change their password upon their next login, and is a good method for forcing long-lived passwords to be compliant with updates to the password security policy.
   - Select _Logon Hours_ and change it to the normal work hours for that individual
     - This mitigation prevents a user from logging in outside the specified timeframes.
     - An attacker who has compromised this account is unable to log in with it outside of the chosen timeframe.
   - Select _Log On to_, and then _The Following COmputers_.
     - Select the specific computers that the user is allowed to log on to.
     - This mitigation severely limits an attacker’s opportunities to use this account for lateral movement.

#### Protected Users Group
1. Open _Active Directory Users and Computers_
   - Double-Click on an account, and Select the _Member Of_ tab to look at all groups this user is a member of.
   - Select _Add..._, then _Advanced > Find Now_.
     - Find the _Protected Users_ Group, and click Ok
     - Select OK on the _Select Groups_ windows, and Apply.
     - Members of this group automatically have non-configurable protections applied to their accounts.
     - The only method to modify these protections for an account is to remove the account from the group.  
- As per the Microsoft documentation for the Protected Users security group:
  - Accounts that are members of the Protected Users group that authenticate to a Windows Server 2012 R2 domain are unable to:
    - Authenticate with New Technology Local Area Network (LAN) Manager (NTLM) authentication.
    - Use Data Encryption Standard (DES) or Rivest Cipher 4 (RC4) encryption types in Kerberos pre-authentication.
    - Be delegated with unconstrained or constrained delegation.
    - Renew the Kerberos Ticket-Granting Tickets (TGT) beyond the initial four-hour lifetime.

### AD Group Security
- When discussing the security of groups, it is important to understand the difference between local and domain groups and the concept of group scope.
  - As discussed earlier, an AD group can be a local group or a domain group.
  - Local groups are groups that are specific to the particular system that the group was created on, while domain groups are groups that can apply to a larger AD environment.
  - Note that membership in a local group can include domain users and groups, if the system is joined to a Windows domain.
  - For example, an organization’s IT accounts might be added to the local Administrators group on each endpoint, in order to facilitate quick IT management and administration of that endpoint.

#### Group Scope
- A group’s group scope defines the possible members of that group, and the location within an AD forest where permissions associated with that group are applicable.
- There are three possible group scopes.
  - **Domain Local group**: Only grants permissions within the same domain as it is defined in.
    - These permissions do not apply to other domains within the tree or larger forest.
    - It is important to note that membership within a Domain Local group is not very restricted — any user, global group, or universal group from within the forest can be a member of a Domain Local group.
      - The only restriction is that a Domain Local group cannot be a member of another Domain Local group within a different domain.
  - **Global group**: Grants permissions over any domain within the AD forest.
    - Membership for these Global groups can consist of accounts and other Global groups from the same domain.
  - **Universal group**: Grants permissions across the entirety of the AD forest.
    - Members of a Universal group can consist of any user account, Global group, or Universal group within the forest.
- Ultimately, group scopes exist to enable AD administrators to grant permissions in an efficient way.
- However, group scopes can be used by Defensive Cyber Operators to more accurately assess and investigate security issues with an AD domain.
- Misconfigurations of these group scopes within an AD forest could allow an attacker to gain unintended access to other resources within the forest.

#### Managing Security Group Membership
1. Open _Active Directory Users and Computers_
   - Select the Account in question and then the _Member of_ tab.
     - Select the _Enterprise Admins_ group to view the properties
     - Remove any groups that they do not need to be a part of.

### Auditing AD Activity
#### Usage Auditing
- In the case of a breach, account usage auditing can drastically reduce the time required to determine what attacker actions have taken place.
- It is important to be able to monitor which accounts are accessing and modifying objects within the enterprise.
- Monitoring this behavior can help provide context regarding whether the account is being used in accordance with security policy and is being leveraged for legitimate use.

#### Privilege Auditing
- Continuous auditing of privileges available throughout the environment can ensure that privileges that are no longer needed are removed.
- This includes updating privileges as usage requirements change, and removing accounts for users or services that are no longer necessary to the organization.
- This is one of the most important aspects of maintaining the **Principle of Least Privilege**.

#### Change Auditing
- Proper auditing of the changes made to an account — and deployment of alerts around any highly impactful changes — allows local defenders to quickly identify and respond to potential MCA from internal and external threats.
- This is important, as threats often manipulate account permissions as part of privilege escalation, discovery, lateral movement, and persistence activities.
- The events used to perform AD audits exist in many different places within an AD environment.
- Events are generated on Windows workstations, Windows servers, or directly on AD infrastructure such as DCs.
- These events can be collected and aggregated into a centralized source, such as a Security Information and Event Management (SIEM) instance.
- Investigation of these events can provide insight into the activity that occurred within an environment.

### Investigating Potential MCA
- Table 15.1-4 provides a list of AD-related Windows event logs and corresponding descriptions that might be useful during the investigation.

  <img width="963" height="563" alt="91904a4e-69fd-47cf-818e-cd300d8db605" src="https://github.com/user-attachments/assets/e05a2e12-b99c-4366-908d-1c90b40c0474" />

- Filter for:
  - `winlog.event_data.CommandLine:"net"`
  - EVENT CODE 4688: Process Creation
  - user.name: <UserName>
  - You can also filter on `winlog.event_data.TargetUserName:"marco.inaros" AND (event.code:4720 OR event.code:4722 OR event.code:4724 OR event.code:4738)` to be more efficient

<img width="963" height="456" alt="de69be72-3dbb-4281-a95d-183bffb4066f" src="https://github.com/user-attachments/assets/b81eeaa5-53ec-4032-a9f9-60d87cebd29c" />

### Scoping an MCA Login
<img width="963" height="456" alt="2ba68ba7-aa61-4b72-9c83-2bfa7970b40a" src="https://github.com/user-attachments/assets/3b724763-450f-42c5-8188-362f654e7a81" />

- It is possible to filter for this information based on: ```(marco.inaros OR "Enterprise Admins") AND (event.code:4728 OR event.code:4732 OR event.code:4735 OR event.code:4737 OR event.code:4754 OR event.code:4755 OR event.code:4756)```
- Windows **4672** events are generated whenever special privileges are assigned to a new logon session.
  - `marco.inaros AND event.code:4672` Determine Special privileges assigned to a user's session (Add in winlog.event_data.PrivilegeList
  - `event.code:4688 AND user.name:marco.inaros` to query commands that a specific user ran on the system
  - `event.code:4634 AND marco.inaros` to query for a User logoff time

## Windows Authentication
### Single-Sign On (SSO)
- SSO is an authentication protocol that enables users to securely access multiple applications, systems, and services using only one set of credentials.
- Users may require access to multiple applications, from different vendors, throughout their average workday.
- With SSO in place, users do not need a unique username and password for each unique application.

### Directory Federation Overview
- SSO is built on directory federation.
  - Directory federation utilizes Federated Identity (FID) to enable access management by securely sharing digital identity and entitlement rights across security and enterprise boundaries.

#### Federated Identity
- Much like a person’s physical identity is made up of features and attributes, in the digital landscape a user’s digital identity is also made up of features and attributes that uniquely defines a user moving through the landscape.
- FID is a method of linking a user’s identity across multiple separate identity management systems.
  - It allows users to quickly move between systems while maintaining security. In this way, different platforms can communicate and share without requiring another login. 

#### The Seven Laws of Identity
- Kim Cameron, Microsoft's Architect of Identity, developed seven Laws of Identity.
- The seven laws that federated identity systems are built upon and bound by include:
  1. User Control and Consent: Digital identity systems must only reveal information identifying a user with the user's consent.
  2. Limited Disclosure for Limited Use: The solution that discloses the least identifying information and best limits its use is the most stable, long-term solution.
  3. The Law of Fewest Parties: Digital identity systems must limit disclosure of identifying information to parties having a necessary and justifiable place in a given identity relationship.
  4. Directed Identity: A universal identity metasystem must support both omnidirectional identifiers for use by public entities and unidirectional identifiers for private entities, thus facilitating discovery while preventing unnecessary release of correlation handles.
  5. Pluralism of Operators and Technologies: A universal identity metasystem must channel and enable the interworkings of multiple identity technologies run by multiple identity providers.
  6. Human Integration: A unifying identity metasystem must define the human user as a component integrated through protected and unambiguous human-machine communications.
  7. Consistent Experience Across Contexts: A unifying identity metasystem must provide a simple consistent experience while enabling separation of contexts through multiple operators and technologies.
- NOTE: A metasystem is a system comprised of small systems connected together.

### Active Directory Federation Services
- Active Directory Federation Services (AD FS) is a Microsoft software component that runs on Windows Server OSs.
- AD FS provides users with SSO access to systems and applications.
- AD FS enables federated identity and access management by securely sharing digital identity and entitlements rights across security and enterprise boundaries.
- This can be accomplished across those boundaries through the following process:
  1. A user makes a request for a resource in the AD FS environment.
  2. An organization server responsible for identity validation verifies the user through the authentication methods configured for that AD FS environment, such as the protocols described later in this lesson.
  3. The server issues a token containing a progression of data about the client including its identity. 
  4. On the resources side of the environment, another organization server approves the identity token.
  5. The second server issues another token for the area servers to acknowledge the personality. This enables a framework to give controlled access to its assets or administration to a user that resides with another security domain without requiring the user to verify legitimately to the framework and without the two frameworks sharing a database of user identities or passwords.
  6. The token for access to AD FS servers is employed by the user without the need to continue to verify the user’s identity.
- One implementation of this model that is explored in greater detail later in this lesson is the Kerberos protocol.
  
<img width="500" height="700" alt="66dea193-d4ae-4344-a134-e417c17bde67" src="https://github.com/user-attachments/assets/11b8aef0-340f-483a-9f3d-47b4795e7b86" />

#### AD FS Security Protocols
- AD FS and its relationship with SSO makes it a critical asset for DCO. Access to the Domain Controller (DC) and AD FS should remain to a minimum.
- Below are security protocols and best practices to secure an AD FS deployment:
  - Ensure only domain administrators have rights to access the AD FS.
  - Keep the administrators group to a minimum number of users on AD FS servers.Enforce Multi-Factor Authentication (MFA).
  - Place AD FS server computer objects in a top-level Operational Unit (OU) that does not host other servers.
  - All Group Policy Objects (GPO) that apply to AD FS servers should only apply to them and not other servers as well. This limits potential privilege escalation through GPO modification.
  - Configure security logging to the highest and most detailed level; this does not include the AD FS Trace Log.
  - Send the Security Logs for AD FS — Applications and Services Log → AD FS → Admin — to a Security Information and Event Management (SIEM) to correlate with AD.

### Windows Authentication Hashing | Introduction
- Windows Authentication hashing methods includes:
  - **LM**: LAN Manager
  - **NT-Hash**: New Technology (NT) Hash, known popularly as NT LAN Manager (**NTLM**).
- In this lesson, to remove ambiguity, these are respectively referenced by the terms **NT-Hash**, **Net-NTLMv1**, and **Net-NTLMv2**.
- NOTE: This means that **NT-Hash only refers to how windows systems represent user passwords on disk and in memory**, and **Net-NTLMv1 or Net-NTLMv2 only refer to the challenge-response network protocols used by one system to authenticate to another**.

#### Cryptography Vocabulary
- **Hashing algorithm**: A deterministic one-way function that ingests data (e.g., a message of any length) and outputs a fixed-length value that cannot be reversed into the original content.
  - The output value is commonly referred to as a hash or message digest.
  - A message always has the same hash as long as its contents have not changed.
- **Salt**: A random string (e.g., 1F3E1147AD7) that is appended to a message prior to being hashed and is saved afterward for future hashing verification.
  - Salting a hash increases the level of complexity for an attacker to decrypt the hash into a cleartext password, and removes their ability to use rainbow tables for cracking.
- **Encryption**: A process that uses keys and a mathematical algorithm to convert human- or machine-readable data to an unreadable format, known as a ciphertext.
  - The ciphertext can only be reversed or decrypted with the keys that were used to encrypt it.
- **Symmetric Key Cryptography**: A method of encryption that uses the same key to both encrypt and decrypt messages.
- **Asymmetric Key Cryptography**: A method of encryption that employs the mathematical difficulty of factoring very large prime numbers to use two different — but complementary — key pairs for encryption and decryption between parties.
- **Hash-based Message Authentication Code (HMAC)**: HMAC is a cryptographic technique that uses a pre-shared key, also known as a secret, and a defined hashing algorithm to create a well-padded, double-hashed hash.
- **HMAC-MD5**: Hash-based message authentication code using Message Digest (MD) 5 as the hashing algorithm.
- **Rainbow tables**: Large data structures used by attackers that contain a map of pre-computed hashes to the cleartext passwords used to generate them. They are often used by attackers for their effectiveness and low time to identify the cleartext password.

### Windows Password Hashing | LM
- The LM hash is the oldest password storage mechanism used by Windows, dating back to an OS first deployed in the 1980s.
- Due to the limited character set allowed at the time, the hashes — created by the algorithm — are fairly easy to crack with modern computing systems.
- LM is turned off by default starting in Windows Vista/Server 2008.
- LM hashes are obtained from the Security Account Manager (SAM) database on legacy Windows systems or a DC’s NT Directory Services (NTDS) database.
- The principal **weaknesses** of the LM hashing algorithm are the **limited character sets reducing complexity**, **the ease of cracking short passwords due to null-byte padding**, and the **usage of a publicly-deprecated encryption protocol known as Data Encryption Standard (DES)**.
- With modern computing power, the relatively small key size in implementations of DES encryption led data encrypted with it to be exposed in a matter of hours or days.
  - This impacted not only LM hashes but also Net-NTLMv1, which is discussed later.

#### The LM Hashing Algorithm
<img width="541" height="130" alt="image" src="https://github.com/user-attachments/assets/ccf075f8-36fb-4115-8de7-074e79298692" />

#### Weaknesses
- LM hashing is a very weak cryptographic algorithm due to its age, and is riddled with flaws by using heavily constrained inputs and outputs.
- For example, due to how the algorithm changes all characters to uppercase, the hashes of the following passwords all have the same hash:
  - Password1
  - pAssword1
  - PASSWORD1
  - PassWord1
- This algorithm only accepts the 95 American Standard Code for Information Interchange (ASCII) characters, with only 69 possibilities per character after eliminating the entire lowercase alphabet, which leads to only 7.5 trillion possible permutations for each half instead of the 69^14 for the whole 14 characters, since splitting the password in half lets an attacker brute-force seven characters rather than all of them.
- Rainbow tables already exist containing all these possibilities.
  - Rainbow tables are large data structures that map pre-computed hashes to the passwords used to generate them, and are normally processed with a system's Graphics Processing Unit (GPU) to reduce the resources used by the Central Processing Unit (CPU).
  - This allows for significantly faster cracking on unsalted passwords since it requires only a lookup from a table rather than hashing the passwords on an entire wordlist and comparing each one.
- If the password is seven characters or less, the second half of the encrypted string is **AAD3B435B51404EE** — the string **KGS!@#$%** encrypted with all zeroes.
  - This cuts the total time to cracking the hash in half and is easily identifiable by an attacker.
- In retrospect, the LM hashing algorithm was created on the assumption that no one would either reverse it or infiltrate the internal network to be in a position to capture it. 
- Passwords hashed with LM algorith are first padded with zeros if less than 14 characters

### Windows Password Hashing | NT-Hash
- This hashing algorithm is the way passwords are stored on modern Windows systems, and those hashes can be obtained by threat actors by dumping the SAM/NTDS database, or using a tool for reading the hashes out of lsass.exe process memory, such as Mimikatz.
  - These are the hashes used in the Pass-the-Hack (PtH) attack.
- A domain/standalone workstation could be exploited if vulnerable to such an attack.
  - This is commonly called the NTLM hash, but Microsoft refers to this as the NTHash.

#### The NT-Hash Algorithm
- `MD4(UTF-16-LE(password))`
- The NT-Hash algorithm is relatively straightforward and uses the following process:
  1. A user's password is converted to 16-byte (128-bit) little-endian Unicode Transformation Format (UTF) (UTF-16-LE).
  2. The MD4 hashing algorithm is used to convert the Unicode password to an NT-Hash.
- **NOTE**: The PtH technique can still be abused with the NT-Hash even if a threat actor fails to crack it.
- Since a salt is not used while generating the hash, the NT-Hash can be cracked by using either pre-generated rainbow tables or a password cracking tool (e.g., hashcat or John the Ripper).
- Password cracking tools progressively brute-force a password sequentially or using a supplied wordlist, and leverage the associated hashing algorithm to identify the cleartext password.
- This attack can be made easier by scraping language from company websites, employee social media profiles, etc., in the wordlists that are used by these tools.
- The MD4 algorithm employed in this method is defined in the document Request for Comments (RFC) 1320: **rfc1320** 

### Windows Authentication Protocols | Introduction
- Windows authentication protocols include **LM**, **Net-NTLMv1**, **Net-NTLMv2**, and **Kerberos**.
- Windows AD authentication protocols authenticate **users**, **computers**, and **services** in AD, and **authorize the user and/or service to access requested resources**.
- LM is among the oldest authentication protocols used by Microsoft.
- However, its hashes were relatively easy to crack.
- By capturing hashes and cracking them to obtain account logon credentials, attackers could easily authenticate to other systems on the domain.
- **Net-NTLMv1**, which succeeded LM, is an **encrypted challenge/response-based authentication protocol** used for network logons by client devices, but its implementation is flawed and can be easily exploited by an attacker.
- **Net-NTLMv2** was a significant improvement compared to Net-NTLMv1 in terms of both authentication and session security mechanisms.
- It enhanced the security of Net-NTLMv1 by adding the ability for a server to authenticate to a client, but remains vulnerable due to the ability of a third-party attacker to intercept and relay the challenge/response.
- **Kerberos** authentication is a vast improvement over the previous technologies.
  - **Kerberos** provides identity authentication by exchanging messages between the client, authentication server, and application server.
- Compared to Net-NTLMv2, Kerberos’s use of strong cryptography and third-party ticket authorization makes it much more difficult for threat actors to infiltrate the network, which provides an additional layer of security.
- The **Net-NTLMv2** protocol is not recommended for use in an AD environment, and any applications still employing it for authentication should have that feature deprecated where possible.
  - This may not be feasible in all environments, and where those exceptions exist, increased security controls should be deployed in order to mitigate any possible risks of exploitation, as described in Microsoft Information Technology (IT) Documentation.

<img width="674" height="248" alt="39b0c309-9ad8-4264-ad9e-a388186c0745" src="https://github.com/user-attachments/assets/5b306322-261e-4e4e-95ca-17933a344104" />

- **Symmetric Key Cryptography**: A method of encryption that uses the same key to both encrypt and decrypt messages.
- **Asymmetric Key Cryptography**: A method of encryption that employs the mathematical difficulty of factoring very large prime numbers to use two different — but complementary — key pairs for encryption and decryption between parties.
- Kerberos should be required for authentication in AD, and clearly operate at higher security levels than LM, Net-NTLMv1, and Net-NTLMv2, which present significant cybersecurity risks for enterprises.
- Official Microsoft guidance regarding authentication mechanisms in AD environments is to **disable Net-NTLM authentication over the network**:
  - **_NTLM and NTLMv2 authentication is vulnerable to a variety of malicious attacks, including Server Message Block (SMB) replay, Man-in-the-Middle attacks, and brute force attacks. Reducing and eliminating NTLM authentication from your environment forces the Windows operating system to use more secure protocols, such as the Kerberos version 5 protocol, or different authentication mechanisms, such as smart cards._**

### Windows Authentication NEtwork Protocols | Net-NTLMv1
- The Net-NTLMv1 protocol employs the NT-Hash in a challenge/response between a server and a client to avoid sending a user’s hash over the network.
- The original version of the protocol uses both the NT and LM hash, depending on the domain’s configuration and available dialects.
- Net-NTLMv1 is deprecated and not typically used by default,  but it may still be found in some old versions of Windows, if present on a network.

#### The Authentication Process
1. The client initiates protocol-specific negotiations before authentication. If the protocol for the resource the client is authenticating to is SMB, then the first exchange consists of the SMB_COM_NEGOTIATE request and response messages. The client sends its supported dialects and the server responds with the highest possible dialect. 
2. The client initiates the Net-NTLMv1 protocol negotiation, and includes its hostname and domain, where applicable. This message is normally embedded inside a protocol setup request, such as SMB_COM_SESSION_SETUP_ANDX or SMB_COM_SESSION_SETUP.
3. In response, the server generates a random 8-byte challenge and sends it back to the client. This challenge message is contained in a session setup response message.
4. The client uses the hash of the user’s password to encrypt the challenge received from the server and returns the response — the 24-byte Net-NTLMv1 proof string — back to the server using another session setup request message.
5. The server sends the username, challenge, and client response to the DC to verify that the requesting user is authorized to authenticate to the domain resource.
6. The DC looks up the username and corresponding password hash in the NTDS database, and uses it to encrypt the challenge.
7. The DC compares the encrypted challenge with the response computed by the client. Authentication is successful if both are identical.
8. The server returns a STATUS SUCCESS message in a session setup response.

#### The Net-NTLMv1 Encryption Algorithm
    ```C = 8-byte server challenge, random
    K1 | K2 | K3 = LM/NT-hash | 5-bytes-0
    response = DES(K1,C) | DES(K2,C) | DES(K3,C)
    ```
- The challenge length is eight bytes long and the response is 24 bytes long.
- The NT-Hash (16 bytes) is divided into three different 7-byte chunks
  - K1: NT-Hash Bytes 1 to 7
  - K2: NT-Hash Bytes 8 to 14
  - K3: NT-Hash Bytes 15 to 16, with five bytes of padded zeros
- Each chunk is then used as the Cipher Key to encrypt the 8-byte challenge using DES.
  - Once each chunk has been encrypted, they are concatenated in order and form the 24-byte Net-NTLMv1 proof string.
- The Net-NTLMv1 Proof String cannot be used directly to pass the hash — like when the LM hash is sniffed from the network — but it can be cracked or relayed.
- Since the challenge is variable, one cannot use rainbow tables against a Net-NTLMv1 proof string. Although, the password can be cracked by brute-forcing password hashes against the string, since the challenge plaintext is also known from sniffed traffic.

#### Why Net-NTLMv1 is Unsafe
- The problem lies in the challenge and in the way it is encrypted by the client.
  - The challenge used by Net-NTLMv1 is always an 8-byte random number.
  - The protocol uses DES, which is designed to be very fast, but can be also decrypted very quickly.
  - The three concatenated parts of the client response can be attacked separately to find the chunks of the NT hash, and of those chunks, the third can be used as an oracle since it is always padded with five zeroes.

### Windows Authentication Network Protocols | Net-NTLMv2
- Net-NTLMv2 is the more advanced and secure version of the Net-NTLMv1 protocol but is deprecated.
- The concept is the same as Net-NTLMv1, but this protocol employs a different algorithm and includes additional data in the client response.
- This protocol has been used by default in Windows OSs since Windows 2000.

#### The Authentication Process
- The authentication steps in Net-NTLMv2 are identical to Net-NTLMv1, except the challenge/response generation algorithm and the challenge length differ.
- In Net-NTLMv2, the entire server challenge length is variable instead of the fixed 16-bytes used in Net-NTLMv1.
- In Net-NTLMv2, any parameters that are added by the client such as client nonce/challenge, server challenge, timestamp, or username are hashed, which is why the length of Net-NTLMv2 challenges varies from one user or session to another.
- Net-NTLMv2 responses cannot be used for a PtH attack, due to the security improvements, but they can still be relayed or cracked. The process of cracking a user’s original NT-Hash may take some time, but it is possible.

#### The Net-NTLMv2 Algorithm
- **HMAC**: A cryptographic technique that uses a pre-shared key, also known as a secret, and a defined hashing algorithm to create a well-padded double-hashed hash.
- **HMAC-MD5**: A cryptographic technique that uses MD5 as the hashing algorithm.
- The response is created by concatenating the results of LMv2, Client Challenge (CC), NTv2, and Variable Challenge Components (CC*).
- In order to create the LMv2 and NTv2 responses, the client generates a ResponseKey for this specific exchange by generating an HMAC-MD5 hash of the user’s NT-Hash, Username, and Domain.
- LMv2 is a 24-byte hash created by concatenation of an HMAC-MD5 16-byte hash and an 8-byte CC.
  - The HMAC-MD5 hash is generated through the concatenation of the following values:
    - An 8-byte Server Challenge (SC)
    - An 8-byte CC
    - An HMAC-MD5 hash (v2-Hash) of the user's NTLM-Hash, username, and domain name.
- CC follows the LMv2 hash, which is just the 8-byte CC.
- NTv2, known as the NT Proof String, is the HMAC-MD5 of the following Items:
  - Response Key
  - The 8-byte SC
  - The variable components of the challenge response, which include:
    - Current time in NT time format
    - An 8-byte random value - Client Challenge (CC)
    - Server name
    - Other system information
- This NTv2 hash is then followed by the items that were hashed (CC*).
- This process of forming the entire response is summarized below.
  ```
  SC = 8-byte server challenge, random
  CC = 8-byte client challenge, random
  CC* = (time, CC, server name, systeminfo)
  ResponseKey = HMAC-MD5(NT-Hash, username, domain name)
  LMv2 = HMAC-MD5(ResponseKey, SC, CC)
  NTv2 = HMAC-MD5(ResponseKey, SC, CC*)
  response = LMv2 | CC | NTv2 | CC*
  ```
- This protocol algorithm is defined in Microsoft official documentation: [MS-NLMP]: NTLM v2 Authentication.

### Windows Authentication Network Protocols | Kerberos
- Kerberos is the modern Windows authentication protocol. It is — as authentication protocols go — very old, with the first publicly available version published in 1988. With improvements and updates, it exists as the most secure form of modern Windows Authentication mechanisms available when properly configured and implemented.
- Kerberos allows principals, which are client devices or user identities, to gain federated access to networked resources in a trusted environment — also known as a Kerberos realm.
- In an AD domain, which normally encompasses the entire realm, the user account that performs the actions of the Key Distribution Center (KDC) is KRBTGT. This account delivers two services to the realm — the Authentication Service (AS) and the Ticket Granting Service (TGS). The AS is responsible for validating the identity of all principals. The TGS is responsible for granting access to domain services and resources requested by authenticated principals.

- The Kerberos protocol conducts authentication to those services and resources in the following steps:
  - The principal requests authentication to the KDC with an Authentication Service Request (AS-REQ).
    - In this request, the principal includes its own identity as a client name (cname_string).
  - The KDC AS validates the principal’s identity and responds with a Authentication Service Response (AS-REP).
    - In this response, the KDC AS encrypts the session key to be used in the TGS exchange with the principal’s NT-Hash.
    - The KDC AS also encrypts the session key with the KRBTGT NT-Hash. This encrypted message is the TGT.
  -   The Key Distribution Service (KDS) AS sends both the encrypted session key and TGT to the principal in the AS-REP.
  - The principal generates a request to the KDC for access to a specific service with a Ticket Granting Service Request (TGS-REQ).
    - The principal encrypts its own identity with the session key decrypted from the AS-REP. This message is the Authenticator.
    - The principal sends the TGT received from the AS-REP and the Authenticator in the TGS-REQ.
  - The KDC TGS validates the principal’s TGT; responds with a Ticket Granting Service Response (TGS-REP).
    - The session key is decrypted from the TGT using the KRBTGT NT-Hash.
    - If the identity decrypted from the Authenticator matches the cname_string that the principal used in the TGS-REQ, then the TGS considers the request valid.
    - The KDC TGS encrypts the session key for the requested service exchange using the current session key.
    - The KDC TGS encrypts the session key for the requested service exchange using that service’s NT-Hash. This encrypted message is the Service Ticket.
    - The KDC TGS sends both the Service Ticket and the encrypted session key.
  - The principal generates an access request to a specific service with a Service Authentication Protocol Request (AP-REQ).
    - The principal encrypts its own identity with the session key decrypted from the TGS-REP. This message is the Authenticator.
    - The principal sends the Service Ticket received from the TGS-REP and the Authenticator in the AP-REQ.
  - The service validates the principal’s service ticket; responds with a Service Authentication Protocol Response (AP-REP).
    - The session key is decrypted from the Service Ticket using the service’s own NT-Hash.
    - If the identity decrypted from the Authenticator matches the cname_string that the principal used in the AP-REQ, then the service considers the request valid.
    - The service responds to the principal confirming access to the service.
  
<img width="1658" height="1013" alt="720ef905-f3a3-4df3-862d-1f48be556ee3" src="https://github.com/user-attachments/assets/5a25dda9-c230-42f3-a30a-ac700b28028b" />

### Windows Authentication Attacks, Mitigations, and Audits| Overview
- Network authentication via LM or Net-NTLMv1 should never be enabled. However, the first step in disabling these deprecated protocols is to determine which systems are using them to prevent the failure of those systems.

#### General Mitigations for Multiple Types of Attacks
- Attacks on Windows Authentication mechanisms succeed for privilege escalation and lateral movement when the appropriate security controls are not in place.
- These can be easily configured from a domain administrator account with Active Directory and Group Policy management access on the domain controller.
- The attacks on Windows authentication and the corresponding recommended mitigation techniques described in this lesson are categorized in the MITRE ATT&CK framework. 

#### MITRE ATT&CK Technique M1018 - User Account Management
- The classic information technology principle of accounts holding the least amount of privilege necessary for the duties assigned is the first defense against a severe compromise.
- Prevent a domain user from holding membership in the local administrator group on multiple systems to reduce the opportunity for privileged compromise on one system to lead to privileged compromise on another.

#### MITRE ATT&CK Technique M1027 — Password Policies
- Employ the recommendations in the appropriate system’s Security Technical Implementation Guide (STIG) regarding password length and complexity.
- For example, Windows 10 workstations require a minimum password length of 14 characters with complexity dictating that characters from three of the following categories are present:
  - **Uppercase letters**
  - **Lowercase letters**
  - **Numbers**
  - **Special characters**
  - Any **Unicode character** categorized as an alphabetic character but is **not uppercase or lowercase** (e.g., characters from Asian languages)
- **NOTE**: In Microsoft systems, the set of **special characters includes:** **~!@#$%^&*_-+=`|(){}[]:;"'<>,?/.**

#### MITRE ATT&CK Technique M1026 — Privileged Account Management	
- In order to prevent any potential compromise from causing excessive damage, limit domain administrator account permissions to domain controllers and essential servers, delegating other accounts - such as service accounts - for less essential administrator functions.
- Additionally, reducing duplicated credentials in the domain inhibits a threat adversary's ability to perform lateral movement between systems, especially privileged movement.

#### Prevent Systems from Storing LM Hashes
- As described earlier in this lesson, LM hashes are extraordinarily easy to crack and should never be stored on disk or in memory. This restriction can be enforced via GPO.

#### Enforcing Net-NTLMv2
- If Net-NTLMv2 is necessary for a mission partner environment for continuity purposes, then the environment should be configured to only allow Net-NTLMv2 authentication.
- The setting that defines the authentication level at which clients and servers must communicate is called the LAN Manager Authentication Level.
- Default compatibility between clients and servers regarding which protocols to use and accept is described below.
![2d9b0cab-626a-42bc-ba7a-19ed19c1e107](https://github.com/user-attachments/assets/309717a6-f639-441d-afbf-68d7b420932f)

### Windows Authentication Attacks, Audits, and Mitigations | PtH
#### Attack Overview
- A PtH attack is a lateral movement or privilege escalation technique in which an attacker captures a password hash rather than the password itself, and then simply passes it to the desired service or remote system for authentication as a valid domain user.
- The threat actor does not need to find the plaintext password since this attack exploits the challenge/response nature of the NTLM authentication protocol, not the hashing algorithm.
- The password's hash remains static for each session until the password has been rotated.
- Threat actors may obtain hashes by scraping a system’s active memory with a tool such as Mimikatz or sniffing network traffic that employs legacy protocols, and can use the compromised credentials without obtaining or brute-forcing the plaintext password.
- This is a post-compromise technique for further credential theft and lateral movement.
- Since Windows workstations deployed in an AD domain use an SSO model for user authentication, hashes are retained in memory once a user has initially authenticated to the system and the NT-Hash is calculated.
- The NT-Hashes used in a PtH attack can be obtained in Local Security Authority Subsystem Service (LSASS) memory, Remote Desktop Protocol (RDP) memory, DC NTDS databases, sniffing network traffic in deprecated environments, or by first performing a DCSync attack.
- The NT-Hash is stored within LSASS process memory for each user logged in.
- The hash is also retained by RDP servers in memory until a user logs out of an RDP session, but it remains in memory if the user simply disconnects, which is why it is important to train users to fully log out of RDP sessions, if used in the mission network environment.
- The NT-Hash can also be obtained by a DCSync attack, which manipulates a DC into syncing its store of hashes with a threat actor impersonating a different DC.
- When a user is normally authenticating to a remote system, the following events are generated in the local Security Log:
  - **4648**: A logon was attempted using explicit credentials
  - **4624**: An account was successfully logged onLogon type = 2
  - **4672**: Special privileges assigned to new logon
- However, when a stolen NT-Hash is used for remote authentication, the logging is slightly different:
  - **4648**: A logon was attempted using explicit credentials
  - **4624**: An account was successfully logged onLogon type = 9 Logon Process = Seclogo
  - **4672**: Special privileges assigned to new logonLogged on user, not impersonated user

#### Mitigations for PtH Attacks
- In addition to the general mitigations already described, employing proper User Account Control can mitigate the effect of compromise in the event that a threat adversary does gain access to the hash of a machine with administrative privileges.

#### MITRE ATT&CK Technique M1052 — User Account Control	
- Enable PtH mitigations by applying User Account Control (UAC) restrictions to local accounts on network logon. This can be enforced through GPO.

### Windows Authentication Attacks, Audits, and Mitigations | Steal or Forge Kerberos Tickets
#### Pass the Ticket Attack Overview
- Kerberos tickets can also be stolen from the LSASS process memory in the same way that NT-Hashes can.
- Once stolen, threat adversaries may use the captured TGS tickets or TGTs to move laterally within an environment.
- This technique allows authentication to a specific resource without requiring the plaintext account password.
- Of the two, TGTs allow a threat actor to request a wider range of accesses in a network, but also require higher administrative privileges to steal.

#### Forge Kerberos Tickets Attack Overview
- Golden Ticket attacks can be carried out against AD domains where access control is implemented using Kerberos tickets issued to authenticated users by a KDS.
- The attacker gains control over the domain’s KRBTGT account by stealing its NTLM hash.
- This allows the attacker to generate TGTs for any account in the AD domain.
- With valid TGTs, the attacker can request access from the TGS to any resource/system on its domain.
- Because threat actors are controlling the component of the access control system that is responsible for issuing TGTs, they have the golden ticket to access any resource on the domain.
- Silver Ticket attacks are very similar, but instead of controlling the KDC account, the attacker controls a domain service account, and is able to use that access to craft Service Tickets for that service at will. 

#### Audit for Stealing or Forging of Kerberos Tickets
- In order to detect attacks on Kerberos authentication, configure auditing for anomalous Kerberos activity, such as malformed or blank fields in Windows logon/logoff events, which are found in Security Log event IDs **4624**, **4672**, **4634**.
- Golden ticket attacks often appear as TGS requests without preceding TGT requests, so auditing for the standalone requests can reveal this attack in progress.
- Monitor for unexpected processes, such as the credential dumping tool Mimikatz, interacting with lsass.exe process memory, as decrypting some sections in its memory can reveal Kerberos tickets for use in Pass the Ticket attacks, or hashes for forging new tickets.
- The method of monitoring for Sysmon event ID 10 — which reveals this type of access — has been discussed previously.
- It is also important to monitor for unexpected lifetimes of TGTs granted by the AS.
- By default, Mimikatz sets the expiration of forged Golden Tickets to 10 years.
- In contrast, the best practice recommended by Microsoft for a TGT lifetime is 10 hours. When not defined otherwise, this is the default maximum lifetime in supported versions of Windows.
- When a threat actor employs a Kerberos golden ticket after the KRBTGT password has been reset twice - as mentioned in the Mitigation section - a Security Log event ID **4769** is generated on the DC.
- The status code 0x1F indicates the action has failed due to Integrity check on decrypted field failed and indicates misuse by a previously invalidated golden ticket.

#### Mitigations for Kerberos Ticket Attacks

#### MITRE ATT&CK Technique M1015 — AD Configuration
- If a domain compromise is suspected through auditing which indicates that a golden ticket has been created, an analyst or network maintainer can contain the impact of adversary access by resetting the KRBTGT account password twice.
- This will invalidate any existing golden tickets created with the old KRBTGT NT-Hash.
- Regularly rotating this account password is a valuable practice even when a compromise is not suspected. The STIG guidance for this rotation is every 180 days.

#### MITRE ATT&CK Technique M1041 — Encrypt Sensitive Information	
- Enable AES Kerberos encryption, rather than DES or RC4, where possible. This can be enforced through GPO.

#### Pre-Authentication
- Pre-Authentication provides a mechanism for the Authentication Server to identify who the principal (user or system being authenticated) is before it issues a Kerberos AS_REP message.
- This prevents certain types of known attacks on Kerberos.
- From the Microsoft technical guidance:
  - **_By default, the KDC requires all accounts to use pre-authentication. This is a security feature that offers protection against password-guessing attacks. The AS request identifies the client to the KDC in plain text. If pre-authentication is enabled, a timestamp is encrypted using the user’s password hash as an encryption key. If the KDC reads a valid time when using the user’s password hash, which is available in the AD, to decrypt the timestamp, the KDC knows that request is not a replay of a previous request_.**
- Since enumeration of AD accounts may result in failed login attempts for accounts in which pre-authentication is disabled, Kerberos logon events should be audited, and the enforcement of such auditing is capable through the GPO.
