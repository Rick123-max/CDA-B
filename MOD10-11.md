# MODULE 10

## SWITCHING

### Introduction to Switching
- Switches operate at Layer 2 of the OSI model
  - **1 Broadcast Domain and collision domains equal to number of open ports**
- These devices are responsible for both the physical connection between devices as well as forwarding data frames received to the next recipient on the same network
- Traversal between networks is handled on Layer 3 of the OSI model
- This lesson uses the terms **frame**, **data frame**, or **ethernet frame** when referring to a discrete piece of data transmitted over Layer 2, and **packet** when referring to Layer 3 or higher equivalents.
- The same piece of data may be described as a frame, packet, or datagram depending on the context.

#### OSI Model
- The OSI Model consists of seven layers, shown in this chart:

<img width="552" height="732" alt="image" src="https://github.com/user-attachments/assets/3799f1e6-8572-486f-823c-7c0c8c80d8b4" />

- Layer 2 of the OSI model — the **Data Link layer** — handles addressing ethernet frames to direct communication between hosts on the same Local Area Network (LAN)
- Ethernet frames include Layer 2 addressing with vendor-assigned unique source and destination addresses for segments.
- In addition, ethernet commonly uses MAC addresses for communication on a segment.
- Other Layer 2 protocols — such as Frame Relay — use a completely different method of Layer 2 addressing.
- **MAC addresses are unique 48-bit addresses, separated into six octets, and noted in hexadecimal format.**
  - The first three octets — known as the Organizationally Unique Identifiers (OUI) — are assigned by the Institute of Electrical and Electronics Engineers (IEEE) to a manufacturer.
  - Each manufacturer is responsible for ensuring that the last three octets are unique for each device built.

#### Layer 2 Devices
- The simplest Layer 2 device for ethernet networks that allows multiple devices to communicate with each other is the **hub**
  - **1 Broadcast Domain and 1 Collision Domain**
- These devices broadcast all received data frames to all ports, regardless of the intended recipient.
- While these simple devices may still be found in some older networks, their usage is discouraged due to issues that they present including:
  - The broadcast behavior allows any connected device to view traffic bound for any other device on the hub.
  - Due to the rebroadcast nature of this device, transmitted frames can often collide when two connected devices attempt to send at the same time — especially during high-traffic load — causing dropped frames or retransmissions.
- Like hubs, switches allow for connectivity between devices; however, unlike hubs, switches utilize logic to determine which ports to forward frames onto
- Basic switches exist that perform only the bare minimum of switching to ensure that collisions do not occur frequently and ensure basic addressing.
  - These switches — sometimes referred to as **unmanaged switches** — can be found in small business and home networks and even see use in enterprise networks
- However, **managed switches** are typically utilized in enterprise networks, especially for central connectivity within the network.
  - These switches are able to be configured and support more features — such as the ability to **mirror ports**, **create VLANs** to segregate networks, etc.

#### Collision Domains
- When ethernet was introduced, it started leveraging technologies such as **Thinnet (10Base-2)** and **Thicknet (10Base-5)** coaxial cables as a transmission medium, in which devices connected to the medium with **Vampire Taps** or **T connectors**
- To mitigate the impact collisions have on a network, ethernet uses **Carrier Sense Multiple Access/Collision Detect (CSMA/CD)** to guarantee that only one host transmits at any given time in a collision domain
- If two hosts transmit at the same time, and the transmitting host senses that another host is also transmitting, it stops transmitting the frame, sends a jam signal, and waits a random time interval before attempting to retransmit the frame
- This means that hosts can either transmit or receive data at one time (operate at half-duplex).
- Network switches introduced stability and scalability in networks by creating virtual communication channels
  - To create these channels, switches maintain a table that associates a host's MAC addresses to the port to which the host is connected.
  - Instead of flooding traffic out of every switch port, a switch uses the MAC address table to forward traffic only to the switch port associated with the destination MAC address.
  - The process of delivering traffic directly to the DMAC drastically reduces the size of the collision domain between the devices enabling hosts to transmit and receive data simultaneously (full-duplex).

### Configuration File Overview

#### Cisco Devices
- Cisco devices tend to have several different methods for an administrator to connect to them.
- The most common methods follow:
  - Direct connection to the console via the **console** or **Auxiliary (AUX) port**.
    - This is generally a **serial port** connection and often requires the included **Registered Jack (RJ)-45 to Recommended Standard (RS)-232 cable** to connect to.
    - The screen command or a terminal emulator can be used on Linux, while **PuTTY** or other terminal connection software is common on Windows.
  - Connection to a virtual console, typically via **Secure Shell (SSH) or Teletype Network (Telnet)**.
    - **Telnet** is generally discouraged because its traffic is transmitted in plaintext.
    - Binaries for SSH are available or commonly included on Linux systems and modern builds of Windows — though, **PuTTY** is still commonly used on Windows.
  - Many modern Cisco devices also include web interfaces for viewing the status of and managing the device.
    - These interfaces can be interacted with using standard browsers.

#### Cisco Security Model
- First connection to a Cisco Switch will show something similar to `hostname>`
- The **enable** command can be used to **raise privilege levels to 15**, and the **disable** command can be used to **lower the privilege levels to 1**.
- An **enable password** can be configured to **require a password** in order to raise the privilege level
- The basic security model for Cisco devices consists of three privilege levels:
- Zero (0)
  - Privilege level 0 is the **lowest level privilege** defined by default on Cisco devices.
  - When connected, the user only has access to these commands:
    - **disable**: Lower privilege level
    - **enable**: Raise privilege level
    - **exit**: Close the current session
    - **help**: Interact with the help system
    - **logout**: Close the current session
  - These commands only allow leaving the session or attempting to increase or decrease the privilege level.
- User (1)
  - At this level — in addition to the above commands — some additional utilities are available for troubleshooting connectivity, such as the **traceroute** and **ping** commands.
  - In addition, some configurations can be viewed via **show** commands.
  - No configuration changes can be made at this level.
- Privileged (15)
  - Privilege level 15 is the highest level defined by default on Cisco devices. At this privilege level, all commands are available, and the device can be configured.

#### Cisco Config Mode
- To make changes to the current configuration of the device, the **configure terminal** command must be used.
- For this command to be used, the current privilege level must be 15. As the configuration is navigated, the prompt changes to indicate what is currently being configured:

  ```
  Hostname#configure terminal
  Hostname(config)#interface GigabitEthernet0/0
  Hostname(config-if)#
  Hostname(config-if)#end
  Hostname#
  ```
  - In addition, you can completely leave via the **end** command
- Configuration sections are separated by exclamation points (!) for readability, which are for formatting and display purposes only.
- An example configuration file (trimmed) follows:

  ```
  version 15.2
  service timestamps debug datetime msec
  service timestamps log datetime msec
  no service password-encryption
  service compress-config
  !
  hostname Switch
  !
  !
  !
  no aaa new-model
  !
  !
  !
  ip cef
  login on-success log
  no ipv6 cef
  !
  !
  !
  spanning-tree mode pvst
  spanning-tree extend system-id
  !
  vlan internal allocation policy ascending
  !
  !
  !
  interface GigabitEthernet0/0
   media-type rj45
   negotiation auto
  !
  interface GigabitEthernet0/1
   media-type rj45
   negotiation auto
  !
  interface GigabitEthernet0/2
   media-type rj45
   negotiation auto
  !
  interface GigabitEthernet0/3
   media-type rj45
   negotiation auto
  !
  interface GigabitEthernet1/0
   media-type rj45
   negotiation auto
  !
  interface GigabitEthernet1/1
   media-type rj45
   negotiation auto
  ip forward-protocol nd
  !
  interface GigabitEthernet1/2
   media-type rj45
   negotiation auto
   shutdown
  ip forward-protocol nd
  !
  interface GigabitEthernet1/3
   media-type rj45
   negotiation auto
   shutdown
  ip forward-protocol nd
  !
  no ip http server
  no ip http secure-server
  !
  !
  !
  control-plane
  !
  !
  line con 0
  line aux 0
  line vty 0 4
  !
  !
  end
  ```
- Breakdown of the sections is as follows:
  ```
  version 15.2
  service timestamps debug datetime msec
  service timestamps log datetime msec
  no service password-encryption
  service compress-config
  ```
  - This section covers the version of the device, as well as some services that are configured:
    - **version**: Indicates the Cisco Internetwork Operating System (IOS) version for this device
    - **service timestamps**: Determines how timestamps for debug and log entries are displayed
    - **service password-encryption**: Automatically encrypts passwords when a new password is saved; no variant of the command means this is disabled
    - **service compress-config**: Configuration is compressed automatically by this service

  ```
  hostname Switch
  no aaa new-model
  ```
  - **hostname**: Sets the hostname for this device; shown in the command-line by default, may also be discovered by this name, or respond with this name during network discovery
  - **aaa new-model**: Authentication, Authorization, and Accounting (AAA); disabled, this device does not support AAA features, such as user accounts, user levels, or command-level logging as handled by the AAA feature

  ```
  ip cef
  no ipv6 cef
  ```
  - Enables Cisco Express Forwarding (CEF)

  - ```login on-success log```
    - Any successful login is logged to the console

  ```
  spanning-tree mode pvst
  spanning-tree extend system-id
  !
  vlan internal allocation policy ascending
  ```
  - These configurations are related to VLANs, which are covered later in this lesson:
    - **spanning-tree mode**: Determines the method used for Spanning Tree Protocol (STP)
    - **vlan internal allocation policy**: Specific VLANs reserved for internal use — determines where these VLANs begin enumerating (ascending starts at VLAN Identifier [ID] 1006 and up, descending at 4095 and below)

  ```
  interface GigabitEthernet1/3
  media-type rj45
  negotiation auto
  shutdown
  ```
  - Only one interface is covered here, as the others are nearly identical. 
    - **interface**: GigabitEthernet1/3 here indicates that this device is detected as a gigabit ethernet interface (as opposed to FastEthernet for 100 megabit ethernet) in slot zero, port zero; each internal slot may or may not contain multiple ports, depending on the interface card
    - **media-type**: RJ-45, Small Form-factor Pluggable (SFP), or Auto
    - **negotiation auto**: Attempts to automatically negotiate speed and duplex settings with the connected device.
    - **Shutdown**: Port is administratively disabled, ensuring that the port is not usable

  ```
  no ip http server
  no ip http secure-server
  ```
  - No web confg is enabled

- ```control-plane```
  - Control plane being enabled allows this device to have policies enabled that deal with Quality of Service (**QoS**), as well as mitigation of Denial of Service (**DoS**) and reconnaissance techniques

  ```
  line con 0
  line aux 0
  line vty 0 4
  ```
  - These configuration lines detail the settings used for connecting to the device:
    - **line con**: First — and typically only — serial console is enabled for this device; no configurations have been set beyond default settings
    - **line aux**: First — and typically only — AUX port is enabled for this device; no configurations have been set beyond default settings. Traditionally, the AUX port was often used for remote modem connections.
    - **line vty**: Five (0, 1, 2, 3, 4) virtual terminals (used for SSH or Telnet) are enabled. Unlike con and AUX ports, these are not physical.

### Packet Switching Logic
- Switches control which devices to forward frames to via algorithms known as Packet Switching
- Switches maintain an internal database of MAC addresses — **MAC address table or Content Addressable Memory (CAM) table** — that maps each known **MAC address** to a specific **port** on the switch, allowing the switch to determine the best port to forward onto.
- The switch analyzes the incoming frame, and then forwards it based upon the addressing type, such as:

<img width="802" height="435" alt="image" src="https://github.com/user-attachments/assets/61fdb359-f455-4d12-9c60-0b1af62b6be1" />

  - **Unicast**
    - **Single source** to **single destination**. If the MAC address is not in the switch’s MAC address table, then the forwarding of the frame is treated the same as broadcast. Otherwise, the frame is sent to the device if directly connected, or forwarded to the next switch closer to the destination device.

<img width="808" height="444" alt="image" src="https://github.com/user-attachments/assets/627bb4df-8923-4ab1-ae4f-1ff1bba29e66" />

  - **Broadcast**
    - **Single source** to **all devices on the LAN**. This floods the entire network, sending the frame to all other active ports — any receiving switch is also sent the frame to each connected device as well.
    - Any frames sent to FF:FF:FF:FF:FF:FF are broadcasted.

<img width="808" height="444" alt="image" src="https://github.com/user-attachments/assets/fd3528e8-8f16-4391-97ba-154bd6b7f85a" />

  - **Multicast**
    - **Single source** to **multiple devices**. Clients must subscribe to receive frames that are multicasted.
    - Switches learn which devices are subscribed using Internet Group Management Protocol **(IGMP) snooping** or via proprietary protocols or other means.
    - If the switch is **unable to learn** which devices are subscribed, **multicast frames** are treated as **broadcast frames**.
- **Note** that for **multicast and unicast** to not act like broadcast addressing, the switch needs to be able to maintain information about the network, such as subscriptions for multicast and MAC address tables for unicast.

### Port Configs and Virtual LANs
- Misconfigured switches can enable attackers to perform attacks such as **VLAN Hopping**

#### Link Aggregation
- Link Aggregation allows for multiple ports to be combined into a single, logical, port for **performance** and **stability** reasons
- It requires configuration on both the device and the switch the device is connected to.
- Link Aggregation can improve maximum bandwidth by allowing network traffic flow to travel among multiple ports with little configuration required for other devices on the network
- Configuration is typically either handled using **Link Aggregation Control Protocol (LACP)** or via **static configuration**.

#### Port Staus
- Unused ports should generally be disabled, which is accomplished via **shutdown** configuration when applied to an interface on Cisco devices.
- In addition, unused ports can be directed to a separate `quarantine VLAN`, which can be accomplished — on Cisco switches — with the `switchport mode access` command and assigned to the quarantine VLAN with the `switchport access VLAN <vlan-id>` command.

#### Port Security
- Also known as whitelisting, switch ports can have configurations applied to them that restrict traffic only to known sources.
- By restricting traffic to known MAC addresses, this feature can increase the security of the network as well as mitigate some types of attacks.

#### VLANs
- VLANs separate a physical network into logical network segments — each port assigned to a VLAN can communicate with each other as though they were all connected to a single logical switch while being isolated from any other VLANs from a Layer 2 perspective.
- VLANs are defined in the **IEEE 802.1Q** standard, which states that **32 bits are allocated in the ethernet packet header for the following fields**:
  - **Tag Protocol Identifier (TPID)**: 16-bit field set to 0x8100 to identify the 802.1Q packet
  - **Priority Code Point (PCP)**: 3-bit Class of Service (CoS) field; assigned to Layer 2 QoS between switches
  - **Drop Eligible Indicator (DEI)**: 1-bit field indicating whether the packet can be dropped when insufficient bandwidth is available on a link; when identified, indicates the potential use of Voice over IP (VoIP) traffic
  - **VLAN ID**: 12-bit field specifying the VLAN associated with a network packet
- VLANs can be used to segregate or isolate network segments, which can have many benefits such as enhancing performance by limiting the range of broadcasts or improving security by helping control access to sensitive machines or data. VLAN traversal happens via routing on Layer 3 — so-called Layer 3 switches are able to control and allow machines on different VLANs to communicate with each other in a manner managed by the switch.

#### Trunk Ports
- Managed switches connected to each other physically can designate those ports as trunk ports
- Trunk ports are able to carry traffic designated for VLANs on other connected switches
- Trunk ports can limit allowed VLANs through the trunk, which can be useful for physically segmenting VLAN IDs, or limiting the physical reach of specific VLANs.
- On Cisco switches, Dynamic Trunking Protocol (DTP) is a proprietary protocol that can be used to automatically negotiate trunk ports between connected switches.
- While convenient, if enabled for ports not intended to connect to other trunk ports, this can lead to insecure configurations if an attacker is able to spoof a switch in order to negotiate trunk ports.

#### Access Port
- **Access ports** are the foundational building blocks of managed switches; each access port can only be **assigned to one VLAN**.
- **Access ports** carry traffic from the configured VLAN to the device connected or to other devices on the same VLAN on that switch.
- **Packets received or transmitted** on access ports **do not carry 802.1Q tags**.
- By default, **switches assign all unconfigured ports to VLAN 1**.
- For Cisco switches, the ports can be manually configured as access ports with the `switchport mode access command` and assigned to a VLAN with the `switchport access VLAN <vlan-id>` command.

#### Private VLAN
<img width="602" height="402" alt="image" src="https://github.com/user-attachments/assets/6e8f76c5-f94b-4b43-9e09-2bec6eadc054" />

- Private VLANs further subdivide VLANs, allowing for isolation of devices within a VLAN from each other.
- When assigning a private VLAN to a port, in addition to the primary VLAN, a community VLAN ID is required.
- Three types of private VLAN ports exist:
  - **Promiscuous**: Typically reserved for routers or other gateway devices, these ports can receive traffic from any of the ports in a VLAN, regardless of the private VLAN configurations of those devices.
  - **Isolated**: Only able to communicate with promiscuous ports, these ports are isolated from all other ports. However, communication with the primary VLAN is possible.
  - **Community**: Able to communicate with promiscuous ports and other community ports on the same community VLAN. Additionally, community ports can communicate with the primary VLAN.
- Allows for isolation of devices without using up VLANs to do so.

#### Native VLANs
- The **802.1Q** standard states that any **traffic transmitted or received** on a **trunk port without an 802.1Q VLAN tag** is associated with the **native VLAN**.
- The default native VLAN for most switch vendors is VLAN 1.
- All switch control plane traffic is switched across the network using VLAN 1.
- Change this VLAN to a super high number (999)
- For a stable trunk to be established between switches, the native VLAN should match at both ends, or traffic can unintentionally change VLANs.
- For example, this configuration practice could mean that when a switch has a host connected to a trunk port with native VLAN 10, the host could communicate with hosts connected to access ports assigned to VLAN 10.
  - This occurrence is called VLAN Leaking and can be leveraged by threat actors to capture traffic across broadcast domains.
- Defining the native VLAN is a port-specific configuration and can be changed with the `switchport trunk native VLAN <vlan-id>` interface command.

#### Management VLANs
- As part of the network segmentation efforts to improve the security of a network, many network designs include a dedicated management VLAN — arbitrarily assigned amongst the available pool of VLANs.
- In switches, this is accomplished by assigning this VLAN to an internal interface.
- Special care is often taken or suggested with this VLAN, such as designing the connectivity of this VLAN to ensure that no connection loops exist.
- If a switch is misconfigured or misbehaving and STP is not able to resolve a loop, losing access to the management VLAN can greatly complicate recovery efforts.

#### Restricting VLANs
- VLANs can be restricted from trunk ports for security reasons or as a method of traffic engineering.
- The interface `switchport trunk allowed VLAN <vlan-ids>` command defines the VLANs that can traverse the link. 

### Practical Implications
- Some examples of attacks that rely on the behavior of switches or misconfigurations follow:
  - **MAC Flooding**: This attack relies on switches having a limited amount of memory for storing the MAC address table.
    - Due to the inability to store updates to this table, many switches failover to broadcast mode for all data frames — similar to network hubs.
    - This allows an attacker physically attached to a switch to view all traffic passing through the switch, rather than just traffic intended to be bound for that machine.
  - **MAC Spoofing**: This attack merely has the attacker present a different MAC address to the switch than the actual hardware MAC.
    - This can be done for various reasons, such as **bypassing MAC filters**, **masquerading** as a legitimate device, or **evading information gathering** by masquerading as a different device.
  - **VLAN Hopping**: This attack allows the attacker to view or transmit to or from VLANs that would normally not be permitted.
    - Since VLANs are often used for isolation, this may allow an attacker to view or communicate with sensitive machines.
  - **ARP Poisoning**: While technically a Layer 3 attack, mitigation is often the responsibility of switches on the network.
    - This attack allows an attacker to falsify ARP tables by sending forged packets, which causes clients to forward packets to the wrong MAC address for a specified IP address.
    - This can be used to Man-in-the-Middle (MitM) traffic bound for a specific host — including a gateway router — to observe traffic.

#### Mitigations
- A general overview of the mitigations for each of these follows:
  - **MAC Flooding/Spoofing**: Mitigations for these attacks depend on the network configuration.
    - If MAC addresses are known, each port can be configured with a **whitelist** of each address allowed on that port.
    - Alternately, authentication in some manner — such as **AAA** or **802.1x** — can be used to ensure that only approved devices are allowed to connect to ports or wireless for Wireless Fidelity (Wi-Fi) switches.
  - **VLAN Hopping**: VLAN hopping can be mitigated via appropriate port configurations.
    - Enforcing correct settings here involves ensuring that **client ports are set to access only**, **disabling trunk auto-negotiation** on client ports, and **ensuring that the native VLAN** for client ports is **set to an inaccessible VLAN**.
    - More details about these attacks and their mitigations are covered in the VLAN Attacks and Defenses lesson.
  - **ARP Poisoning**: ARP Poisoning attacks can be mitigated in several ways, depending on the network and its configuration.
    - Mitigating these attacks generally involves switch and/or router configuration.
    - Wi-Fi-based mitigation can be accomplished via:
      - **client isolation**: which prevents Wi-Fi clients from sending ARP packets to each other;
      - **wired-based mitigation** can involve **rate-limiting**, **manually binding important IP addresses to specific ports**, or **using vendor-specific, anti-spoofing technology** that validates ARP packets by validating against known hosts and blackholing unknown hosts that attempt to duplicate IP addresses.

### Layer 3 Forwarding
- A Layer 3 switch — also known as a **multilayer** switch — is any switch **capable of forwarding packets on Layer 3 as well as frames on Layer 2**
- These switches are able to route packets between discrete network segments, in a manner similar to routers
- They are distinguished from routers by their features — focusing on providing network connectivity with little overhead and often missing some of the more advanced Layer 3 features, such as Network Address Translation (NAT)
- Data starts at Layer 7 and works its way down to Layer 1; in this progression through the layers, some of the Layer 3 forwarding logic happens before Layer 2 forwarding.
- Switches typically have two methods for forwarding Layer 3 packets:
  - Forwarding traffic to hosts on the same subnet
  - Forwarding traffic to hosts on a different subnet

#### Local Network Forwarding
- Two hosts on the same IP subnet communicate locally. As the data of the transmitting host is encapsulated with its IP address, the device recognizes that the destination host is on the LAN segment
- However, the host still needs to encapsulate the Layer 2 information with its own MAC address and the MAC address of the destination to the packet
- It knows its own MAC address, but initially, it does not have the destination's MAC address
- This is where the ARP table is used to map Layer 3 IP addresses to Layer 2 MAC addresses and store the mapping.
- Next, the transmitting host uses the ARP table to add the appropriate Layer 2 headers with the destination's MAC address to the data packet before sending it down to Layer 2 for processing and forwarding.
- The ARP table is built over time and contains information on devices that the local host has recently communicated with on the same IP network segment

#### Packet Routing
- Packets must be routed when two hosts are on different networks. As the data is processed at Layer 3, it is encapsulated with its IP address; the host then detects that its destination is on a different IP subnet and must be routed.
- Next, the host checks its local routing table to find its next-hop IP address, which the host learned in one of several ways:
  - From a static route entry
  - A configured default-gateway
  - From routing protocols

<img width="1111" height="284" alt="image" src="https://github.com/user-attachments/assets/a2a4dc6a-6a16-4aad-b638-78676eb1a850" />

#### IP Address Assignment
- On Layer 3 switches (L3 switch) and routers, IPv4 addresses are assigned with the `ip address ip-address subnet-mask` interface command.
- When a switch interface is configured with an IP address and is online, the L3 switch adds the connected network into its routing table — also referred to as the **Routing Information Base (RIB)**.
- Directly-connected networks have an **Administrative Distance (AD) of 0**.

#### Switched Virtual Interfaces
- Cisco switches allow assigning IP addresses to a Switched Virtual Interface (**SVI**) — also referred to as a **VLAN interface**.
- An **SVI** is set up by configuring the VLAN on the switch and defining the VLAN interface with the interface `VLAN <vlan-id>` command.
- For the SVI to become operational (up-state), the switch must have an interface on that VLAN in an up-state.
- If the switch is a multilayer switch, multiple SVIs can be configured to route packets between VLANs, thus eliminating the need for an external router.
- Example Config:

  ```
  S1#configure terminal
  Enter configuration commands, one per line. End with CNTL/Z.
  S1(config)#interface Vlan 40
  S1(config-if)#ip address 172.16.22.1 255.255.255.0
  S1(config-if)#no shutdown
  S1(config-if)#interface vlan 45
  S1(config-if)#ip address 192.168.99.1 255.255.255.0
  S1(config-if)#no shutdown
  ```

#### Routed Switch Ports
- With the flexibility that multilayer switches provide in today's enterprise network environments, it is common for network architects to include point-to-point links between switches for routing
- Administrators can now convert Layer 2 switch ports to Layer 3 routed ports using the `no switchport` interface command on multilayer switches and assign an IP address to the interface, as seen in the example configuration below:

  ```
  S1#configure terminal
  Enter configuration commands, one per line. End with CNTL/Z.
  S11(config)#int gi1/0/14
  S1(config-if)#no switchport
  S1(config-if)#ip address 10.20.20.1 255.255.255.0
  S1(config-if)#ipv6 address 2001:db8:20::1/64
  S1(config-if)#no shutdown
  S1(config-if)#end
  S1
  ```

### MAC Address Tables
- The MAC address table — also known as a CAM table — on a switch contains information about which port each known MAC address is associated with.
- These tables often have a limited amount of memory and are typically refreshed often

#### Mapping Networks Using MAC Address Tables
- On Cisco-managed switches, the show mac address-table command can be used to view the MAC address table.
- Sample output is provided below:

<img width="383" height="185" alt="image" src="https://github.com/user-attachments/assets/ca7490c1-9dca-49d5-91f6-b8a9c47b4b12" />

- From here, a network map can be started.
- If a hardware list is available, MAC addresses can be compared to known addresses, otherwise, some assumptions might need to be made.
- Any assumptions made can be validated later with more commands or physical inspection of the hardware.

### Spanning Tree Protocol
- The STP allows switches to become aware of other switches on the network through the advertisement of Bridge Protocol Data Units (BPDU).
- STP builds a Layer 2, loop-free topology by temporarily blocking traffic on redundant ports.
- It operates by selecting a specific switch as the best switch and running a tree-based algorithm identifying which redundant ports should not transmit network traffic.
- STP has multiple versions:
  - **802.1D**: The original version
  - **PVST**: Per-VLAN Spanning Tree
  - **PVST**+: Per-VLAN Spanning Tree Plus
  - **RSTP**: 802.1W Rapid Spanning Tree Protocol
  - **MST**: 802.1S Multiple Spanning Tree Protocol
- Modern switches support PVST+, RSTP, and MST.
- All three versions are backward compatible with 802.1D as well.

#### IEEE 802.1D
- The original STP is from IEEE's 802.1D standards and supports ensuring a loop-free topology for one VLAN.
- Port States
  - In the 802.1D STP protocol, ports transition through the following states:
      1. Disabled: The port is in an administratively disabled configuration (shut down).
      2. Blocking: The state right after the switch port is enabled. The port does not forward any traffic, which ensures that no loop is created. The switch in this state does not modify the MAC address table, and it only receives BPDUs from other switches.
      3. Listening: The switch port has transitioned out of the blocking state and sends/receives BPDUs. At this point, it cannot transmit any other network traffic. The duration of the listening state correlates to the STP forwarding time.
      4. Learning:  While the switch port is in this state, the switch can modify the MAC address table with traffic that it receives. The switch port — up to this point — only forwards BPDUs. The duration of the learning state correlates to the STP forwarding time.
      5. Forwarding: The switch can update the MAC address table, and the switch port can forward all network traffic. During normal operations, the switch port stays in the forwarding state.
      6. Broken: The switch has detected a problem on a port that can have a significant impact. The port drops packets as long as the situation persists.
  - NOTE: Configured with the default timers, the entire 802.1D STP initialization from Blocking to Forwarding takes about 50 seconds.

- STP Types
  - The 802.1D STP standard defines three port types:
    - Root Port (**RP**): Each VLAN should only have one associated RP on a switch.
      - The **RP** is a switch port that connects directly to the root bridge or an upstream switch in the spanning-tree topology.
    - Designated Port (**DP**): There should be only one active designated port on a link.
      - A **DP** is a switch port that receives and forwards BPDU frames to other switches and connects to downstream devices and other switches.
    - **Blocking port**: A port that is not forwarding traffic because of STP calculations.

- STP Terminology
  - There are several key terms related to the STP:
    - **Root bridge**: Most critical switch in the Layer 2 topology. All **switch ports** are in a **forwarding state**. Therefore, the **Root Bridge** is considered the **top of the spanning tree** for all path calculations by other switches.
    - **BPDU**: A **BPDU default DMAC** is the **multicast address 01:80:c2:00:00:00**. They are used by switches to build and notify of changes in the STP topology.
      - Two types of BPDUs exist:
        - **Configuration BPDU**s: Used to identify the **root bridge**, **root ports**, **designated ports**, and **blocking ports**.
          - The **configuration BPDU** contains the following fields:
            - **root path cost**
              - Combined cost of a specific path to the root switch.
            - **root bridge identifier**
              - Combination of the **root bridge system MAC address**, **system ID extension**, and **system priority**.
              - Represented as system priority value added to the system ID extension value and resulting value concatenated with the root bridge system MAC address.
            - **local bridge identifier**
              - Combination of the **local switch's bridge system MAC address**, **system ID extension**, and **system priority**.
              - Represented as system priority value added to the system ID extension value and resulting value concatenated with the root bridge system MAC address.
            - **max-age**
              - With a default value of **20 seconds**, this is the time threshold before a bridge port saves its BPDU information.
              - If a switch loses contact with the switch that originated the BPDU, the BPDU is still valid until the Max-Age timer expires.
            - **hello time**
              - Interval in which a BPDU is transmitted out of a port. The Hello Time default value is two seconds, though the value can be configured anywhere between 1–10 seconds.
            - **forward delay**
              - Interval a port stays in the listening and learning states. The Forward delay default value is 15 seconds, though this value can be configured to a value between 4–30 seconds.
            - **STP type**.
        - **Topology Change Notification (TCN) BPDU**: Used to notify other switches of the Layer 2 topology changes.
    - **System priority**: A 4-bit value with a default value of 32,768. Determines the priority for a switch to be the root bridge.
    - **System ID extension**: A 12-bit value indicating the VLAN that a BPDU belongs to. The system priority and ID extension combine to form the switch's root bridge identification  

- STP Cost
  - The STP interface cost is a critical component for calculating the path to the root switch because the root path is found calculating the sum of the interface STP costs to reach the root bridge.
  - The STP interface cost was initially stored as a **16-bit value** with a reference value of **20 Gb/s**.
  - However, as switches have developed with higher-speed interfaces, **10 Gb/s** might not be enough.
  - Therefore, another method was developed, called **Long-Mode**, which uses a **32-bit value** with a reference speed of **20 Tb/s**. In current switching Operating Systems (OS), the **default mode** continues to be the **Short-Mode**.  

<img width="1954" height="1058" alt="image" src="https://github.com/user-attachments/assets/eabd5eeb-4191-433e-bec5-4f28cc098bb3" />

#### Building STP Topology

<img width="2414" height="1012" alt="image" src="https://github.com/user-attachments/assets/5d674836-63b1-4ff2-9db5-e154c877c7d8" />

- STP Root Bridge - Election
  - The first goal for STP is to identify the root bridge in the topology.
  - As a switch OS comes online, it assumes that it is the root bridge, and proceeds to use its local bridge ID as the root bridge ID.
  - Then it listens to its neighbors' configuration BPDUs by following these two steps:
    - If the neighbor's system Root Bridge Identifier is a higher value than its own, the switch ignores that BPDU and continues to see itself as the root bridge.
    - If the neighbor's system Root Bridge Identifier is a lower value than its own, the switch updates its own BPDUs to include the new root bridge ID and a new root path cost related to the total path cost to reach the new root bridge.
    - This process continues until all switches in the network have identified the root bridge switch.
  - STP considers a switch more preferable if the priority in the bridge ID is lower than the priority of the other switch's configuration BPDUs.
  - However, if the priority is the same, the switch prefers the BPDU with the lower system MAC.
  - Verify the show spanning-tree root output on SW2 and SW3. The Root ID field is the same as SW1, but the root path cost has changed to 4 because both switches use a 1 Gbps uplink to reach SW1.
  - In addition, interface Gi0/0 has been identified on both SW2 and SW3 as the root port.

    <img width="753" height="500" alt="image" src="https://github.com/user-attachments/assets/ea714541-b9f6-4837-a537-0f2e2061d1cb" />

- Locating Root Ports
  - The root bridge continues to transmit configuration BPDUs out of all its ports. The other switches compare the BPDU information to identify the RP.
  - The RP is selected following the below logic (where the next criteria are used to break a tie):
    1. The interface associated with the lowest path cost is the most preferred.
    2. The interface associated with the lowest system priority of the advertising switch is preferred next.
    3. The interface associated with the lowest system MAC address of the advertising switch is preferred next.
    4. When multiple links are associated with the same switch, the lowest port priority from the advertising switch is preferred.
    5. When multiple links are associated with the same switch, the lower port number from the advertising switch is preferred.

### Intro to Traffic Capture
- Terminal Access Point (TAP) devices as well as on-device traffic capture or redirection features (port mirroring) allow for full packet capture
- The full PCAP provided by such methods is received by a CPT Security Information and Event Management (SIEM) solution, in which a variety of force-multiplying tools, such as Zeek and Suricata, are employed for further analysis in threat hunts or mission partner security posture compliance

#### Network Taps
- A **TAP** — sometimes called a **Test Access Point** — is an **external device** inserted at a certain point in a network to conduct **monitoring** by **intercepting or mirroring**, and then **duplicating network traffic** to a **monitoring node** or **network** **without disrupting** the original **traffic**
- These devices permit TAPping a network, or multiple networks, to collect traffic for analysis through the tool stack.
- This can be accomplished in two ways — **in-band** and **out-of-band**. When deploying a kit to the mission network, **out-of-band** is the easiest way to set up a TAP with minimal changes and impact.
- In-Band TAP
  - Setting up in-band — or inline — ensures no traffic is lost when dealing with a switch/router that has a larger traffic throughput
  - The network TAP is placed in line with the communication chain of the network
  - The downside to implementing the TAP this way, however, is that the link between two devices needs to be disconnected in order for a TAP to be placed inline between them.
  - Some devices allow the TAP to be put in place as fail open so there is no network interruption in case of a power loss or hardware failure.

<img width="520" height="449" alt="image" src="https://github.com/user-attachments/assets/57982916-8900-4ec9-97be-81713d9581bb" />

- Out-of-band TAP
  - Operating out-of-band, the TAP/stack operates on its own network, receiving the mission network's traffic via one or more Switched Port Analyzer (**SPAN**) ports from devices on the network.
  - A downside to running out-of-band, however, is that SPAN ports can become **overwhelmed** in some circumstances.
  - For instance, if traffic flow exceeds the capacity of the SPAN port or if the SPAN port is misconfigured.
  - There is a chance some packets are not collected if the device cannot handle the throughput for traffic collection.

#### Network TAPs vs. Port Mirroring
- It is worth considering that an ethernet TAP is not always the correct traffic capture solution.
  - The ideal method is to use a physical network TAP given enough available access and resources. This guarantees that no packets are modified prior to collection.
  - The other method is to mirror the collected interface to a network SPAN port, which directs all mirrored traffic to a collection platform.
  - Compared to the SPAN port mirroring option, a physical TAP places no additional load on a switch, as the traffic does not need to be duplicated by the switch to the SPAN port, nor does it risk the switch dropping or delaying packets due to utilization, malformation, or buffering.
  - The physical TAP also provides complete visibility into full-duplex networks, being able to read both sending and receiving data streams simultaneously.
  - The disadvantage is the potential purchase and additional installation of costly new equipment where such TAPs do not already exist.
  - For these reasons, a physical TAP is ideal in a high-traffic network environment where dropping packets is not acceptable, and the cost-to-benefit of the equipment is advisable.
- In a low-traffic network where a few dropped packets are permissible, the option to mirror a port to the monitoring device is much more cost-effective.
  - It uses already-existing capabilities in the network architecture and also captures intra-switch traffic, which a physical network TAP cannot do if placed on the network side of the switch.

#### Port Mirroring - SPAN
- Enterprise-level-managed switches can support various forms of port mirroring to enable capturing traffic from a Layer 2 perspective by replicating all frames sent or received by specific ports to another port.
- A sensor or traffic capture workstation can be placed on the port mirror to capture a copy of all frames.
- Port mirroring is useful for traffic capturing and continuous monitoring.
- There are three primary ways to mirror switch ports:
  - SPAN
    - Mirrors traffic from one or more interfaces or VLANs to another port on the same switch.
  - Remote SPAN (RSPAN)
    - Allows mirroring of traffic over Layer 2 links — meaning that the port that replicates all frames need not be on the same device as the ports being monitored.
    - The replicated data traverses a VLAN dedicated for this session, traversing any trunk ports necessary to reach the destination port that mirrors all duplicated frames.
    - This type of mirror can enable an organization to centralize packet traffic and monitoring.
  - Encapsulated Remote SPAN (ERSPAN)
    - Similar to RSPAN, but the traffic being sent to the remote device is encapsulated in Generic Routing Encapsulation (GRE) packets.
    - This enables port mirroring over Layer 3 networks, such as mirroring ports from a mission network onto kit hardware.

### Strategic TAP Placement | TAP Locations
- Determining TAP placement in the network depends on the information required to complete the objectives of the engagement.

#### Placement Considerations
- What traffic is necessary to collect?
  - If the TAP is incorrectly located, vital mission data may be omitted or unnecessary data may be collected.
  - For example, when conducting a hunt for a suspected compromise that has already penetrated external defenses, all network traffic in the internal network — behind the internal firewall — is to be collected. Placement on the External Router would be insufficient in that case.
- Does one place a TAP on the router or the switches?
  - Tapping the Internal Router, the client-to-client communications or potential lateral movement from one workstation to another would be omitted.
  - To effectively collect all the internal network traffic in this scenario, place TAPs or sensors in multiple locations.
- Is seeing what is going to the Demilitarized Zone (DMZ) or External Router important?
  - That depends on the amount of traffic flowing to the DMZ.
  - If seeing the traffic to the DMZ helps accomplish mission objectives, then it is a good idea to TAP at that location.
  - However, make sure the necessary configuration requirements and filters are in place.
- There are many elements to take into consideration when placing a TAP.
  - If placing a TAP on the External Firewall before traffic is filtered by the device, one runs the risk of collecting more information than the sensor can process.
  - Different routers and switches have their own hardware limitations that should be taken into consideration when placing a TAP.

#### Trust Boundaries
- Sensors for full PCAP should be placed at **trust boundaries**, which are _connections between trusted and untrusted networks_.
- For example, if a firewall separates a trusted intranet and the untrusted internet, then the full PCAP sensor should be mirroring or tapping that device on the internal side.
- This allows monitoring of all communication that the firewall allows from the untrusted network and all information that trusted agents inside the intranet are sending out to the untrusted network.

#### Network Address Translation (NAT)
- The other consideration in TAP or sensor placement is that if the environment employs NAT, the collection should occur on the **trusted side of translation**.
- In the scenario in which a trusted system is compromised, if only the external translated address is available for analysis, then the specific system is unknown.
- However, by collecting on the trusted side, the internal address appears in captures and allows precise analysis of compromise and any lateral movement within the network.

## Routing

### Routing Introduction
- Routers can process packets and route them in two primary ways.
  - First, they can use manually configured static routes.
    - Routers that rely only on static routes cannot perform route discovery
    - As a result, routers configured with static routes can only route packets using the paths defined by an administrator.
  - Second, routers can leverage routes calculated dynamically.
    - When using dynamic routing protocols, routers perform route discovery by exchanging information with other routers. Routers then forward packets over those routes.
- In addition to static routes, there are three categories of dynamic routing protocols.
- Here are some examples of each type:
  - Distance-vector
    - Routing Information Protocol (**RIP**)
    - Interior Gateway Routing Protocol (**IGRP**)
    - Border Gateway Protocol (**BGP**)
  - Link-state
    - Open Shortest Path First (**OSPF**)
    - Intermediate System to Intermediate System (**IS-IS**)
  - Hybrids
    - Enhanced Interior Gateway Routing Protocol (**EIGRP**)
- Link-State protocols send information about directly connected links to all routers in the network and updates consist of only those links that have changed.
- Distance vector protocols send their entire routing table to directly connected neighbors and advertise how far each defined network is from themselves.
- There are two functional classes of dynamic routing protocols: Interior Gateway Protocols (**IGP**) and Exterior Gateway Protocols (**EGP**).
  - The best way to visualize this is that IGPs are used within autonomous systems, or inside Enterprise networks, whereas EGPs operate between autonomous systems.
- Consequently, the Border Gateway Protocol (BGP — an EGP) is widely used to calculate routes across the Internet.
- Thus, from a routing perspective, the Internet can be viewed as a backbone transporting packets between a global collection of privately owned and operated autonomous systems.
- An autonomous system is a network or a collection of networks that are all managed and supervised by a single entity or organization

### Open Shortest Path First (OSPF)
- Defined in RFC 2328, **OSPF** is an _Interior Gateway Protocol (IGP) used to distribute routing information in a single Autonomous System (AS)_
- OSPF introduced new concepts to routing architectures such as **authentication of routing updates**, **Variable Length Subnet Masks (VLSM)**, **route summarization**

#### Link-States
- OSPF is a link-state protocol.
- A link is aninterface on an OSPF-enabled router.
- The state of the link is the **classification of the interface, its state, and its relationship to neighboring routers**.
- For example, a **description** of an interface would include its **IP address**, **subnet mask**, the **type of network** it is attached to, the **routers attached** to that network, its **reliability**.
- The collection of all these link-states would create a **link-state database**.

#### SPF Algorithm
- The optimal path is calculated with the use of the Dijkstra algorithm.
- These next steps are a simplified way of looking at the algorithm's operation:
  1. On startup or when there is any change in routing information, a router generates a link-state advertisement. This advertisement represents the combination of all link-states on that router.
  2. All routers exchange link-states by flooding link-states to all neighboring routers. Each router that receives a link-state update stores a copy in its link-state database and then advertises the update to other neighboring routers.
  3. After each router completes building its database, the router calculates a Shortest Path Tree to all learned destinations. The router uses the Dijkstra algorithm to build the IP routing table, also referred to as the Routing Information Base (RIB).
  4. If no changes in the OSPF network occur, such as the cost of a link or a network being added or deleted, OSPF only exchanges Hello packets. Any changes that occur are advertised through link-state packets, and the Dijkstra algorithm is recalculated to find the shortest path.
- The algorithm places each router at the root of a tree and calculates the shortest path to each destination based on the cumulative cost required to reach that destination

#### OSPF Cost
- The cost (metric) of an interface refers to the impact it has on transporting packets across the network, and is directly proportional to its bandwidth
  - The higher the bandwidth, the lower the cost
- Assuming a reference bandwidth value of 100Mbps = 100,000,000 bps, the formula used to calculate the cost would be:
  - 64Kbps cost = 100000000/64000 = 1562
  - 10Mbps cost = 100000000/10000000 = 10
- **100Mbps** is the default reference bandwidth for the OSPF implementation
- The cost is calculated by dividing the reference bandwidth by the interface speed.
- Any cost that results in less than 1 is rounded up to 1.

<img width="1942" height="936" alt="image" src="https://github.com/user-attachments/assets/0b31aa0e-5700-4eb8-8cac-a158b1a5f9a9" />

- Network vendors allow the flexibility of manipulating the reference bandwidth to account for new technologies, for example, 25Gbps, 50Gbps, and 100Gbps ethernet. 

#### Shortest Path Tree
- To build R1's shortest path tree, R1 would need to be the root of the tree and calculate the cost for each destination.

<img width="985" height="938" alt="image" src="https://github.com/user-attachments/assets/dd01307b-c8b7-458d-9042-a927ae5ded50" />

<img width="1174" height="932" alt="image" src="https://github.com/user-attachments/assets/fe968d67-aa3c-4472-b1eb-27601b3c8bb8" />

- After the router completes building the shortest path tree, it starts populating the routing table.
- All directly connected networks are reached via a cost of 0, and R1 reaches other networks according to the cost calculated in the tree.

### Areas and Border Routers
- With the potential of constant flooding of updates overwhelming routers in large-scale networks, OSPF Areas were introduced to limit the number of link-state updates as the number of OSPF routers grew within an area
- Flooding and Dijkstra algorithm calculations on the router are limited to changes within an Area.
- All routers in an Area have an exact link-state database replica.
- Routers that span multiple Areas and connect them to the Backbone Area 0 are called Area Border Routers (**ABR**). Therefore, ABRs must maintain information describing the Backbone Area and other attached areas.

<img width="1714" height="995" alt="image" src="https://github.com/user-attachments/assets/628f2797-8374-4353-b705-2d61749ef2d5" />

- An OSPF Area is interface-specific. A **router with all of its interfaces within the same OSPF Area** is called an **Internal Router (IR)**
- A router with **interfaces spanning multiple OSPF Areas** is called an Area Border Router (**ABR**)
- Routers **acting as gateways between OSPF and other routing protocols** (IGRP, EIGRP, IS-IS, RIP, BGP) are called Autonomous System Boundary Routers (**ASBR**)
- Routers can be an **ABR**, an **ASBR** and can also **combine the functions** of an ABR and ASBR.

### Link State Advertisement and Network Types
- At the core of the OSPF protocol operation is the OSPF Link State Database (LSDB), a collection of Link State Advertisements (LSA) received from neighboring routers.
- An essential fact concerning all LSA types is that only a router that has originated a particular LSA can modify it or withdraw it.
- Other routers must process and flood this LSA within its defined flooding scope if they recognize the LSA type and contents, but they must not ever change its contents, block it, or drop it before its maximum lifetime has expired
- LSAs created by other routers are intangible and must be processed and forwarded unmodified
  - This requirement makes sure that all routers in an area have the same LSDB contents and have a consistent view of the network
- Furthermore, route summarization and filtering are very limited with link-state protocols, unlike distance vector protocols where summarization and route filtering can be performed at any point in the network.

<img width="674" height="634" alt="image" src="https://github.com/user-attachments/assets/90b85baf-c4d2-416b-bf24-c820e9d0b70f" />

#### LSA Types 1 = Router LSA

<img width="671" height="400" alt="image" src="https://github.com/user-attachments/assets/5b953bd3-1e77-4fa6-8eec-99df6321ea1e" />

- Each router creates and floods a Type-1 LSA for itself.
- These LSAs describe the router, its links, and a list of neighboring routers visible on each interface.
- The LSA is identified by a Link-State ID (LSID) equal to the router-ID.
- A link is defined by the IP prefix assigned to the interface and a link type:

<img width="1936" height="598" alt="image" src="https://github.com/user-attachments/assets/72ff689e-0b58-44f8-952b-f702e2c1511d" />

#### LSA Types 2 = Network LSA

<img width="666" height="390" alt="2764be5e-86f2-47ad-8546-274b7fd0e0c2" src="https://github.com/user-attachments/assets/ec21af8b-1c01-44c4-8bb1-d67f0e8692d4" />

- Type-2 LSAs, seen on multi-access segments such as ethernet, represent a transit subnet for which a Designated Router (**DR**) has been elected.
- The LSID is the DR's interface IP address on that subnet.
- Type-2 LSAs are generated by the segments DR and contain all the routers connected to the multi-access network, the DR, and the prefix and subnet mask.
- Type-2 LSAs are not created for subnets on which no DR has been elected
- Armed with a Link State Database (**LSDB**) with all the type 1 and 2 LSAs inside an area, a router's SPF algorithm should be able to create a topological design of the network, calculate the possible routes, and finally choose the best routes to insert in the routing table.

#### LSA Type-3 = Net Summary LSA

<img width="1126" height="337" alt="d56be4af-035d-4536-bee9-14a7bdb56530" src="https://github.com/user-attachments/assets/76e38500-2ebd-4252-82ce-accf4158a9d8" />

- ABRs do not forward Type-1 and Type-2 LSAs from one area to another.
- Instead, ABRs inject Type-3 LSAs into one area to represent subnets described in Type-1 and Type-2 LSAs in another area.
- Thus, each Type-3 Summary LSA advertises a simple vector: the subnet, mask, and the ABRs cost to reach that subnet.
- By default, OSPF does not summarize routes, though limited route summarization can be configured.

#### LSA Type-4 ASBR Summary LSA

<img width="1143" height="467" alt="73883e65-1ae3-4f4f-9d4f-05cca96f453a" src="https://github.com/user-attachments/assets/0537c06b-c04f-42a6-8347-a753c9684bbe" />

- In Figure 10.2-8, R3 is redistributing information about its BGP process with R5 into OSPF.
- Because R3 has established neighboring using different protocols, it is now considered an ASBR.
  - In such a case, R3 flips a bit when sending out Type-1 Router LSAs to neighbors, identifying itself as an ASBR.
- When R1, an ABR, receives this Type-1 Router LSA, it creates a Type-4 Summary ASBR LSA and floods it into area 0.
  - This LSA continues to be flooded in all other areas and is required to ensure that all OSPF routers know where to find the ASBR.

#### LSA Type 5-11 = Implementation Specific LSAs
- These LSAs extend OSPF functionality for specific infrastructure requirements

### Enabling OSPF on a Router
- Enabling OSPF on a Cisco router requires two steps in configuration mode:
  1. Enabling an OSPF process using the command `router ospf <process-id>`
  2. And within the OSPF process created with the `router ospf <process-id>` assigning the interfaces to the areas using the command network `<network or IP address> <mask> <area-id>`.
- The OSPF process-id is a unique numeric value local to each router.
- Other routers in the same OSPF area do not have to share the same process-id.
- Routers can run multiple OSPF processes though it is not recommended as it creates multiple database instances, causing the OSPF process to consume extra compute resources.
- The **network command** assigns an interface to a specific OSPF area.
- The subnet mask is used as a shortcut as it helps assign a list of interfaces to the same area with one line of configuration.
- The mask must be entered in wild card format, 0 bits are a match, and 1s are do not care bits.
  - For example, 0.0.255.255 indicates a match in the first two bytes of the network address.
- The **area-id** defines the area number the interface is assigned.
- The area-id can be an integer between 1 and 4294967295 or entered in dotted-decimal format;
  - For example, based on Figure 10.2-9, interfaces can be added to their OSPF areas in these two formats:

<img width="891" height="795" alt="f7b95266-3756-449f-ae8e-c97345df4c4a" src="https://github.com/user-attachments/assets/dc99b20d-86c3-49a7-bd60-b817df4560f6" />

- Area configuration using integer and dotted-decimal formats: 

<img width="356" height="234" alt="image" src="https://github.com/user-attachments/assets/1398d0d3-12ba-4ecd-99e9-59f30f7f4c73" />

  - The first OSPF network statement assigns the G2 (10.0.2.1) interface to area 0 using the integer format, and the second network statement assigns interface G3 (10.0.3.1) to area 0 using the dotted-decimal format. There is no functional difference between the assignment formats. The final statement assigns interface G1 (10.23.1.1) to area 23. 

#### OSPF Router-ID
- By default, when an OSPF process starts, it selects the highest IP address on a router as the router-ID for the OSPF process.
- The router-ID then uniquely identifies a router within an OSPF domain.
- If the interface assigned with this IP address goes down, or if the address is removed, the OSPF process must recalculate a new router-ID and flood its routing information out all its interfaces, therefore disabling the interface associated with an OSPF router-ID can have a deleterious impact on network performance.
- For this reason, OSPF automatically prefers loopback interfaces over any other kind, and it chooses the highest IP address among all loopback interfaces.
- Once the router-ID is elected, it does not change unless the OSPF process restarts or the router is rebooted.

### OSPF Authentication
- By default, Cisco routers do not use an authentication policy for routing exchanges over a network.
- However, two authentication methods exist Simple Password Authentication and Message Digest Authentication (MD-5).

#### Simple Password Authentication
- With Simple Password Authentication, a password can be configured per area.
- Routers that want to participate in the same area routing domain must be configured with the same key.
- The drawback of this method is that passwords are exchanged and verified in cleartext.
- Anybody with a packet sniffer could easily capture the password.

### Backbone and Area 0
- **Area 0 is called the Backbone**. Therefore, when running a network discovery operation, it is best practice to start with Area 0 and expand into other areas.
- The Backbone needs to be at the center of all other areas;
  - this requires that all areas be physically connected to the Backbone.
  - The reasoning behind this is that OSPF expects all areas to inject routing information into the Backbone, and in turn, the Backbone disseminates that information into other areas.
  - The following diagram illustrates the flow of information in an OSPF network:

<img width="1444" height="989" alt="b176c869-49df-4d73-a434-4f38a5114409" src="https://github.com/user-attachments/assets/cb77396b-e57c-426b-a1ae-da260462bf6e" />

- If an area cannot physically connect to the Backbone, a virtual link has to be configured.
- Routes generated from within an area are called Intra-area routes.
  - These routes are represented by the letter O in the IP routing table.
  - Routes that originate from other OSPF Areas are called Inter-area or Summary routes.
  - An O IA represents Inter-area or Summary routes in the IP routing table.
  - Finally, routes originating from other routing protocols (or different OSPF processes) and injected into OSPF via redistribution are called External Routes.
  - These routes are represented by O E2 or O E1 in the IP routing table
- OSPF prioritizes routes to the same destination in the following order:
  1. Intra-area routes, O
  2. Inter-area routes, O IA
  3. External Routes Type 1, O E1
  4. External routes type 2, O E2

#### Stub Areas

<img width="1672" height="876" alt="026e0f45-35a2-4e4f-a4e1-43c6a2b1a0fa" src="https://github.com/user-attachments/assets/d7b74498-4adb-4b8a-9113-54d71ee16cd8" />

- OSPF supports certain areas to be set up as Stub areas. External networks, such as those redistributed into OSPF cannot be flooded into Stub areas. Egressing these areas is based on a default route. Defining an area as a stub area reduces the topology database size inside an area and reduces the compute requirements of routers inside that area.


- An area could qualify as a Stub when there is a single exit point from that area or if routing outside of the area does not have to take an optimal route. The latter description indicates that a Stub area with multiple exit points has one or more area border routers injecting a default route into that area. Routing to an external destination could take a sub-optimal path in reaching the destination by exiting the area through an exit point farther to the destination than other egress points.


- Another Stub area restriction is that a Stub area cannot serve as a transit area for virtual links. Also, ASBRs cannot be internal to a Stub area. These restrictions exist because a Stub area is designed not to carry external routes, and any of the above situations cause external links to be advertised into that area. OSPF Area 0, Backbone, of course, cannot be configured as a Stub.


- All OSPF routers within a Stub area have to be configured as stub routers. When an area is configured as a Stub, all interfaces that belong to that area exchange Hello packets with a flag that indicates that the interface is a stub. The stub flag is just a bit in the Hello packet (E bit) that gets set to 0. Therefore, all routers that have a common segment have to agree on the stub flag. Failure to do so results in them not becoming neighbors and forms adjacency.


- Cisco added an extension to stub areas called Totally Stub Areas, indicated by adding a no-summary keyword to the stub area configuration. A Totally Stub Area is a stub area that blocks external routes and summary routes (inter-area routes) from going into the area. This way, intra-area routes, and the default route are the only routes injected into that area.

- Virtual Links are required in two different scenarios:
  - To connect an area that does not have physical access to OSPF Area 0.
  - Connecting to disparate sections of Area 0. 

#### Areas Not Physically Connected to Area 0
- As covered earlier, Area 0 has to be at the center of all other areas. A virtual link can be used if it is impossible to have an OSPF Area physically connected to the Backbone. The virtual link provides the separate area a logical path connecting it to the Backbone. Virtual links must be established between two ABRs that share a common area, with one ABR connected to the Backbone.

<img width="881" height="590" alt="0c712f09-f460-419c-89b2-edd6620f3dc2" src="https://github.com/user-attachments/assets/d22d6b41-b523-4338-be40-c0fecc2243c4" />

### Neighbors
- Two routers must agree on the following information to become neighbors:
  - Area-id: Two routers must be connected to the same network segment;
    - their interfaces configured in the same area on that segment.
    - The interfaces should belong to the same IP subnet and have the same subnet mask.
  - Authentication: Routers who want to become neighbors must successfully exchange the same password on a connected segment.
  - Hello and Dead Intervals: OSPF routers exchange Hello packets on each network segment.
    - This is used as a keepalive by the routers to acknowledge their existence on a segment and elect a Designated Router (**DR**) on multi-access segments (most commonly EthernetEthernet).
    - The Hello interval specifies the time, in seconds, between the hello packets that a router sends out its OSPF interfaces.
    - On the other hand, the dead interval is the number of seconds that a router waits for a response to its Hello packets before its neighbors declare the OSPF router down.
    - OSPF requires that both Hello and Dead Intervals be the same between two neighbors.
  - Stub area flag: Two routers must also agree on the stub area flag in the Hello packets to become neighbors.

#### Building Adjacencies
- The adjacency building starts after multiple phases have been completed. Routers that become adjacent have the same LSDB. The following is a summary of the states an interface passes through before becoming adjacent to another router:
  - Down: No information has been received from a router on the network segment.
  - Attempt: On non-broadcast multi-access clouds such as X.25 and Frame Relay, the Attempt state indicates that no recent information has been received from a neighbor. An effort should be made to contact the neighbor by sending Hello packets at the reduced rate Poll Interval.
  - Init: The interface has detected a Hello packet coming from a neighbor, but bi-directional communication has yet to be established.Two-way: Bi-directional communication has been established with a neighbor. The router has seen its router-ID in the Hello packets received from a neighbor. At the end of this stage, the election of a DR and BDR would have completed. Once the Two-way stage is completed, routers decide whether to proceed in establishing adjacency or not. This decision is based on whether one of the routers is a DR or BDR; or if the link is a virtual link or point-to-point.
  - Exstart: OSPF routers are trying to establish the initial sequence number that is used in the information exchange packets. This sequence number ensures that routers always receive the most up-to-date information. One router becomes the primary, the other secondary. The primary router proceeds to poll the secondary for information.
  - Exchange: OSPF routers report their entire link-state database by sending database description packets to all interfaces referenced in the OSPF network command. At this state, packets can be flooded to other interfaces on the router.
  - Loading: At this state, routers are completing information exchange. OSPF routers have built a link-state retransmission list and a link-state request list. Any incomplete or outdated information is added to the request list. Transmitted updates are added to the retransmission list until they get acknowledged.Full: At this state, adjacency is complete. Neighboring routers are fully adjacent. Therefore, adjacent routers operate with a similar link-state database.

### Route Summarization
- Summarizing is the consolidation of multiple IP routes into one single advertisement.
- This is done at the boundaries of Area Border Routers (ABR).
- Although route summarization could be configured between any two areas, it is better to summarize in the direction of the Backbone.
- This ensures the Backbone receives all the aggregate addresses and, in turn, advertises them, already summarized, into other areas. There are two types of summarization:
  - Inter-area route summarization
  - External route summarization

#### Inter-Area Route Summarization
- Inter-area route summarization occurs on ABRs and is applied to routes originating within the AS.
- It does not apply to external routes advertised into OSPF via redistribution.
- Assignment of IP addresses should be contiguous within OSPF areas to take advantage of summarization and lump these addresses into one range. 

#### External Route Summarization
- External route summarization is specific to routes advertised into OSPF via redistribution.
- External ranges that are being summarized must be contiguous.
- Summarizing overlapping IP ranges from two different routers could cause packets to be routed to the wrong destination.

#### Redistributing Routes into OSPF
- Redistributing routes into OSPF from static routes or other routing protocols causes these routes to become OSPF external routes.
- When redistributing routes into an OSPF process, only routes that are not subnetted (classful routes) are redistributed.
- To ensure that subnetted ranges are redistributed, the subnet's keyword must be specified.

#### E1 vs E2 External Routes
- External routes are classified into two categories, external Type-1, and external Type-2. The difference between the two is how the cost (metric) of the route is calculated. The cost of a Type-2 route is always the external cost, irrespective of the interior cost to reach that route. On the other hand, a Type-1 cost is the sum of the external and internal costs used to reach that destination. Therefore, a Type-1 route has higher priority over a Type-2 route for the same destination. The following routing table output illustrates the External Type-1 and Type-2 routes.

#### Default Routes Advertised into OSPF
- An ASBR can be configured to advertise a default route into the OSPF routing domain.
- As covered earlier, a router becomes an ASBR when configured to redistribute routes into an OSPF domain.
- However, an ASBR does not generate a default route into the OSPF routing domain by default.

#### Route Maps
- Route-maps provide a logic similar to the If/Then/Else logic seen in programming languages.
- A single route-map can have one or several route-map commands, and routers process route-map commands in sequential order.
- Each route-map command has an underlying matching parameter configured with the match command.
- Each route-map can also have one or more optional set commands to manipulate information — for example, to set the metric for redistributed routes. General rules for route-maps are as follows:
  - Each route-map command must have a uniquely configured name. All commands that use the same name are a part of the same route-map.
  - Each route-map command has an associated permit or deny action.Each command in the same route-map has a unique sequence number; this allows for the deletion and insertion of single route-map commands.
  - When a route-map is used for route redistribution, the route-map processes routes taken from the current routing table.
  - Route-maps are processed sequentially based on their sequence numbers.
  - If a route is matched in a route-map statement and the route-map statement has a deny action, the route is not redistributed (specific to route redistribution).

### Border Gateway Protocol
- Border Gateway Protocol (BGP) — classified as an Exterior Gateway Protocol (EGP) — is the premier protocol used throughout the Internet and large-scale enterprise networks for routing between autonomous systems
- BGP employs Path Attributes (PA) to elect the optimal path between multiple routes to the same destination subnet.

#### BGP Terminology

<img width="697" height="457" alt="image" src="https://github.com/user-attachments/assets/0752e9bf-c69a-4ca2-af04-a77e530d9b50" />

#### Auonomous System and Autonomous System Number
- An Autonomous System (AS) is best described as a set of routers with common routing rules, managed by one technical entity and working with one or more IGP protocols for routing within an AS.
- Each Autonomous System is assigned an Autonomous System Number (ASN).

#### PATH
- A sequence consisting of autonomous systems numbers of which traffic must be routed through to reach the destination network

  <img width="1206" height="716" alt="b246d29d-dbe7-49ef-af19-d8a7f5fe9027" src="https://github.com/user-attachments/assets/aef3df78-43d6-45bc-8fa0-cfb242a01d60" />

#### Transit Autonomous System (Transit AS)
- Any AS that traffic is routed through to reach other autonomous systems.
- Knowing the source and the destination ASN from the AS_PATH attribute, the Transit ASNs can be determined for this observed prefix: 1299 and 174.

#### Path Attributes
- Assigned variables that BGP routers use to choose an optimal path to a destination. Some of the attributes of the path listed in the Looking Glass Server output are:
  - **MED**
  - **LOCAL_PREF**
  - **ORIGIN**
  - **AS_PATH: READ RIGHT TO LEFT, shown as: AS_PATH: TAS, TAS, OAS**
  - **WEIGHT**
  - **NEXT_HOP**

#### BGP Speaker
- Any router running the BGP protocol

#### Neighbors and Peers
- Not a term unique to BGP. Describes any two routers between which a connection for exchanging routing information is open. Neighbors or Peers are referenced in the output as Learned from Peer.

#### Network Layer Reachability Info (NLRI)
- IP prefix length and associated attributes exchanged between BGP routers using UPDATE messages. For example, this would be the Prefix: 64.210.1.0/24 returned in the query.

### BGP Overview

#### Main Characteristics
- BGP is a path-vector protocol with the following characteristics:
  - Relies on TCP port 179 to transfer data providing reliable delivery of BGP updates.
  - Only sends updates when a path change occurs (no periodic updates).
  - The protocol uses path vector or attributes to determine optimal paths.
  - Utilizes a keepalive message to verify and maintain TCP connection with neighbors.

#### Autonomous System (AS)
- As defined in RFC 1930: An Autonomous System (AS) is a collection of IP networks and routers under the control of one or a few network operators that has a single, clearly defined routing policy.

#### ASN Ranges
- ASNs — similar to IP addresses — operate with public and private ranges.
- ASNs were also recently expanded to address the exhaustion of the two-octet AS numbers.
  - 0-65535 (initial 16-bit ASNs)
  - 65536-4294967295 (new range for 32-bit ASNs) (RFC 4893)

#### ASN Assignments
- 0 and 65535 (reserved)
- 1-64495 (public range)
- 65552-4294967295 (public range)
- 64512-65534 (private range)
- 23456 (reserved to represent 32-bit ASN on devices that only support 16-bit ASNs - represented as AS_TRANS) (RFC 4893)

#### BGP Operating Model
<img width="867" height="866" alt="699f545f-7929-4fc2-ab5f-4195e26598e7" src="https://github.com/user-attachments/assets/e861cc25-0dbb-4477-8080-a8126c310cc9" />

#### BGP Table
- List of networks received from each neighbor — Network Layer Reachability Information (NLRI)
- It might contain multiple paths to a destination network
- Contains BGP path attribut

#### Routing Table
- Often referred to as the Routing Information Base (RIB), it contains the list of the best routes to destination networks
- If there are multiple paths to a destination, the router advertises only the best path from the BGP table to its peers rather than all available paths.

### BGP Neighbor States
- The goal for BGP routers is to reach the ESTABLISHED state. In this state, the routers have established a TCP connection, exchanged OPEN messages, and all parameter checks have passed, at which point topology information can be exchanged using UPDATE messages.
- If there is an IP address mismatch in the BGP configuration `neighbor` statement, the neighbors remain in the ACTIVE state.
- The following table outlines the BGP neighbor states with some of their characteristics.

<img width="691" height="304" alt="image" src="https://github.com/user-attachments/assets/9cdfa7a3-7474-465c-8582-fd3a522bcfa2" />

#### BGP Neighbor Relationship
- To establish peering, each BGP router must be manually configured to enable the BGP process.
- When a neighbor is added to the local router configuration, the neighbor's AS must also be included.
- This information is used for BGP neighbor's type identification:
  - **iBGP neighbors**: A router that is in the **same AS** as the local router.
    - When added to the local router configuration, the **neighbors share the same ASN**.
  - **eBGP neighbor**: A router that is in a **different AS** of the local router.
    - When added to the local router configuration, the neighbor is **configured with its ASN**.
- During the neighbor relationship establishment, BGP performs the following checks:
  1. The router must receive a TCP layer connection request on port 179 with the sender's address, which the router finds specified in the list of neighbors configured.
  2. The ASN of the local router must match the ASN that is configured on the neighboring router in the neighbor remote-as command. There are exemptions to this requirement when ASs are operating in a confederation setting. Confederations are outside of the scope of this lesson but are briefly covered later.
  3. The neighbor's router ID should not match that of the local router.
  4. If configured, MD5 authentication must be completed successfully.
  - For item 1, there is a particularity: only one of the two routers must have the IP address, set as the updates' source, specified in the neighbor command of another router.

<img width="450" height="402" alt="0c6dcf58-eabb-4d38-a32a-56cced5db0e5" src="https://github.com/user-attachments/assets/6f62262e-531b-4248-b7f8-59137b2adfeb" />

### Internal BGP vs External BGP
- Although the configuration between the two methods of deploying BGP is minor, they have slight differences in how they operate:
  - Packets sent to eBGP peers use a Time to Live (TTL) of 1.
  - The NEXT_HOP attribute is updated with the last eBGP peer. This does not occur in an iBGP process.eBGP neighbors do not advertise routes to eBGP neighbors in an AS that is contained within the AS_PATH.
  - **iBGP routes Administrative Distance (AD) is 200; eBGP routes AD is 20**.
  - iBGP routes are subject to BGP synchronization (when enabled).
- The significant difference between eBGP and iBGP routes is synchronization; the synchronization rule states that for an iBGP route to be added to the BGP table, the exact prefix must be in the routing originating from an IGP.
- The synchronization rule guarantees routes are known to all routers within the AS even if they are not running BGP.

### Path Attributes
- There are four categories of Path Attributes:
  - Well-known mandatory – BGP attributes that must be recognized by all BGP routers, present in all BGP updates, and passed on to other BGP peers.
  - Well-known discretionary – BGP attributes all BGP routers must recognize by all BGP routers that and passed on to other BGP peers but do not need to be present in an update.
  - Optional transitive – BGP attributes that might or might not be recognized by a BGP router but passed on to other BGP peers. If not recognized, it is marked as partial.
  - Optional non-transitive – BGP attributes that might or might not be recognized by a BGP router and not passed on to other peers.

<img width="968" height="745" alt="9d1883ff-898f-443d-9212-953ad8a8e1e5" src="https://github.com/user-attachments/assets/21646e2b-7566-4c40-b0dd-b3da9f461be2" />

### Best Path Selection Process
- The following list provides the core steps a BGP router takes to elect the best routes, including three tie-breakers.
  1. Highest WEIGHT: Cisco proprietary attribute. The administrative weight can be assigned to each NLRI locally on the BGP router. The value is never communicated to another router. The higher the WEIGHT, the better the route.Highest
  2. LOCAL_PREF: Attribute that can only be used within a single AS to choose the same exit point for a particular NLRI. The higher the LOCAL_PREF, the better the route.
  3. Locally injected routes—Prioritize routes injected into BGP locally; (using the network command, redistribution, or route summarization). (This step is seldom needed and is sometimes omitted from other BGP references.)
  4. Shortest AS_PATH length: The shorter the AS_PATH length, the better the route. The length calculation ignores both AS_CONFED_SET and AS_CONFED_SEQ and treats an AS_SET as 1 ASN, regardless of the number of ASNs in the AS_SET. It counts each ASN in the AS_SEQUENCE as 1.
  5. ORIGIN: IGP (I) routes are preferred over EGP (E) routes, which are in turn preferred over incomplete (?) routes.
  6. Lowest MED: Traditionally, this attribute allows an ISP with multiple peer connections to a customer AS to tell the customer which peer connections are best for reaching a particular NLRI. The lower the value, the better the route.
  7. Neighbor Type: Prefer eBGP routes over iBGP. For this step, treat confederation eBGP as equal to iBGP.
  8. Lowest: IGP metric to reach the NEXT_HOP: IGP metrics for each NLRI's NEXT_HOP are compared. The lower the value, the better the route.

#### Tie Breakers
1. Oldest eBGP route. If the routes being compared are eBGP, and one of the paths is the currently best path, retain the current best path.
2. Lowest neighbor RID. Use the route whose next-hop router RID is the lowest. On a Cisco platform, only perform this step if bgp bestpath compare-routerid is configured.
3. Lowest neighbor ID. Typical for this scenario, the local router has at least two neighbor relationships with the same router. The router prefers the route advertised by the lowest neighbor ID, as listed in that router's neighbor commands.


### BGP Route Relfectors

<img width="1474" height="956" alt="d2ae57b4-7e87-4ffc-9d86-62b21fadfbf6" src="https://github.com/user-attachments/assets/432d43c3-0692-4cf6-8601-82396efd7fca" />

<img width="1307" height="935" alt="de7915c6-4822-4d16-9952-7f131e7541fb" src="https://github.com/user-attachments/assets/a39ec460-f903-45a5-9420-c0d640de9c75" />

### BGP Attacks

#### Prefix Hijacking and Announcement of Unallocated Address Space
- A BGP prefix hijack occurs when an AS accidentally or maliciously originates a prefix that it was not authorized (by the prefix owner) to originate
- Typical cases of Prefix Hijacking can be traced back to operator error in environments where upstream providers lack proper attribute validations.
- When the intent was malicious, the goal of the threat actor is to route traffic to the targeted prefix through a network under their control
- This would allow for eavesdropping, misdirecting clients to fake servers (to steal login credentials or inject malicious code), or bypass IP reputation systems or spam filters to send malicious emails.

<img width="1278" height="610" alt="2b41efe1-33a8-4e83-90a8-98a62b087d91" src="https://github.com/user-attachments/assets/4494c049-20d3-40c6-97b6-621cb540a3da" />

#### AS Path Modification
- BGP is also vulnerable to modification of the AS_PATH information that it carries
- As an example, a compromised AS which receives a BGP update may alter the path, removing some of the preceding ASN in the AS_PATH attribute before advertising the update to make the path length seem shorter.
- When an update modified in this manner is advertised, the Autonomous Systems upstream can be tricked to believe that the path to the advertised prefix via the compromised AS is shorter

<img width="1650" height="787" alt="23f56028-82ff-4fc9-8457-c695824d95bb" src="https://github.com/user-attachments/assets/2babcf12-f05d-4fe9-a786-ed0938880fcb" />

## Protocol Basics

### Protocol Refresher

#### Ethernet

<img width="862" height="107" alt="b9ac4066-6717-4f6c-9b37-c1d50bdde80d" src="https://github.com/user-attachments/assets/2db74556-c7f9-4631-a941-b73aec078963" />

<img width="1596" height="708" alt="44c03256-1a7b-4c52-bdfc-baa41a144be6" src="https://github.com/user-attachments/assets/a9aedf1e-719b-46bb-8577-85ea5cddca90" />

#### IPv4

<img width="1600" height="290" alt="83c8bc51-9427-4c43-bdbe-5fdb16c8b4cc" src="https://github.com/user-attachments/assets/784c3acc-6e3b-449c-b58a-886d8d8f37d4" />

<img width="1566" height="532" alt="483b71f0-d8c6-475c-8c19-b2bfa700fca7" src="https://github.com/user-attachments/assets/4f9ba315-eb67-45c2-bb77-3427fa469c21" />

#### IPv6

<img width="1720" height="254" alt="7a59102e-8401-4458-af46-8f24bb5713a1" src="https://github.com/user-attachments/assets/1f73d0d9-f0bc-4654-b422-811cc8efd7af" />

<img width="767" height="383" alt="40b63392-301f-4bf6-b515-367e28ea96ac" src="https://github.com/user-attachments/assets/243a1705-65fb-4ae5-bcff-384e020a16ea" />

#### TCP

<img width="1722" height="380" alt="921ba930-2608-4754-a2af-cd5c464b2775" src="https://github.com/user-attachments/assets/b283435a-dcd2-401e-b632-291669a51e6d" />

<img width="852" height="688" alt="215c2213-7610-4661-b9c3-3ecca0ae0250" src="https://github.com/user-attachments/assets/3142f221-5fec-416a-9f66-096e4135c368" />

<img width="1562" height="756" alt="4ddc706b-5adc-431f-8e02-666816c100e7" src="https://github.com/user-attachments/assets/eee28be5-b7ed-4e81-bac8-d42ba5dd0245" />

#### UDP

<img width="1720" height="214" alt="719cfcdc-3d24-4005-a5c4-8d01f0f0369e" src="https://github.com/user-attachments/assets/dd26b53f-8b8a-4d4c-b75e-72087daba9ba" />

<img width="308" height="175" alt="710a7791-ac8b-4ab6-9f75-1703d11c89b3" src="https://github.com/user-attachments/assets/ae2d2d61-dd49-4d0c-a129-3661117153cc" />

<img width="1570" height="476" alt="bffd45b3-706b-4721-b2bb-6ba76e67860b" src="https://github.com/user-attachments/assets/1400bfeb-bd0f-4eba-b6f8-c242e1761abc" />

#### ICMP

- Type 3 and 11 responses:

<img width="1720" height="212" alt="be7ead00-45c0-4e67-b6a3-c54f53309cc9" src="https://github.com/user-attachments/assets/1bc00461-fcb0-4dae-a4d6-e08e2c0ec0a5" />

- Type 5 response:

<img width="1720" height="212" alt="b806a287-8322-4eb1-a29b-6e7b9985e656" src="https://github.com/user-attachments/assets/a0839796-9d77-40ed-9723-8f110db11349" />

- type 0/8 response:

<img width="1720" height="212" alt="562c5daf-1f24-482f-bb25-1530c0904fb3" src="https://github.com/user-attachments/assets/31e5d8ea-1bae-4ac5-9fa4-7e8d38020c34" />

- Checksum: Validates datagram content
- Identifier: Used to match replies with the original Echo (Request); Windows default is 0x0200
- Sequence Number: Used to track ICMP message and response times via Echo (Reply)
- Data: Default length is determined by the OS. Since data lengths differ by OS, the payload can be used for enumeration.

- Message Types:

<img width="852" height="745" alt="977a5bef-27ad-4b63-aa9c-d7fe36e253a4" src="https://github.com/user-attachments/assets/75fa71ae-fe2f-4ba7-87ab-4447e1f938a0" />

- How is it used?

<img width="853" height="1174" alt="8e8cd8c3-7755-48fe-b2c4-9bc51565a0f5" src="https://github.com/user-attachments/assets/2f05c3cf-d119-443b-9ea6-3d79e339bd97" />

<img width="1116" height="956" alt="644a4f86-bef1-4ef9-a66c-de18a66ff6a4" src="https://github.com/user-attachments/assets/ad2aac8b-64fb-4ea7-bf7d-b537287767fa" />

<img width="1596" height="502" alt="27626fc8-22ca-4e71-a50f-6091938d56c1" src="https://github.com/user-attachments/assets/ff530d96-5484-4fbd-9cbb-c43b5c5c92f3" />

#### ARP

<img width="1589" height="323" alt="7f5115f8-ec41-48c7-8d54-7a4aaae170f0" src="https://github.com/user-attachments/assets/feb02763-2785-44e6-b2d6-cd7b2a2c4a49" />

<img width="1596" height="458" alt="c0ad4151-80b0-4b8d-b2b3-727263f066d4" src="https://github.com/user-attachments/assets/0b3e4622-e8a1-4e71-a035-3c95f9eb3a21" />

#### DNS
- SPF
- DKIM
- DMARC
- Zone Transfers:
  <img width="852" height="117" alt="cfea0cbe-61a9-4ad8-b325-96ee6556cffc" src="https://github.com/user-attachments/assets/d4721522-fc4c-4ad0-855b-24c93b3e740e" />

  <img width="852" height="117" alt="a7f63a7a-d19a-44a9-ab08-7a385382fbee" src="https://github.com/user-attachments/assets/1ab4c958-9200-4a82-a253-1e16005f03d0" />

  <img width="852" height="117" alt="db3fb965-fd18-4094-b741-b9f753105a94" src="https://github.com/user-attachments/assets/aef55f3f-2571-4c24-ae33-e5dcfe3cc7fe" />

  <img width="852" height="117" alt="58b496fc-b62e-46bd-a527-e992b72512b5" src="https://github.com/user-attachments/assets/cf22c586-0ad7-488b-952c-04145fdef07b" />

  <img width="852" height="145" alt="14b6c2de-e377-4a97-b059-21afd50979e1" src="https://github.com/user-attachments/assets/b3fd127e-5b6a-426b-b21d-8db150b3cb26" />

  <img width="852" height="111" alt="963f0830-5a6c-4a66-946b-5739e4122356" src="https://github.com/user-attachments/assets/d624881d-d2b2-4861-b6d9-08a60af770fc" />

<img width="1002" height="367" alt="594a0508-991a-4b8b-a5e0-36c007883bc9" src="https://github.com/user-attachments/assets/910a2af2-baa2-4f5c-8327-24d9da9f5caf" />

<img width="582" height="198" alt="d66d55ed-25c8-4f7a-96ba-7c248420232e" src="https://github.com/user-attachments/assets/cf1b458f-da8d-4f19-8f9a-581236edc4d1" />

<img width="942" height="226" alt="66549cd2-00b5-458a-827a-8ab5bdba83c7" src="https://github.com/user-attachments/assets/e2a7709f-90a6-48d5-ac4e-8b3202d1b9df" />

#### SMTP
- PORT 25
<img width="852" height="747" alt="97fbd79f-e30a-4df4-a877-82293caf4b39" src="https://github.com/user-attachments/assets/ec6048b6-663c-4a82-871a-500e91880eab" />

#### IMAP
- IMAP utilizes TCP as its Transport Layer protocol as well as TCP port 143.
- IMAP is the protocol that retrieves email from a mail server. It is used as an alternative to POP3 and enables a user to search through messages based on keywords and select the desired messages to download to a local device.

#### POP
- The POP3 protocol enables a user to access email from a server. Assuming that the mail is posted to the server using SMTP, the POP server listens for connections via TCP port 110.
- When a connection is open and established, POP commands allow users to identify themselves, retrieve email, and adjust email within the mailbox. 

#### HTTP

- Methods
<img width="852" height="547" alt="8ebe1454-94cf-42a9-b3c7-511a316175fc" src="https://github.com/user-attachments/assets/72f4bdb3-6879-42c9-a703-cc57dc3cf326" />

- Status Codes

<img width="852" height="284" alt="1b450aa6-33cd-49a2-9079-f01797b41c68" src="https://github.com/user-attachments/assets/e1b4a421-1e20-4ac8-976b-6f8d9e7e3f89" />

<img width="852" height="598" alt="8e830b40-ba06-4377-a558-207211a14767" src="https://github.com/user-attachments/assets/00f7d9b5-cd89-4ee2-94c4-5b3d1a70a39f" />

<img width="852" height="409" alt="3c7d0133-c6aa-4dd3-8bef-34de0e3bade4" src="https://github.com/user-attachments/assets/6272132b-325e-4473-a1f5-526ffca9480f" />

<img width="852" height="439" alt="0b983b51-731b-47a6-910b-2800ae54f456" src="https://github.com/user-attachments/assets/c83f74d8-b467-4cd8-8a20-478b3ebadbb5" />

<img width="852" height="528" alt="727592f6-f9d4-4716-b152-812bbc6c0d48" src="https://github.com/user-attachments/assets/5b3923fa-24f6-45c0-92ce-464c78e61faf" />

- Follow HTTP STREAM:

  <img width="2110" height="900" alt="5cf18060-bfa2-4ebc-aeb7-a39d90d8c1cb" src="https://github.com/user-attachments/assets/b3990393-a4c4-4da5-b4f4-d9b3bb8ba08a" />

- If you open up a picture, DO NOT USE PAINT, USE MICROSOFT PICTURE MANAGER
- FILE > Export objects > HTTP

#### TLS

<img width="799" height="324" alt="ba63afc6-593c-4fad-b3ef-4c8a1c8cf81b" src="https://github.com/user-attachments/assets/04b5ac1a-c0c9-4368-93f0-9de0284c06cd" />



# MODULE 11

## Microsoft Communication Protocols

### Windows Networking Overview
<img width="510" height="865" alt="f2691164-f7d6-42d1-8ff7-7a4a4ed15bb2" src="https://github.com/user-attachments/assets/3ffe922e-3ef2-4f63-86d2-79bcd36343b7" />

- Microsoft uses a layered approach to networking with each layer supporting the ones above and below. Very simplistically:
  - Windows applications call high-level networking APIs, like WinHTTP
  - High-level APIs use the Winsock API to package up the data and decide which transport protocols to use and the associated addressing used for those transport protocols
  - One or more LSPs process the data and pass it to the corresponding TSP
  - The TSP then interfaces with the kernel drivers and APIs to actually craft packets and frames, and send out over the physical medium

#### Winsock Kernel
- Winsock is based on the Berkeley Software Distribution (BSD) Sockets API that became the standard for UNIX systems
- WSK is a kernel-mode network programming interface that interfaces with networking hardware to perform Input/Output (I/O) operations
  
<img width="756" height="282" alt="download" src="https://github.com/user-attachments/assets/d27b23ee-58b5-47de-b05b-1bde96f272fd" />

### Winsock Transport and Namespace Providers
- Namespace providers perform a lookup, or interface mapping, between a programmatic interface name and some other existing name service
- Utilize `netsh winsock show catalog` to view the Winsock catalog.
- mswsock.dll DLL provides many transport protocols, including TCP/IP, UDP/IP, and RAW/IP for IPv4 and IPv6.
- The vsocklib.dll DLL provides socket support for VM

### RPC and NetBIOS
- The RPC protocol is based on the Open Science Foundation (OSF) (now Open Group)/Distributed Computing Environment (DCE) distributed computing standard.
- An RPC application is statically linked to a DLL that contains a stub procedure for each remote procedure exposed by the API

![e789a673-a298-4d0f-9ad9-321420a58572](https://github.com/user-attachments/assets/0c04ecc9-e950-4b0c-8d49-24f22ba0faeb)

- The Windows RPC system implements transport provider DLLs for named pipes, **HTTP**, **TCP/IP**, and **UDP**. Named pipes use port **445**, the **RPC** endpoint mapper — maps applications to ports — uses port **135**, and **HTTP RPC** applications use **80**, **443**, and **593**
- RPC server applications are assigned a dynamic port that the RPC endpoint mapper provides to client applications.
- Unix and Linux have a similar RPC mechanism with the port mapper listening on port 111.

- Utilize `nbtstat -n` to view local NetBIOS names
- The nbtstat CLI program displays **protocol statistics** and **current TCP/IP connections** that are using **NetBIOS over TCP/IP (NBT)**. The NBT names and connections normally present are based on whether a host is part of a domain or not.

  <img width="728" height="310" alt="download" src="https://github.com/user-attachments/assets/c7088197-e212-4b6b-9e71-f16f5add993c" />

- Utilize `nbtstat -A <IP ADRESS>` to run on a remote system

### Inter-Process Communication | Pipes and Mailslots
- Utilize `Get-ChildItem \\.\pipe\` to view any open named pipes
- Utilize .\accesschk64.exe \\.\pipe\spoolss` to view the permissions of a specific pipe (**Run from Sysinternals**)
- The **spoolss** named pipe is associated with the **Print Spooler SubSystem**. Notice that the **Anonymous Logon user** has access to **Read (R) and Write (W)** to this pipe

#### Security of Standard Named Pipes
- named pipes that have allowed anonymous access in current and previous versions of Windows.

<img width="729" height="415" alt="download" src="https://github.com/user-attachments/assets/dc01e8a6-0b6a-458a-93e3-73da56fea9e8" />

- Gropu policy can restrict anonymous access to named pipes and shares by setting the follwoing registry key to 1:
  - `HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters\RestrictNullSessAccess`
- Sysmon event Identifiers (ID) **17** — named pipe created — and **18** — named pipe connection — can be monitored for named pipe creation and connection events

#### Mailslots
- Mailslots are similar to named pipes and can be compared to UDP in that they are unreliable –  there is not a mechanism to verify receipt of mailslot communications
- Mailslot communications are limited to **424** byte messages

### Server Message Block (SMB)
- The SMB protocol is a network file and resource sharing protocol that was originally introduced in the 1980s with SMBv1
- Most networks have file shares configured that operate over SMB and allow remote file and printer resources to be used across the network
- Administrative shares are used for configuration and remote administration. The share name ends in a dollar sign.
- The **IPC**$ share is also known as a **null session connection** and allows **anonymous users to perform activities** like enumerating the names of domain accounts and network shares.
- The IPC$ share is created by the Windows Server service as one of the **default shares** and exists to allow for subsequent named pipe connections.
- Only systems that are members of the **same domain** should have access to the IPC$ share.
- Modern instances of SMB use TCP port 445 for direct host-to-host communication in the client/server model.
- Windows 2000 used SMB port 139 along with NetBIOS name resolution
- Utilize `net share` to view admin shares
- Utilize `net view \\<ip address> /all` to view SMB shares on a remote system
- Utilize `net view \\cda-file /all` to view resources shared on cda-file server
- Utilize `net use` to view all mapped connections to shares
- Utilize `net use * \\cda-file\c$` to create a map to c$ admin share (**Will return with a Drive letter mapping the drive**)
- Utilize `net use w: /delete` to un-map a share
- Utilize `copy <filename> c:\temp` to copy a file from a share to your computer

### Analyzeing Zeek SMB logs in Kibana

#### Zeek Overview
- Zeek has two main components: an event engine and a script interpreter.
- 

<img width="427" height="739" alt="download" src="https://github.com/user-attachments/assets/643c94e3-90a5-488f-a6f9-404df55abe29" />

### Remote Desktop Protocol (RDP)
<img width="741" height="524" alt="fc2595a3-15f1-4279-bbef-f1adf94b88cc" src="https://github.com/user-attachments/assets/bb5fc3aa-a06e-454a-a0b4-1402dde634d3" />

- Microsoft RDP uses TCP port 3389 for remote desktop connections.
- This port should not be exposed to the internet or have port-forwarding enabled from an internet-facing device to internal hosts


<img width="742" height="510" alt="download" src="https://github.com/user-attachments/assets/b757645e-13ce-49ac-8e6b-7c0ac1cf3be4" />

## Network Security Devices

### Firewalls
- Four main types:
  - **Packet filtering firewall (stateless)**: Operates at the network layer and compares incoming and outgoing packets to ACL
  - **Circuit-level gateways**: Similar to packet filtering firewalls, except they check the session-level protocols for a valid connection
  - **Stateful inspection firewall**: Similar to packet filtering firewall, except they also keep track of established connections and create dynamic rules based on a state table
  - **Application-level gateway (proxy firewalls)**: Similar to circuit-level gateways, but provide much deeper inspection, including the same functions as a stateful firewall.
- Additional Features may include:
  - **Zero-trust sandboxing**: Placing devices in an isolated enclave until certain security checks have been completed (e.g., antivirus scan, patch scan, etc.)Role-based: Specify rules based on a configured role assigned to a user (e.g., only certain users can connect with wireless devices)
  - **Artificial Intelligence (AI)/Machine Learning (ML)**: May use AI/ML to dynamically create rules to allow or block traffic
  - **Secure Sockets Layer (SSL)/Transport Layer Security (TLS) decryption**: Requires internal clients to create an encrypted connection with the proxy, which creates a separate encrypted connection to the external host.
    - This allows the device to decrypt and inspect data traversing the proxy (very resource intensive).
  - **IDS/IPS functions**: May include IDS (passive) or IPS (active) defenses instead of using a separate device or server
  
<img width="742" height="604" alt="1f52df93-f7ec-47a5-bfef-48507d8e20c5" src="https://github.com/user-attachments/assets/5500c5d5-953b-4b9e-b73f-2034472dc17d" />

### Host IDS/IPS
- There are many different types and products that can perform IDS/IPS functions, which are usually included as part of a host security or Endpoint Detection and Response (EDR) software suite
- DoD systems use a Host Based Security System (**HBSS**)

#### Network IDS/IPS
- Network IDS/IPS systems — like Snort and Suricata — rely on network packet capture to analyze the data that is traversing a network.
- Suricata
  - Suricata features include:
    - **Multithreaded**: Supports running many threads to take advantage of multi-core Central Processing Units (CPU)
    - **Hardware acceleration**: Supports using graphics cards to process and inspect network traffic
    - **File extraction**: Supports recognizing, extracting, and saving files from network trafficScripting: Uses the Lua scripting language
- SecOnion and Suricata
  <img width="964" height="289" alt="27f4a038-a63f-4ba3-99af-17b767849118" src="https://github.com/user-attachments/assets/40a0a0a9-d076-4c62-8539-6ee992d60086" />

  - The ET ruleset consists of two portions:
  - ET rules are prefaced with ET
  - Snort rules — under the GPL license — are prefaced with GPL

### Suricata Alerts
- Suricata rules are comprised of three parts:
  - **Action**: What happens when the signature matches
  - **Header**: Describes the protocol, IP address, ports, and network flow direction of the rule
  - **Rule options**: Specifics of the rule

<img width="758" height="186" alt="4731a32f-1646-4dae-9830-fe755970d677" src="https://github.com/user-attachments/assets/fdb88bc3-5680-48a1-95b2-21e528d9b304" />

#### Actions
<img width="758" height="186" alt="f01d1588-725c-4300-ab66-8903facfaed3" src="https://github.com/user-attachments/assets/f1ea94a5-afb9-4c78-a157-5d6885a4ff65" />

- The actions available are:
  - **alert**: Generates an alert; the only option available in a passive role
  - **pass**: Stops further inspection of the packet; typically because it is expected or not suspicious
  - **drop**: Drops the packet and generates an alert; similar to a firewall that drops a packet
  - **reject**: Sends a packet with the RST flag and/or an ICMP unreachable packet to the sender — originator — of the matching packet; this closes any TCP session in the process of being setup
  - **rejectsrc**: Same as reject
  - **rejectdst**: Sends a RST/ICMP unreachable to the destination host; the matching packet was addressed
  - **rejectboth**: Sends a RST/ICMP unreachable to both sides of the conversation

#### Header
<img width="758" height="186" alt="06540ed5-c97d-4a30-8984-9c2e26b88515" src="https://github.com/user-attachments/assets/25ce30cf-dfaf-4852-9638-6c2cba37ec58" />

- **Protocol**: The first field in the header is the protocol, in this case TCP

  <img width="964" height="801" alt="777baa1b-0179-4581-a167-125974a91496" src="https://github.com/user-attachments/assets/8c2e32c3-aa25-4cb2-b245-385d1db465c4" />

- **Source and Destination**: The second and third fields are for the source of the traffic.
  - This can be a single IP address, an IP address range, a grouping of IP addresses, or a variable defined in the configuration files.
  - The **$HOME_NET** variable is intended to hold the IP addresses/ranges associated with the network being protected.
  - The in-range Suricata instance is configured with the following variables

#### Rule Options
<img width="758" height="186" alt="220203d8-301e-4f23-b593-fdf22a763078" src="https://github.com/user-attachments/assets/05474b51-4329-43e8-af27-7bc0cf9bb51a" />

- The Options section of a Suricata rule is composed of keywords and settings. Not all keywords have settings, but there may be multiple settings separated by commas — keywords are separated by semicolons
- The Keywords are:
  - **msg**: The alert message associated with this rule
  - **flow**: flow:to_server matches packets from a client to a server
  - **flags**: flags:S,12 matches TCP SYN packets or TCP packets with the two reserved bits set
  - **threshold**: A threshold used to control the rule’s alert frequency
    - _threshold:type both, track by_src, count 5, second 120_ only alerts when a threshold of five matched packets from the same source IP address is exceeded within 120 seconds and only alerts five times in 120 seconds.
    - The threshold: type setting has three options:
      - **threshold**: Only alerts when the count setting is exceeded in the second time period
      - **limit**: Only alerts count number of times in the second time period
      - **both**: Only alerts when the count setting is exceeded in the second time period and alerts at maximum count times in the second time period
  - **reference**: A reference to where more information about the signature/alert can be found
  - **classtype**: Classification of the rule and alert; consists of a short name, and optionally, a long name, and priority
  - **sid**: Signature Identifier (ID)
  - **rev**: Revision of the signature
  - **metadata**: Additional non-functional information about the signature

### Suricata Rules | Categories
- Utilize `cut -d\" -f2 /opt/so/rules/nids/all.rules | grep -v "^$" | grep -v "^#" | awk '{print $1, $2}'|sort |uniq -c |sort -nr` to view categories of rules and the count of rules for each category used for Suricata
- SecOnion holds all rules in the /opt/so/rules/nids directory

### OT Network Considerations
- OT is used to refer to a variety of networks including:
  - **SCADA**
  - **ICS**
  - **Distributed Control Systems (DCS)**
  - **Programmable Logic Controllers (PLC)**
  - **Shipboard Hull Mechanical and Electrical (HM&E)**
  - **Remote Terminal Units (RTU)**
- Some of the more common OT network protocols include:
  - **DNP3**
  - **Modbus**
  - **Process Field Bus (Profibus)**
  - **Local Operating Network (LonWorks)**
  - **Digital Addressable Lighting Interface (DALI)**
  - **Building Automation and Control Network (BACnet)**
  - **Konnex (KNX)**

## Logical Network Maps
- Utilize `nmap.exe -sn 172.16.3.0/24 -oN Documents\nmap\172-16-3-all.txt -oX Documents\nmap\172-16-3-all.xml` to run a scan on a network and save as a document
- Utilize `nmap.exe -sn 172.16.0.0/28 172.16.1.0/28 172.16.2.0/28 172.16.3.0/28 172.16.4.0/28 172.16.5.0/28 172.16.6.0/28 174.16.1.0/28  70.39.165.0/24 -oN Documents\nmap\network-all.txt -oX Documents\nmap\network-all.xml` to perform a nmap scan on multiple subnets in a network
- **DISABLE GROUPS ON NESSUS SCANS**



