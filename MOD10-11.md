# MODULE 10

## SWITCHING

### Introduction to Switching
- Switches operate at Layer 2 of the OSI model
  - **1 Broadcast Domain and collision domains equal to number of open ports**
- These devices are responsible for both the physical connection between devices as well as forwarding data frames received to the next recipient on the same network
- Traversal between networks is handled on Layer 3 of the OSI model
- This lesson uses the terms **frame**, **data frame**, or **ethernet frame** when referring to a discrete piece of data transmitted over Layer 2, and **packet** when referring to Layer 3 or higher equivalents.
- The same piece of data may be described as a frame, packet, or datagram depending on the context.

#### OSI Model
- The OSI Model consists of seven layers, shown in this chart:

<img width="552" height="732" alt="image" src="https://github.com/user-attachments/assets/3799f1e6-8572-486f-823c-7c0c8c80d8b4" />

- Layer 2 of the OSI model — the **Data Link layer** — handles addressing ethernet frames to direct communication between hosts on the same Local Area Network (LAN)
- Ethernet frames include Layer 2 addressing with vendor-assigned unique source and destination addresses for segments.
- In addition, ethernet commonly uses MAC addresses for communication on a segment.
- Other Layer 2 protocols — such as Frame Relay — use a completely different method of Layer 2 addressing.
- **MAC addresses are unique 48-bit addresses, separated into six octets, and noted in hexadecimal format.**
  - The first three octets — known as the Organizationally Unique Identifiers (OUI) — are assigned by the Institute of Electrical and Electronics Engineers (IEEE) to a manufacturer.
  - Each manufacturer is responsible for ensuring that the last three octets are unique for each device built.

#### Layer 2 Devices
- The simplest Layer 2 device for ethernet networks that allows multiple devices to communicate with each other is the **hub**
  - **1 Broadcast Domain and 1 Collision Domain**
- These devices broadcast all received data frames to all ports, regardless of the intended recipient.
- While these simple devices may still be found in some older networks, their usage is discouraged due to issues that they present including:
  - The broadcast behavior allows any connected device to view traffic bound for any other device on the hub.
  - Due to the rebroadcast nature of this device, transmitted frames can often collide when two connected devices attempt to send at the same time — especially during high-traffic load — causing dropped frames or retransmissions.
- Like hubs, switches allow for connectivity between devices; however, unlike hubs, switches utilize logic to determine which ports to forward frames onto
- Basic switches exist that perform only the bare minimum of switching to ensure that collisions do not occur frequently and ensure basic addressing.
  - These switches — sometimes referred to as **unmanaged switches** — can be found in small business and home networks and even see use in enterprise networks
- However, **managed switches** are typically utilized in enterprise networks, especially for central connectivity within the network.
  - These switches are able to be configured and support more features — such as the ability to **mirror ports**, **create VLANs** to segregate networks, etc.

#### Collision Domains
- When ethernet was introduced, it started leveraging technologies such as **Thinnet (10Base-2)** and **Thicknet (10Base-5)** coaxial cables as a transmission medium, in which devices connected to the medium with **Vampire Taps** or **T connectors**
- To mitigate the impact collisions have on a network, ethernet uses **Carrier Sense Multiple Access/Collision Detect (CSMA/CD)** to guarantee that only one host transmits at any given time in a collision domain
- If two hosts transmit at the same time, and the transmitting host senses that another host is also transmitting, it stops transmitting the frame, sends a jam signal, and waits a random time interval before attempting to retransmit the frame
- This means that hosts can either transmit or receive data at one time (operate at half-duplex).
- Network switches introduced stability and scalability in networks by creating virtual communication channels
  - To create these channels, switches maintain a table that associates a host's MAC addresses to the port to which the host is connected.
  - Instead of flooding traffic out of every switch port, a switch uses the MAC address table to forward traffic only to the switch port associated with the destination MAC address.
  - The process of delivering traffic directly to the DMAC drastically reduces the size of the collision domain between the devices enabling hosts to transmit and receive data simultaneously (full-duplex).

### Configuration File Overview

#### Cisco Devices
- Cisco devices tend to have several different methods for an administrator to connect to them.
- The most common methods follow:
  - Direct connection to the console via the **console** or **Auxiliary (AUX) port**.
    - This is generally a **serial port** connection and often requires the included **Registered Jack (RJ)-45 to Recommended Standard (RS)-232 cable** to connect to.
    - The screen command or a terminal emulator can be used on Linux, while **PuTTY** or other terminal connection software is common on Windows.
  - Connection to a virtual console, typically via **Secure Shell (SSH) or Teletype Network (Telnet)**.
    - **Telnet** is generally discouraged because its traffic is transmitted in plaintext.
    - Binaries for SSH are available or commonly included on Linux systems and modern builds of Windows — though, **PuTTY** is still commonly used on Windows.
  - Many modern Cisco devices also include web interfaces for viewing the status of and managing the device.
    - These interfaces can be interacted with using standard browsers.

#### Cisco Security Model
- First connection to a Cisco Switch will show something similar to `hostname>`
- The **enable** command can be used to **raise privilege levels to 15**, and the **disable** command can be used to **lower the privilege levels to 1**.
- An **enable password** can be configured to **require a password** in order to raise the privilege level
- The basic security model for Cisco devices consists of three privilege levels:
- Zero (0)
  - Privilege level 0 is the **lowest level privilege** defined by default on Cisco devices.
  - When connected, the user only has access to these commands:
    - **disable**: Lower privilege level
    - **enable**: Raise privilege level
    - **exit**: Close the current session
    - **help**: Interact with the help system
    - **logout**: Close the current session
  - These commands only allow leaving the session or attempting to increase or decrease the privilege level.
- User (1)
  - At this level — in addition to the above commands — some additional utilities are available for troubleshooting connectivity, such as the **traceroute** and **ping** commands.
  - In addition, some configurations can be viewed via **show** commands.
  - No configuration changes can be made at this level.
- Privileged (15)
  - Privilege level 15 is the highest level defined by default on Cisco devices. At this privilege level, all commands are available, and the device can be configured.

#### Cisco Config Mode
- To make changes to the current configuration of the device, the **configure terminal** command must be used.
- For this command to be used, the current privilege level must be 15. As the configuration is navigated, the prompt changes to indicate what is currently being configured:

  ```
  Hostname#configure terminal
  Hostname(config)#interface GigabitEthernet0/0
  Hostname(config-if)#
  Hostname(config-if)#end
  Hostname#
  ```
  - In addition, you can completely leave via the **end** command
- Configuration sections are separated by exclamation points (!) for readability, which are for formatting and display purposes only.
- An example configuration file (trimmed) follows:

  ```
  version 15.2
  service timestamps debug datetime msec
  service timestamps log datetime msec
  no service password-encryption
  service compress-config
  !
  hostname Switch
  !
  !
  !
  no aaa new-model
  !
  !
  !
  ip cef
  login on-success log
  no ipv6 cef
  !
  !
  !
  spanning-tree mode pvst
  spanning-tree extend system-id
  !
  vlan internal allocation policy ascending
  !
  !
  !
  interface GigabitEthernet0/0
   media-type rj45
   negotiation auto
  !
  interface GigabitEthernet0/1
   media-type rj45
   negotiation auto
  !
  interface GigabitEthernet0/2
   media-type rj45
   negotiation auto
  !
  interface GigabitEthernet0/3
   media-type rj45
   negotiation auto
  !
  interface GigabitEthernet1/0
   media-type rj45
   negotiation auto
  !
  interface GigabitEthernet1/1
   media-type rj45
   negotiation auto
  ip forward-protocol nd
  !
  interface GigabitEthernet1/2
   media-type rj45
   negotiation auto
   shutdown
  ip forward-protocol nd
  !
  interface GigabitEthernet1/3
   media-type rj45
   negotiation auto
   shutdown
  ip forward-protocol nd
  !
  no ip http server
  no ip http secure-server
  !
  !
  !
  control-plane
  !
  !
  line con 0
  line aux 0
  line vty 0 4
  !
  !
  end
  ```
- Breakdown of the sections is as follows:
  ```
  version 15.2
  service timestamps debug datetime msec
  service timestamps log datetime msec
  no service password-encryption
  service compress-config
  ```
  - This section covers the version of the device, as well as some services that are configured:
    - **version**: Indicates the Cisco Internetwork Operating System (IOS) version for this device
    - **service timestamps**: Determines how timestamps for debug and log entries are displayed
    - **service password-encryption**: Automatically encrypts passwords when a new password is saved; no variant of the command means this is disabled
    - **service compress-config**: Configuration is compressed automatically by this service

  ```
  hostname Switch
  no aaa new-model
  ```
  - **hostname**: Sets the hostname for this device; shown in the command-line by default, may also be discovered by this name, or respond with this name during network discovery
  - **aaa new-model**: Authentication, Authorization, and Accounting (AAA); disabled, this device does not support AAA features, such as user accounts, user levels, or command-level logging as handled by the AAA feature

  ```
  ip cef
  no ipv6 cef
  ```
  - Enables Cisco Express Forwarding (CEF)

  - ```login on-success log```
    - Any successful login is logged to the console

  ```
  spanning-tree mode pvst
  spanning-tree extend system-id
  !
  vlan internal allocation policy ascending
  ```
  - These configurations are related to VLANs, which are covered later in this lesson:
    - **spanning-tree mode**: Determines the method used for Spanning Tree Protocol (STP)
    - **vlan internal allocation policy**: Specific VLANs reserved for internal use — determines where these VLANs begin enumerating (ascending starts at VLAN Identifier [ID] 1006 and up, descending at 4095 and below)

  ```
  interface GigabitEthernet1/3
  media-type rj45
  negotiation auto
  shutdown
  ```
  - Only one interface is covered here, as the others are nearly identical. 
    - **interface**: GigabitEthernet1/3 here indicates that this device is detected as a gigabit ethernet interface (as opposed to FastEthernet for 100 megabit ethernet) in slot zero, port zero; each internal slot may or may not contain multiple ports, depending on the interface card
    - **media-type**: RJ-45, Small Form-factor Pluggable (SFP), or Auto
    - **negotiation auto**: Attempts to automatically negotiate speed and duplex settings with the connected device.
    - **Shutdown**: Port is administratively disabled, ensuring that the port is not usable

  ```
  no ip http server
  no ip http secure-server
  ```
  - No web confg is enabled

- ```control-plane```
  - Control plane being enabled allows this device to have policies enabled that deal with Quality of Service (**QoS**), as well as mitigation of Denial of Service (**DoS**) and reconnaissance techniques

  ```
  line con 0
  line aux 0
  line vty 0 4
  ```
  - These configuration lines detail the settings used for connecting to the device:
    - **line con**: First — and typically only — serial console is enabled for this device; no configurations have been set beyond default settings
    - **line aux**: First — and typically only — AUX port is enabled for this device; no configurations have been set beyond default settings. Traditionally, the AUX port was often used for remote modem connections.
    - **line vty**: Five (0, 1, 2, 3, 4) virtual terminals (used for SSH or Telnet) are enabled. Unlike con and AUX ports, these are not physical.

### Packet Switching Logic
- Switches control which devices to forward frames to via algorithms known as Packet Switching
- Switches maintain an internal database of MAC addresses — **MAC address table or Content Addressable Memory (CAM) table** — that maps each known **MAC address** to a specific **port** on the switch, allowing the switch to determine the best port to forward onto.
- The switch analyzes the incoming frame, and then forwards it based upon the addressing type, such as:

<img width="802" height="435" alt="image" src="https://github.com/user-attachments/assets/61fdb359-f455-4d12-9c60-0b1af62b6be1" />

  - **Unicast**
    - **Single source** to **single destination**. If the MAC address is not in the switch’s MAC address table, then the forwarding of the frame is treated the same as broadcast. Otherwise, the frame is sent to the device if directly connected, or forwarded to the next switch closer to the destination device.

<img width="808" height="444" alt="image" src="https://github.com/user-attachments/assets/627bb4df-8923-4ab1-ae4f-1ff1bba29e66" />

  - **Broadcast**
    - **Single source** to **all devices on the LAN**. This floods the entire network, sending the frame to all other active ports — any receiving switch is also sent the frame to each connected device as well.
    - Any frames sent to FF:FF:FF:FF:FF:FF are broadcasted.

<img width="808" height="444" alt="image" src="https://github.com/user-attachments/assets/fd3528e8-8f16-4391-97ba-154bd6b7f85a" />

  - **Multicast**
    - **Single source** to **multiple devices**. Clients must subscribe to receive frames that are multicasted.
    - Switches learn which devices are subscribed using Internet Group Management Protocol **(IGMP) snooping** or via proprietary protocols or other means.
    - If the switch is **unable to learn** which devices are subscribed, **multicast frames** are treated as **broadcast frames**.
- **Note** that for **multicast and unicast** to not act like broadcast addressing, the switch needs to be able to maintain information about the network, such as subscriptions for multicast and MAC address tables for unicast.

### Port Configs and Virtual LANs
- Misconfigured switches can enable attackers to perform attacks such as **VLAN Hopping**

#### Link Aggregation
- Link Aggregation allows for multiple ports to be combined into a single, logical, port for **performance** and **stability** reasons
- It requires configuration on both the device and the switch the device is connected to.
- Link Aggregation can improve maximum bandwidth by allowing network traffic flow to travel among multiple ports with little configuration required for other devices on the network
- Configuration is typically either handled using **Link Aggregation Control Protocol (LACP)** or via **static configuration**.

#### Port Staus
- Unused ports should generally be disabled, which is accomplished via **shutdown** configuration when applied to an interface on Cisco devices.
- In addition, unused ports can be directed to a separate `quarantine VLAN`, which can be accomplished — on Cisco switches — with the `switchport mode access` command and assigned to the quarantine VLAN with the `switchport access VLAN <vlan-id>` command.

#### Port Security
- Also known as whitelisting, switch ports can have configurations applied to them that restrict traffic only to known sources.
- By restricting traffic to known MAC addresses, this feature can increase the security of the network as well as mitigate some types of attacks.

#### VLANs
- VLANs separate a physical network into logical network segments — each port assigned to a VLAN can communicate with each other as though they were all connected to a single logical switch while being isolated from any other VLANs from a Layer 2 perspective.
- VLANs are defined in the **IEEE 802.1Q** standard, which states that **32 bits are allocated in the ethernet packet header for the following fields**:
  - **Tag Protocol Identifier (TPID)**: 16-bit field set to 0x8100 to identify the 802.1Q packet
  - **Priority Code Point (PCP)**: 3-bit Class of Service (CoS) field; assigned to Layer 2 QoS between switches
  - **Drop Eligible Indicator (DEI)**: 1-bit field indicating whether the packet can be dropped when insufficient bandwidth is available on a link; when identified, indicates the potential use of Voice over IP (VoIP) traffic
  - **VLAN ID**: 12-bit field specifying the VLAN associated with a network packet
- VLANs can be used to segregate or isolate network segments, which can have many benefits such as enhancing performance by limiting the range of broadcasts or improving security by helping control access to sensitive machines or data. VLAN traversal happens via routing on Layer 3 — so-called Layer 3 switches are able to control and allow machines on different VLANs to communicate with each other in a manner managed by the switch.

#### Trunk Ports
- Managed switches connected to each other physically can designate those ports as trunk ports
- Trunk ports are able to carry traffic designated for VLANs on other connected switches
- Trunk ports can limit allowed VLANs through the trunk, which can be useful for physically segmenting VLAN IDs, or limiting the physical reach of specific VLANs.
- On Cisco switches, Dynamic Trunking Protocol (DTP) is a proprietary protocol that can be used to automatically negotiate trunk ports between connected switches.
- While convenient, if enabled for ports not intended to connect to other trunk ports, this can lead to insecure configurations if an attacker is able to spoof a switch in order to negotiate trunk ports.

#### Access Port
- **Access ports** are the foundational building blocks of managed switches; each access port can only be **assigned to one VLAN**.
- **Access ports** carry traffic from the configured VLAN to the device connected or to other devices on the same VLAN on that switch.
- **Packets received or transmitted** on access ports **do not carry 802.1Q tags**.
- By default, **switches assign all unconfigured ports to VLAN 1**.
- For Cisco switches, the ports can be manually configured as access ports with the `switchport mode access command` and assigned to a VLAN with the `switchport access VLAN <vlan-id>` command.

#### Private VLAN
<img width="602" height="402" alt="image" src="https://github.com/user-attachments/assets/6e8f76c5-f94b-4b43-9e09-2bec6eadc054" />

- Private VLANs further subdivide VLANs, allowing for isolation of devices within a VLAN from each other.
- When assigning a private VLAN to a port, in addition to the primary VLAN, a community VLAN ID is required.
- Three types of private VLAN ports exist:
  - **Promiscuous**: Typically reserved for routers or other gateway devices, these ports can receive traffic from any of the ports in a VLAN, regardless of the private VLAN configurations of those devices.
  - **Isolated**: Only able to communicate with promiscuous ports, these ports are isolated from all other ports. However, communication with the primary VLAN is possible.
  - **Community**: Able to communicate with promiscuous ports and other community ports on the same community VLAN. Additionally, community ports can communicate with the primary VLAN.
- Allows for isolation of devices without using up VLANs to do so.

#### Native VLANs
- The **802.1Q** standard states that any **traffic transmitted or received** on a **trunk port without an 802.1Q VLAN tag** is associated with the **native VLAN**.
- The default native VLAN for most switch vendors is VLAN 1.
- All switch control plane traffic is switched across the network using VLAN 1.
- Change this VLAN to a super high number (999)
- For a stable trunk to be established between switches, the native VLAN should match at both ends, or traffic can unintentionally change VLANs.
- For example, this configuration practice could mean that when a switch has a host connected to a trunk port with native VLAN 10, the host could communicate with hosts connected to access ports assigned to VLAN 10.
  - This occurrence is called VLAN Leaking and can be leveraged by threat actors to capture traffic across broadcast domains.
- Defining the native VLAN is a port-specific configuration and can be changed with the `switchport trunk native VLAN <vlan-id>` interface command.

#### Management VLANs
- As part of the network segmentation efforts to improve the security of a network, many network designs include a dedicated management VLAN — arbitrarily assigned amongst the available pool of VLANs.
- In switches, this is accomplished by assigning this VLAN to an internal interface.
- Special care is often taken or suggested with this VLAN, such as designing the connectivity of this VLAN to ensure that no connection loops exist.
- If a switch is misconfigured or misbehaving and STP is not able to resolve a loop, losing access to the management VLAN can greatly complicate recovery efforts.

#### Restricting VLANs
- VLANs can be restricted from trunk ports for security reasons or as a method of traffic engineering.
- The interface `switchport trunk allowed VLAN <vlan-ids>` command defines the VLANs that can traverse the link. 

### Practical Implications
- Some examples of attacks that rely on the behavior of switches or misconfigurations follow:
  - **MAC Flooding**: This attack relies on switches having a limited amount of memory for storing the MAC address table.
    - Due to the inability to store updates to this table, many switches failover to broadcast mode for all data frames — similar to network hubs.
    - This allows an attacker physically attached to a switch to view all traffic passing through the switch, rather than just traffic intended to be bound for that machine.
  - **MAC Spoofing**: This attack merely has the attacker present a different MAC address to the switch than the actual hardware MAC.
    - This can be done for various reasons, such as **bypassing MAC filters**, **masquerading** as a legitimate device, or **evading information gathering** by masquerading as a different device.
  - **VLAN Hopping**: This attack allows the attacker to view or transmit to or from VLANs that would normally not be permitted.
    - Since VLANs are often used for isolation, this may allow an attacker to view or communicate with sensitive machines.
  - **ARP Poisoning**: While technically a Layer 3 attack, mitigation is often the responsibility of switches on the network.
    - This attack allows an attacker to falsify ARP tables by sending forged packets, which causes clients to forward packets to the wrong MAC address for a specified IP address.
    - This can be used to Man-in-the-Middle (MitM) traffic bound for a specific host — including a gateway router — to observe traffic.

#### Mitigations
- A general overview of the mitigations for each of these follows:
  - **MAC Flooding/Spoofing**: Mitigations for these attacks depend on the network configuration.
    - If MAC addresses are known, each port can be configured with a **whitelist** of each address allowed on that port.
    - Alternately, authentication in some manner — such as **AAA** or **802.1x** — can be used to ensure that only approved devices are allowed to connect to ports or wireless for Wireless Fidelity (Wi-Fi) switches.
  - **VLAN Hopping**: VLAN hopping can be mitigated via appropriate port configurations.
    - Enforcing correct settings here involves ensuring that **client ports are set to access only**, **disabling trunk auto-negotiation** on client ports, and **ensuring that the native VLAN** for client ports is **set to an inaccessible VLAN**.
    - More details about these attacks and their mitigations are covered in the VLAN Attacks and Defenses lesson.
  - **ARP Poisoning**: ARP Poisoning attacks can be mitigated in several ways, depending on the network and its configuration.
    - Mitigating these attacks generally involves switch and/or router configuration.
    - Wi-Fi-based mitigation can be accomplished via:
      - **client isolation**: which prevents Wi-Fi clients from sending ARP packets to each other;
      - **wired-based mitigation** can involve **rate-limiting**, **manually binding important IP addresses to specific ports**, or **using vendor-specific, anti-spoofing technology** that validates ARP packets by validating against known hosts and blackholing unknown hosts that attempt to duplicate IP addresses.

### Layer 3 Forwarding
- A Layer 3 switch — also known as a **multilayer** switch — is any switch **capable of forwarding packets on Layer 3 as well as frames on Layer 2**
- These switches are able to route packets between discrete network segments, in a manner similar to routers
- They are distinguished from routers by their features — focusing on providing network connectivity with little overhead and often missing some of the more advanced Layer 3 features, such as Network Address Translation (NAT)
- Data starts at Layer 7 and works its way down to Layer 1; in this progression through the layers, some of the Layer 3 forwarding logic happens before Layer 2 forwarding.
- Switches typically have two methods for forwarding Layer 3 packets:
  - Forwarding traffic to hosts on the same subnet
  - Forwarding traffic to hosts on a different subnet

#### Local Network Forwarding
- Two hosts on the same IP subnet communicate locally. As the data of the transmitting host is encapsulated with its IP address, the device recognizes that the destination host is on the LAN segment
- However, the host still needs to encapsulate the Layer 2 information with its own MAC address and the MAC address of the destination to the packet
- It knows its own MAC address, but initially, it does not have the destination's MAC address
- This is where the ARP table is used to map Layer 3 IP addresses to Layer 2 MAC addresses and store the mapping.
- Next, the transmitting host uses the ARP table to add the appropriate Layer 2 headers with the destination's MAC address to the data packet before sending it down to Layer 2 for processing and forwarding.
- The ARP table is built over time and contains information on devices that the local host has recently communicated with on the same IP network segment

#### Packet Routing
- Packets must be routed when two hosts are on different networks. As the data is processed at Layer 3, it is encapsulated with its IP address; the host then detects that its destination is on a different IP subnet and must be routed.
- Next, the host checks its local routing table to find its next-hop IP address, which the host learned in one of several ways:
  - From a static route entry
  - A configured default-gateway
  - From routing protocols

<img width="1111" height="284" alt="image" src="https://github.com/user-attachments/assets/a2a4dc6a-6a16-4aad-b638-78676eb1a850" />

#### IP Address Assignment
- On Layer 3 switches (L3 switch) and routers, IPv4 addresses are assigned with the `ip address ip-address subnet-mask` interface command.
- When a switch interface is configured with an IP address and is online, the L3 switch adds the connected network into its routing table — also referred to as the **Routing Information Base (RIB)**.
- Directly-connected networks have an **Administrative Distance (AD) of 0**.

#### Switched Virtual Interfaces
- Cisco switches allow assigning IP addresses to a Switched Virtual Interface (**SVI**) — also referred to as a **VLAN interface**.
- An **SVI** is set up by configuring the VLAN on the switch and defining the VLAN interface with the interface `VLAN <vlan-id>` command.
- For the SVI to become operational (up-state), the switch must have an interface on that VLAN in an up-state.
- If the switch is a multilayer switch, multiple SVIs can be configured to route packets between VLANs, thus eliminating the need for an external router.
- Example Config:

  ```
  S1#configure terminal
  Enter configuration commands, one per line. End with CNTL/Z.
  S1(config)#interface Vlan 40
  S1(config-if)#ip address 172.16.22.1 255.255.255.0
  S1(config-if)#no shutdown
  S1(config-if)#interface vlan 45
  S1(config-if)#ip address 192.168.99.1 255.255.255.0
  S1(config-if)#no shutdown
  ```

#### Routed Switch Ports
- With the flexibility that multilayer switches provide in today's enterprise network environments, it is common for network architects to include point-to-point links between switches for routing
- Administrators can now convert Layer 2 switch ports to Layer 3 routed ports using the `no switchport` interface command on multilayer switches and assign an IP address to the interface, as seen in the example configuration below:

  ```
  S1#configure terminal
  Enter configuration commands, one per line. End with CNTL/Z.
  S11(config)#int gi1/0/14
  S1(config-if)#no switchport
  S1(config-if)#ip address 10.20.20.1 255.255.255.0
  S1(config-if)#ipv6 address 2001:db8:20::1/64
  S1(config-if)#no shutdown
  S1(config-if)#end
  S1
  ```

### MAC Address Tables
- The MAC address table — also known as a CAM table — on a switch contains information about which port each known MAC address is associated with.
- These tables often have a limited amount of memory and are typically refreshed often

#### Mapping Networks Using MAC Address Tables
- On Cisco-managed switches, the show mac address-table command can be used to view the MAC address table.
- Sample output is provided below:

<img width="383" height="185" alt="image" src="https://github.com/user-attachments/assets/ca7490c1-9dca-49d5-91f6-b8a9c47b4b12" />

- From here, a network map can be started.
- If a hardware list is available, MAC addresses can be compared to known addresses, otherwise, some assumptions might need to be made.
- Any assumptions made can be validated later with more commands or physical inspection of the hardware.

### Spanning Tree Protocol
- The STP allows switches to become aware of other switches on the network through the advertisement of Bridge Protocol Data Units (BPDU).
- STP builds a Layer 2, loop-free topology by temporarily blocking traffic on redundant ports.
- It operates by selecting a specific switch as the best switch and running a tree-based algorithm identifying which redundant ports should not transmit network traffic.
- STP has multiple versions:
  - **802.1D**: The original version
  - **PVST**: Per-VLAN Spanning Tree
  - **PVST**+: Per-VLAN Spanning Tree Plus
  - **RSTP**: 802.1W Rapid Spanning Tree Protocol
  - **MST**: 802.1S Multiple Spanning Tree Protocol
- Modern switches support PVST+, RSTP, and MST.
- All three versions are backward compatible with 802.1D as well.

#### IEEE 802.1D
- The original STP is from IEEE's 802.1D standards and supports ensuring a loop-free topology for one VLAN.
- Port States
  - In the 802.1D STP protocol, ports transition through the following states:
      1. Disabled: The port is in an administratively disabled configuration (shut down).
      2. Blocking: The state right after the switch port is enabled. The port does not forward any traffic, which ensures that no loop is created. The switch in this state does not modify the MAC address table, and it only receives BPDUs from other switches.
      3. Listening: The switch port has transitioned out of the blocking state and sends/receives BPDUs. At this point, it cannot transmit any other network traffic. The duration of the listening state correlates to the STP forwarding time.
      4. Learning:  While the switch port is in this state, the switch can modify the MAC address table with traffic that it receives. The switch port — up to this point — only forwards BPDUs. The duration of the learning state correlates to the STP forwarding time.
      5. Forwarding: The switch can update the MAC address table, and the switch port can forward all network traffic. During normal operations, the switch port stays in the forwarding state.
      6. Broken: The switch has detected a problem on a port that can have a significant impact. The port drops packets as long as the situation persists.
  - NOTE: Configured with the default timers, the entire 802.1D STP initialization from Blocking to Forwarding takes about 50 seconds.

- STP Types
  - The 802.1D STP standard defines three port types:
    - Root Port (**RP**): Each VLAN should only have one associated RP on a switch.
      - The **RP** is a switch port that connects directly to the root bridge or an upstream switch in the spanning-tree topology.
    - Designated Port (**DP**): There should be only one active designated port on a link.
      - A **DP** is a switch port that receives and forwards BPDU frames to other switches and connects to downstream devices and other switches.
    - **Blocking port**: A port that is not forwarding traffic because of STP calculations.

- STP Terminology
  - There are several key terms related to the STP:
    - **Root bridge**: Most critical switch in the Layer 2 topology. All **switch ports** are in a **forwarding state**. Therefore, the **Root Bridge** is considered the **top of the spanning tree** for all path calculations by other switches.
    - **BPDU**: A **BPDU default DMAC** is the **multicast address 01:80:c2:00:00:00**. They are used by switches to build and notify of changes in the STP topology.
      - Two types of BPDUs exist:
        - **Configuration BPDU**s: Used to identify the **root bridge**, **root ports**, **designated ports**, and **blocking ports**.
          - The **configuration BPDU** contains the following fields:
            - **root path cost**
              - Combined cost of a specific path to the root switch.
            - **root bridge identifier**
              - Combination of the **root bridge system MAC address**, **system ID extension**, and **system priority**.
              - Represented as system priority value added to the system ID extension value and resulting value concatenated with the root bridge system MAC address.
            - **local bridge identifier**
              - Combination of the **local switch's bridge system MAC address**, **system ID extension**, and **system priority**.
              - Represented as system priority value added to the system ID extension value and resulting value concatenated with the root bridge system MAC address.
            - **max-age**
              - With a default value of **20 seconds**, this is the time threshold before a bridge port saves its BPDU information.
              - If a switch loses contact with the switch that originated the BPDU, the BPDU is still valid until the Max-Age timer expires.
            - **hello time**
              - Interval in which a BPDU is transmitted out of a port. The Hello Time default value is two seconds, though the value can be configured anywhere between 1–10 seconds.
            - **forward delay**
              - Interval a port stays in the listening and learning states. The Forward delay default value is 15 seconds, though this value can be configured to a value between 4–30 seconds.
            - **STP type**.
        - **Topology Change Notification (TCN) BPDU**: Used to notify other switches of the Layer 2 topology changes.
    - **System priority**: A 4-bit value with a default value of 32,768. Determines the priority for a switch to be the root bridge.
    - **System ID extension**: A 12-bit value indicating the VLAN that a BPDU belongs to. The system priority and ID extension combine to form the switch's root bridge identification  

- STP Cost
  - The STP interface cost is a critical component for calculating the path to the root switch because the root path is found calculating the sum of the interface STP costs to reach the root bridge.
  - The STP interface cost was initially stored as a **16-bit value** with a reference value of **20 Gb/s**.
  - However, as switches have developed with higher-speed interfaces, **10 Gb/s** might not be enough.
  - Therefore, another method was developed, called **Long-Mode**, which uses a **32-bit value** with a reference speed of **20 Tb/s**. In current switching Operating Systems (OS), the **default mode** continues to be the **Short-Mode**.  

<img width="1954" height="1058" alt="image" src="https://github.com/user-attachments/assets/eabd5eeb-4191-433e-bec5-4f28cc098bb3" />

#### Building STP Topology

<img width="2414" height="1012" alt="image" src="https://github.com/user-attachments/assets/5d674836-63b1-4ff2-9db5-e154c877c7d8" />

- STP Root Bridge - Election
  - The first goal for STP is to identify the root bridge in the topology.
  - As a switch OS comes online, it assumes that it is the root bridge, and proceeds to use its local bridge ID as the root bridge ID.
  - Then it listens to its neighbors' configuration BPDUs by following these two steps:
    - If the neighbor's system Root Bridge Identifier is a higher value than its own, the switch ignores that BPDU and continues to see itself as the root bridge.
    - If the neighbor's system Root Bridge Identifier is a lower value than its own, the switch updates its own BPDUs to include the new root bridge ID and a new root path cost related to the total path cost to reach the new root bridge.
    - This process continues until all switches in the network have identified the root bridge switch.
  - STP considers a switch more preferable if the priority in the bridge ID is lower than the priority of the other switch's configuration BPDUs.
  - However, if the priority is the same, the switch prefers the BPDU with the lower system MAC.
  - Verify the show spanning-tree root output on SW2 and SW3. The Root ID field is the same as SW1, but the root path cost has changed to 4 because both switches use a 1 Gbps uplink to reach SW1.
  - In addition, interface Gi0/0 has been identified on both SW2 and SW3 as the root port.

    <img width="753" height="500" alt="image" src="https://github.com/user-attachments/assets/ea714541-b9f6-4837-a537-0f2e2061d1cb" />

- Locating Root Ports
  - The root bridge continues to transmit configuration BPDUs out of all its ports. The other switches compare the BPDU information to identify the RP.
  - The RP is selected following the below logic (where the next criteria are used to break a tie):
    1. The interface associated with the lowest path cost is the most preferred.
    2. The interface associated with the lowest system priority of the advertising switch is preferred next.
    3. The interface associated with the lowest system MAC address of the advertising switch is preferred next.
    4. When multiple links are associated with the same switch, the lowest port priority from the advertising switch is preferred.
    5. When multiple links are associated with the same switch, the lower port number from the advertising switch is preferred.

### Intro to Traffic Capture
- Terminal Access Point (TAP) devices as well as on-device traffic capture or redirection features (port mirroring) allow for full packet capture
- The full PCAP provided by such methods is received by a CPT Security Information and Event Management (SIEM) solution, in which a variety of force-multiplying tools, such as Zeek and Suricata, are employed for further analysis in threat hunts or mission partner security posture compliance

#### Network Taps
- A **TAP** — sometimes called a **Test Access Point** — is an **external device** inserted at a certain point in a network to conduct **monitoring** by **intercepting or mirroring**, and then **duplicating network traffic** to a **monitoring node** or **network** **without disrupting** the original **traffic**
- These devices permit TAPping a network, or multiple networks, to collect traffic for analysis through the tool stack.
- This can be accomplished in two ways — **in-band** and **out-of-band**. When deploying a kit to the mission network, **out-of-band** is the easiest way to set up a TAP with minimal changes and impact.
- In-Band TAP
  - Setting up in-band — or inline — ensures no traffic is lost when dealing with a switch/router that has a larger traffic throughput
  - The network TAP is placed in line with the communication chain of the network
  - The downside to implementing the TAP this way, however, is that the link between two devices needs to be disconnected in order for a TAP to be placed inline between them.
  - Some devices allow the TAP to be put in place as fail open so there is no network interruption in case of a power loss or hardware failure.

<img width="520" height="449" alt="image" src="https://github.com/user-attachments/assets/57982916-8900-4ec9-97be-81713d9581bb" />

- Out-of-band TAP
  - Operating out-of-band, the TAP/stack operates on its own network, receiving the mission network's traffic via one or more Switched Port Analyzer (**SPAN**) ports from devices on the network.
  - A downside to running out-of-band, however, is that SPAN ports can become **overwhelmed** in some circumstances.
  - For instance, if traffic flow exceeds the capacity of the SPAN port or if the SPAN port is misconfigured.
  - There is a chance some packets are not collected if the device cannot handle the throughput for traffic collection.

#### Network TAPs vs. Port Mirroring
- It is worth considering that an ethernet TAP is not always the correct traffic capture solution.
  - The ideal method is to use a physical network TAP given enough available access and resources. This guarantees that no packets are modified prior to collection.
  - The other method is to mirror the collected interface to a network SPAN port, which directs all mirrored traffic to a collection platform.
  - Compared to the SPAN port mirroring option, a physical TAP places no additional load on a switch, as the traffic does not need to be duplicated by the switch to the SPAN port, nor does it risk the switch dropping or delaying packets due to utilization, malformation, or buffering.
  - The physical TAP also provides complete visibility into full-duplex networks, being able to read both sending and receiving data streams simultaneously.
  - The disadvantage is the potential purchase and additional installation of costly new equipment where such TAPs do not already exist.
  - For these reasons, a physical TAP is ideal in a high-traffic network environment where dropping packets is not acceptable, and the cost-to-benefit of the equipment is advisable.
- In a low-traffic network where a few dropped packets are permissible, the option to mirror a port to the monitoring device is much more cost-effective.
  - It uses already-existing capabilities in the network architecture and also captures intra-switch traffic, which a physical network TAP cannot do if placed on the network side of the switch.

#### Port Mirroring - SPAN
- Enterprise-level-managed switches can support various forms of port mirroring to enable capturing traffic from a Layer 2 perspective by replicating all frames sent or received by specific ports to another port.
- A sensor or traffic capture workstation can be placed on the port mirror to capture a copy of all frames.
- Port mirroring is useful for traffic capturing and continuous monitoring.
- There are three primary ways to mirror switch ports:
  - SPAN
    - Mirrors traffic from one or more interfaces or VLANs to another port on the same switch.
  - Remote SPAN (RSPAN)
    - Allows mirroring of traffic over Layer 2 links — meaning that the port that replicates all frames need not be on the same device as the ports being monitored.
    - The replicated data traverses a VLAN dedicated for this session, traversing any trunk ports necessary to reach the destination port that mirrors all duplicated frames.
    - This type of mirror can enable an organization to centralize packet traffic and monitoring.
  - Encapsulated Remote SPAN (ERSPAN)
    - Similar to RSPAN, but the traffic being sent to the remote device is encapsulated in Generic Routing Encapsulation (GRE) packets.
    - This enables port mirroring over Layer 3 networks, such as mirroring ports from a mission network onto kit hardware.

### Strategic TAP Placement | TAP Locations
- Determining TAP placement in the network depends on the information required to complete the objectives of the engagement.

#### Placement Considerations
- What traffic is necessary to collect?
  - If the TAP is incorrectly located, vital mission data may be omitted or unnecessary data may be collected.
  - For example, when conducting a hunt for a suspected compromise that has already penetrated external defenses, all network traffic in the internal network — behind the internal firewall — is to be collected. Placement on the External Router would be insufficient in that case.
- Does one place a TAP on the router or the switches?
  - Tapping the Internal Router, the client-to-client communications or potential lateral movement from one workstation to another would be omitted.
  - To effectively collect all the internal network traffic in this scenario, place TAPs or sensors in multiple locations.
- Is seeing what is going to the Demilitarized Zone (DMZ) or External Router important?
  - That depends on the amount of traffic flowing to the DMZ.
  - If seeing the traffic to the DMZ helps accomplish mission objectives, then it is a good idea to TAP at that location.
  - However, make sure the necessary configuration requirements and filters are in place.
- There are many elements to take into consideration when placing a TAP.
  - If placing a TAP on the External Firewall before traffic is filtered by the device, one runs the risk of collecting more information than the sensor can process.
  - Different routers and switches have their own hardware limitations that should be taken into consideration when placing a TAP.

#### Trust Boundaries
- Sensors for full PCAP should be placed at **trust boundaries**, which are _connections between trusted and untrusted networks_.
- For example, if a firewall separates a trusted intranet and the untrusted internet, then the full PCAP sensor should be mirroring or tapping that device on the internal side.
- This allows monitoring of all communication that the firewall allows from the untrusted network and all information that trusted agents inside the intranet are sending out to the untrusted network.

#### Network Address Translation (NAT)
- The other consideration in TAP or sensor placement is that if the environment employs NAT, the collection should occur on the **trusted side of translation**.
- In the scenario in which a trusted system is compromised, if only the external translated address is available for analysis, then the specific system is unknown.
- However, by collecting on the trusted side, the internal address appears in captures and allows precise analysis of compromise and any lateral movement within the network.











